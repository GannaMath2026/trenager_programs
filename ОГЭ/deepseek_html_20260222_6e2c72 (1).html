<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ì–≠ –¢—Ä–µ–Ω–∞–∂—ë—Ä</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #eef2f6;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            max-width: 1200px;
            width: 100%;
        }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header-panel {
            background: linear-gradient(145deg, #ffffff, #f5f9ff);
            border-radius: 40px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,30,60,0.1);
            border: 1px solid #d9e6f2;
        }
        .mode-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .mode-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mode-badge {
            background: #e9f0fa;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            color: #1d3e63;
            border: 1px solid #b8cde0;
        }
        .mode-badge.teacher {
            background: #8e6baf;
            color: white;
            border-color: #6b4f8a;
        }
        .mode-badge.study {
            background: #5f7fa0;
            color: white;
        }
        .mode-badge.control {
            background: #9e6d6d;
            color: white;
        }
        .logout-btn {
            background: #2c3e50;
            border: none;
            border-radius: 40px;
            padding: 8px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .file-actions button {
            background: #f0f4fa;
            border: 1px solid #a5bad4;
            border-radius: 40px;
            padding: 10px 16px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        #resultBtn {
            background: #8e6baf;
            color: white;
            border-color: #6b4f8a;
        }
        .stats {
            display: flex;
            gap: 25px;
            background: #2c3e50;
            color: white;
            padding: 12px 35px;
            border-radius: 60px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.2);
        }
        .stats span {
            font-size: 1.15rem;
        }
        .stats .correct { color: #a3e0b0; font-weight: 700; }
        .stats .incorrect { color: #f9b5b5; font-weight: 700; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        .auth-modal-content {
            background: white;
            max-width: 400px;
            margin: 200px auto;
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        .auth-modal-content h3 {
            color: #1d3e63;
            margin-bottom: 20px;
        }
        .auth-modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        .auth-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-btn-teacher {
            background: #8e6baf;
            color: white;
        }
        .auth-btn-study {
            background: #5f7fa0;
            color: white;
        }
        .auth-btn-control {
            background: #9e6d6d;
            color: white;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ–º–∞–º */
        .nav-section {
            background: white;
            border-radius: 40px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px 25px;
            border: 1px solid #d0e1f0;
        }
        .topic-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .topic-btn {
            background: #e1ecf9;
            border: none;
            border-radius: 40px;
            padding: 10px 22px;
            font-weight: 600;
            color: #1a3f5c;
            cursor: pointer;
            transition: 0.1s;
            border: 1px solid #b3cbe3;
        }
        .topic-btn.active {
            background: #2b6c9e;
            color: white;
            border-color: #1b4c72;
        }
        
        /* –°–µ—Ç–∫–∞ –∑–∞–¥–∞—á */
        .task-grid {
            background: white;
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            border: 1px solid #c9ddec;
        }
        .task-square {
            aspect-ratio: 1/1;
            background: #e7f0fa;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f3b58;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .task-square.correct {
            background: #c8f0d1;
            border-color: #2e8b57;
            color: #1d5438;
        }
        .task-square.incorrect {
            background: #fad1d1;
            border-color: #b34a4a;
            color: #632626;
        }
        .task-square.active {
            border: 4px solid #f5b342;
            transform: scale(1.02);
        }
        .task-square.condition {
            background: #2b6c9e;
            color: white;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —É—Å–ª–æ–≤–∏—è (–∑–∞–¥–∞–Ω–∏–µ 0) */
        .condition-card {
            background: white;
            border-radius: 40px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0,40,70,0.1);
            border: 1px solid #d0e1f0;
            margin-bottom: 20px;
        }
        .condition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .condition-title {
            background: #2b6c9e;
            color: white;
            padding: 10px 30px;
            border-radius: 60px;
            font-weight: 700;
        }
        /* –ë–ª–æ–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ä–∞–∑–±–æ—Ä—ã */
        .condition-links {
            margin: 15px 0;
            padding: 10px 15px;
            background: #f0f7ff;
            border-radius: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .condition-links a {
            text-decoration: none;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 40px;
            background: #e9f0fa;
            color: #1d3e63;
            border: 1px solid #b8cde0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .condition-links a:hover {
            background: #d1e2fc;
        }
        .condition-links input {
            padding: 8px 16px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            font-size: 0.9rem;
            width: 250px;
        }
        .condition-links label {
            font-weight: 600;
            color: #1d3e63;
        }
        .condition-image-zone {
            border: 2px dashed #b2cbe4;
            border-radius: 30px;
            background: #fafdff;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin: 20px 0;
            flex-direction: column;
        }
        .condition-image-zone img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .condition-text {
            background: #f7faff;
            border-radius: 28px;
            padding: 20px;
            line-height: 1.6;
            border: 1px solid #c2d6ec;
            white-space: pre-wrap;
        }
        .condition-text.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .condition-text textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ */
        .task-card {
            background: white;
            border-radius: 40px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0,40,70,0.1);
            border: 1px solid #d0e1f0;
            margin-bottom: 20px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .task-title {
            background: #e1ecf9;
            padding: 10px 30px;
            border-radius: 60px;
            font-weight: 700;
            color: #1d4e7a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .topic-badge {
            background: #2b6c9e;
            color: white;
            padding: 5px 15px;
            border-radius: 40px;
            font-size: 0.9rem;
        }
        .task-nav {
            display: flex;
            gap: 10px;
        }
        .task-nav button {
            background: #cbdbea;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f3f60;
            cursor: pointer;
        }
        .task-image-zone {
            border: 2px dashed #b2cbe4;
            border-radius: 30px;
            background: #fafdff;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin: 20px 0;
            flex-direction: column;
        }
        .task-image-zone img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .task-desc {
            background: #f7faff;
            border-radius: 28px;
            padding: 20px;
            line-height: 1.6;
            border: 1px solid #c2d6ec;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        .task-desc.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .task-desc textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        /* –ü–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è */
        .teacher-only {
            display: none;
        }
        .teacher-mode .teacher-only {
            display: block;
        }
        
        .correct-answer {
            background: #e8f0fe;
            border-radius: 24px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #b0c6dd;
        }
        .correct-answer input {
            width: 200px;
            padding: 10px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            font-size: 1rem;
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        .hint-text {
            background: #fff4db;
            border-left: 6px solid #f5b342;
            border-radius: 24px;
            padding: 18px;
            margin: 15px 0;
            line-height: 1.6;
        }
        .hint-text.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .hint-text textarea {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        .calc-area {
            background: #eef4fc;
            border-radius: 30px;
            padding: 18px;
            margin: 15px 0;
            border: 1px solid #bdcfe3;
        }
        .calc-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .calc-input {
            flex: 2;
            border: 1px solid #b2c7e0;
            border-radius: 60px;
            padding: 12px 22px;
            font-size: 1rem;
        }
        .calc-eval-btn {
            background: #497aa8;
            border: none;
            border-radius: 60px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .calc-result {
            background: white;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            border: 1px solid #acc4e0;
            min-width: 90px;
            text-align: center;
        }
        .input-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .input-area input {
            border: 2px solid #b6cde0;
            border-radius: 60px;
            padding: 12px 25px;
            font-size: 1rem;
            width: 220px;
        }
        .input-area button {
            background: #2b6c9e;
            border: none;
            border-radius: 60px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .result-badge {
            background: #f0f6ff;
            border-radius: 60px;
            padding: 12px 25px;
            font-weight: 600;
            border: 2px solid #acc4e0;
            min-width: 140px;
            text-align: center;
        }
        .hint-wrapper {
            margin-top: 15px;
        }
        .hint-button {
            background: #efe7d3;
            border: 1px solid #c5ac77;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            color: #5e4e2b;
            cursor: pointer;
            display: inline-block;
        }
        .hidden { display: none; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            max-width: 90%;
            max-height: 90vh;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
        }
        .modal-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 20px;
        }
        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ */
        .input-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        .input-modal-content {
            background: white;
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 30px;
        }
        .input-modal-content h3 {
            color: #1d3e63;
            margin-bottom: 20px;
        }
        .input-modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .primary {
            background: #8e6baf;
            color: white;
        }
        .secondary {
            background: #e0e0e0;
        }
    
    .mode-switcher{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    .mode-switch-btn{padding:7px 14px;border-radius:30px;border:1px solid #c0cce0;background:#f0f4fc;color:#1e3a6b;font-size:13px;font-weight:600;cursor:pointer;transition:.15s;}
    .mode-switch-btn:hover{background:#dce7ff;}
    .mode-switch-btn.active-mode{background:#1e3c72;color:white;border-color:#1e3c72;}
    /* –°–±—Ä–æ—Å white-space –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
    #conditionText,#currentTaskDesc{white-space:normal!important;line-height:normal!important;}
    /* –ë–ª–æ—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä */
    .block-editor{display:flex;flex-direction:column;gap:4px;}
    .block-editor *{box-sizing:border-box;white-space:normal;line-height:normal;}
    .editor-block{border:1px solid #dde5f5;border-radius:14px;padding:12px;background:#fafcff;}
    .editor-block:hover{border-color:#7f9fd9;}
    .eb-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .eb-icon{font-size:15px;}
    .eb-label{font-size:11px;font-weight:700;color:#7f9fd9;text-transform:uppercase;letter-spacing:.5px;flex:1;}
    .eb-actions{display:flex;gap:2px;}
    .eb-actions button{background:none;border:none;cursor:pointer;font-size:14px;padding:2px 5px;border-radius:6px;color:#7f9fd9;}
    .eb-actions button:hover{background:#eef3fc;color:#1e3c72;}
    .eb-actions .del:hover{background:#ffebee;color:#c62828;}
    .eb-textarea{width:100%;border:1px solid #dde5f5;border-radius:10px;padding:9px;font-size:14px;font-family:inherit;resize:vertical;min-height:65px;outline:none;white-space:pre-wrap;line-height:1.6;}
    .eb-textarea:focus{border-color:#3a7bd5;}
    .eb-tbl-ctrl{display:flex;gap:6px;margin-bottom:7px;flex-wrap:wrap;}
    .eb-tbl-ctrl button{padding:4px 11px;border-radius:20px;border:none;background:#e8f0fe;color:#1e3c72;font-size:12px;font-weight:600;cursor:pointer;}
    .eb-tbl-ctrl button:hover{background:#c8d6ee;}
    .eb-tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid #c8d6ee;}
    .eb-tbl-wrap table{border-collapse:collapse;width:100%;display:table;}
    .eb-tbl-wrap tr{display:table-row;}
    .eb-tbl-wrap th{background:#e8f0fe;border:1px solid #c8d6ee;padding:0;display:table-cell;}
    .eb-tbl-wrap td{border:1px solid #dde5f5;padding:0;display:table-cell;}
    .eb-tbl-wrap th input,.eb-tbl-wrap td input{width:100%;border:none;padding:6px 8px;font-size:13px;font-family:inherit;background:transparent;outline:none;min-width:55px;}
    .eb-tbl-wrap th input{font-weight:700;color:#1e3c72;}
    .eb-img-zone{border:2px dashed #a0b8e0;border-radius:10px;padding:16px;text-align:center;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;min-height:70px;}
    .eb-img-zone:hover{background:#e3edff;border-color:#3a7bd5;}
    .eb-img-zone img{max-width:100%;max-height:150px;border-radius:8px;}
    .eb-img-zone .ph{color:#7f9fd9;font-size:13px;}
    .eb-img-zone .lbl{font-size:11px;color:#6b7f9a;}
    .eb-add-bar{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
    .eb-add-btn{padding:6px 13px;border-radius:20px;border:1.5px dashed #7f9fd9;background:#f0f6ff;color:#1e3c72;font-size:12px;font-weight:600;cursor:pointer;}
    .eb-add-btn:hover{background:#dce9ff;}
    .eb-divider{display:flex;align-items:center;margin:3px 0;height:22px;}
    .eb-div-line{flex:1;height:2px;background:#dde5f5;border-radius:1px;}
    .eb-div-btn{padding:2px 10px;border-radius:20px;border:1px solid #c8d6ee;background:white;color:#7f9fd9;font-size:11px;font-weight:700;cursor:pointer;opacity:0;white-space:nowrap;}
    .eb-divider:hover .eb-div-btn{opacity:1;}
    .eb-divider:hover .eb-div-line{background:#a0b8e0;}
    .eb-div-btn:hover{background:#e8f0fe;color:#1e3c72;}
    .eb-insert-menu{display:flex;align-items:center;gap:7px;margin:4px 0;background:#e8f0fe;border-radius:10px;padding:7px 10px;flex-wrap:wrap;}
    .eb-insert-menu span{font-size:11px;color:#4a5f7a;font-weight:700;}
    .eb-insert-menu .ins-btn{padding:4px 10px;border-radius:20px;border:1.5px dashed #7f9fd9;background:#f0f6ff;color:#1e3c72;font-size:11px;font-weight:600;cursor:pointer;}
    .eb-insert-menu .ins-btn:hover{background:#dce9ff;}
    .eb-insert-menu .cancel{border:none;background:#c8d6ee;color:#4a5f7a;border-radius:20px;padding:4px 9px;font-size:11px;cursor:pointer;}
    /* –†–µ–Ω–¥–µ—Ä –±–ª–æ–∫–æ–≤ */
    .blocks-render p{margin:0 0 10px 0;white-space:pre-wrap;font-size:14px;line-height:1.7;}
    .blocks-render table{border-collapse:collapse;width:100%;margin:10px 0;display:table;}
    .blocks-render tr{display:table-row;}
    .blocks-render th{background:#1e3c72;color:white;padding:7px 11px;font-size:13px;text-align:left;display:table-cell;}
    .blocks-render td{border:1px solid #c8d6ee;padding:6px 11px;font-size:13px;display:table-cell;}
    .blocks-render tr:nth-child(even) td{background:#f5f8ff;}
    .blocks-render img{max-width:100%;border-radius:10px;margin:6px 0;display:block;cursor:zoom-in;}
    #imageModal .modal-content img{max-width:min(90vw,1200px);max-height:90vh;border-radius:12px;display:block;}
</style>
</head>
<body>
<div class="app-container" id="appContainer">

    <!-- –®–ê–ü–ö–ê -->
    <div class="header-panel">
        <div class="mode-row">
            <div class="mode-info">
                <div class="mode-switcher" id="modeSwitcher">
                    <button class="mode-switch-btn" id="switchControl">üîí –ö–æ–Ω—Ç—Ä–æ–ª—å</button>
                    <button class="mode-switch-btn" id="switchStudy">üë®‚Äçüéì –û–±—É—á–µ–Ω–∏–µ</button>
                    <button class="mode-switch-btn" id="switchTeacher">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                </div>
            </div>
            <div class="file-actions">
                <label for="importFile" id="importBtn" style="cursor:pointer;">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</label>
                <button id="exportBtn" class="teacher-only">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="resultBtn" class="study-only">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <input type="file" id="importFile" accept=".json" hidden>
            </div>
            <div class="stats" id="statsDisplay">
                <span>‚úÖ <span id="correctCount">0</span>/<span id="totalCorrect">0</span></span>
                <span>‚ùå <span id="incorrectCount">0</span>/<span id="totalIncorrect">0</span></span>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <h3>üîê –í—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º</h3>
            <input type="password" id="authPass" placeholder="–ø–∞—Ä–æ–ª—å" maxlength="4">
            <div class="auth-buttons">
                <button class="auth-btn-teacher" id="authTeacher">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å</button>
                <button class="auth-btn-study" id="authStudy">üë®‚Äçüéì –ò–∑—É—á–µ–Ω–∏–µ</button>
                <button class="auth-btn-control" id="authControl">üîí –ö–æ–Ω—Ç—Ä–æ–ª—å</button>
            </div>
        </div>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –¢–ï–ú–ê–ú -->
    <div class="nav-section">
        <div class="topic-buttons" id="topicContainer"></div>
    </div>

    <!-- –°–ï–¢–ö–ê –ó–ê–î–ê–ß (–≤–∫–ª—é—á–∞—è –∑–∞–¥–∞–Ω–∏–µ 0 - —É—Å–ª–æ–≤–∏–µ) -->
    <div class="task-grid" id="taskGrid"></div>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –£–°–õ–û–í–ò–Ø (–∑–∞–¥–∞–Ω–∏–µ 0) -->
    <div class="condition-card" id="conditionCard">
        <div class="condition-header">
            <span class="condition-title" id="conditionTitle">–£—Å–ª–æ–≤–∏–µ</span>
        </div>

        <!-- –ë–ª–æ–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ä–∞–∑–±–æ—Ä—ã (–≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
        <div class="condition-links teacher-only" id="conditionLinksEdit">
            <label>üì∫ –í–∏–¥–µ–æ:</label>
            <input type="url" id="videoUrlInput" placeholder="https://...">
            <label>üìÑ –°—Ç–∞—Ç—å—è:</label>
            <input type="url" id="articleUrlInput" placeholder="https://...">
        </div>
        <div class="condition-links" id="conditionLinksView">
            <a href="#" target="_blank" id="videoLink" style="display: none;">üì∫ –í–∏–¥–µ–æ—Ä–∞–∑–±–æ—Ä</a>
            <a href="#" target="_blank" id="articleLink" style="display: none;">üìÑ –†–∞–∑–±–æ—Ä –Ω–∞ —Å–∞–π—Ç–µ</a>
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è -->
        <div class="condition-image-zone" id="conditionImageZone">
            <span class="image-placeholder">üìé –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è</span>
            <img id="conditionImagePreview" style="display: none;">
            <input type="file" id="conditionFileInput" accept="image/*" hidden>
        </div>

        <!-- –¢–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è -->
        <div class="condition-text" id="conditionText"></div>
    </div>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –ó–ê–î–ê–ß–ò -->
    <div class="task-card" id="taskCard">
        <div class="task-header">
            <div class="task-title">
                <span id="currentTaskTitle">–ó–∞–¥–∞–Ω–∏–µ</span>
                <span class="topic-badge" id="currentTopicBadge"></span>
            </div>
            <div class="task-nav">
                <button id="prevTaskBtn">‚Üê</button>
                <button id="nextTaskBtn">‚Üí</button>
            </div>
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
        <div class="task-image-zone" id="currentImageZone">
            <span class="image-placeholder">üìé –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</span>
            <img id="currentImagePreview" style="display: none;">
            <input type="file" id="currentFileInput" accept="image/*" hidden>
        </div>

        <!-- –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ -->
        <div class="task-desc" id="currentTaskDesc"></div>

        <!-- –ü–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
        <div class="teacher-only">
            <div class="correct-answer">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                <input type="text" id="correctAnswerInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 76108">
            </div>
            <div class="hint-text">
                <textarea id="hintTextArea" placeholder="–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏..."></textarea>
            </div>
        </div>

        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
        <div class="calc-area">
            <div style="margin-bottom:8px; font-weight:600;">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
            <div class="calc-row">
                <input type="text" class="calc-input" id="currentCalcInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 3*90/0.5">
                <button class="calc-eval-btn" id="currentCalcBtn">–í—ã—á–∏—Å–ª–∏—Ç—å</button>
                <span class="calc-result" id="currentCalcResult">0</span>
            </div>
        </div>

        <!-- –í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ -->
        <div class="input-area">
            <input type="text" id="currentAnswerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç">
            <button id="currentCheckBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <span class="result-badge" id="currentResultBadge">‚ö™ –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ –∏–∑—É—á–µ–Ω–∏—è) -->
        <div class="hint-wrapper" id="hintWrapper">
            <span class="hint-button" id="hintToggleBtn">üìñ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</span>
            <div class="hint-text hidden" id="hintDisplay"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
    <div id="reportModal" class="input-modal">
        <div class="input-modal-content">
            <h3>üìã –û—Ç—á–µ—Ç</h3>
            <input type="text" id="studentName" placeholder="–§–∞–º–∏–ª–∏—è –∏ –∏–º—è —É—á–µ–Ω–∏–∫–∞">
            <input type="text" id="studentClass" placeholder="–ö–ª–∞—Å—Å">
            <div class="modal-buttons">
                <button class="primary" id="generateReport">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="secondary" id="cancelReport">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeImageModal">&times;</span>
            <img id="modalImage">
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ë–õ–û–ß–ù–´–ô –†–ï–î–ê–ö–¢–û–†
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var E = (function(){
    var _b=[], _tid=null, _kid=0, _m=-1, _getD;
    function init(fn){ _getD=fn; }

    function load(tid, kid){
        _tid=tid; _kid=kid; _m=-1;
        var td=_getD();
        // –§–ò–ö–°: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ ‚Äî tasks[kid] –º–æ–∂–µ—Ç –±—ã—Ç—å undefined
        var taskObj = null;
        if(kid===0){
            taskObj = td[tid] && td[tid].condition ? td[tid].condition : null;
        } else {
            taskObj = td[tid] && td[tid].tasks && td[tid].tasks[kid] ? td[tid].tasks[kid] : null;
        }
        _b = taskObj && taskObj.blocks ? JSON.parse(JSON.stringify(taskObj.blocks)) : [];
        _render();
    }

    function save(){
        if(!_tid) return;
        var td=_getD(), bl=JSON.parse(JSON.stringify(_b));
        if(_kid===0){
            if(!td[_tid].condition) td[_tid].condition={};
            td[_tid].condition.blocks=bl;
        } else {
            if(!td[_tid].tasks) td[_tid].tasks={};
            if(!td[_tid].tasks[_kid]) td[_tid].tasks[_kid]={blocks:[],correct:'',hint:''};
            td[_tid].tasks[_kid].blocks=bl;
        }
    }

    function setText(i,v)       { _b[i].content=v; save(); }
    function setHeader(i,hi,v)  { _b[i].headers[hi]=v; save(); }
    function setCell(i,ri,ci,v) { _b[i].rows[ri][ci]=v; save(); }
    function addEnd(t)          { _ins(t,_b.length); }
    function insertAt(t,p)      { _ins(t,p); }
    function _ins(type,pos){
        var b;
        if(type==='text')       b={type:'text',content:''};
        else if(type==='table') b={type:'table',headers:['–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1','–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2','–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3'],rows:[['','','']]};
        else                    b={type:'image',content:''};
        _b.splice(pos,0,b); _m=-1; save(); _render();
    }
    function remove(i){ _b.splice(i,1); _m=-1; save(); _render(); }
    function move(i,d){ var j=i+d; if(j<0||j>=_b.length)return; var t=_b[i];_b[i]=_b[j];_b[j]=t; save(); _render(); }
    function menu(p)  { _m=(_m===p)?-1:p; _render(); }
    function tblAddRow(i){ _b[i].rows.push(Array(_b[i].headers.length).fill('')); save(); _render(); }
    function tblRemRow(i){ if(_b[i].rows.length>1){_b[i].rows.pop(); save(); _render();} }
    function tblAddCol(i){ _b[i].headers.push('–ó–∞–≥–æ–ª–æ–≤–æ–∫'); _b[i].rows.forEach(function(r){r.push('');}); save(); _render(); }
    function tblRemCol(i){ if(_b[i].headers.length>1){_b[i].headers.pop(); _b[i].rows.forEach(function(r){r.pop();}); save(); _render();} }
    function imgClick(i){ var f=document.getElementById('_ef'+i); if(f) f.click(); }
    function imgLoad(file,i){ var r=new FileReader(); r.onload=function(e){_b[i].content=e.target.result; save(); _render();}; r.readAsDataURL(file); }
    function imgChange(e,i){ if(e.target.files[0]) imgLoad(e.target.files[0],i); }
    function imgDrop(e,i){ e.preventDefault(); if(e.dataTransfer.files[0]) imgLoad(e.dataTransfer.files[0],i); }
    document.addEventListener('paste',function(e){
        if(!document.getElementById('_ebc')) return;
        var items=(e.clipboardData||e.originalEvent.clipboardData).items;
        for(var k=0;k<items.length;k++){
            if(items[k].type.indexOf('image')===0){
                var t=-1; _b.forEach(function(b,bi){if(b.type==='image')t=bi;});
                if(t!==-1){imgLoad(items[k].getAsFile(),t); e.preventDefault();}
                return;
            }
        }
    });

    function _e(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function _render(){
        var c=document.getElementById('_ebc'); if(!c) return;
        var h='';
        for(var i=0;i<=_b.length;i++){
            if(_m===i){
                h+='<div class="eb-insert-menu"><span>–í—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞:</span>'
                 +'<button class="ins-btn" onclick="E.insertAt(\'text\','+i+')">üìù –¢–µ–∫—Å—Ç</button>'
                 +'<button class="ins-btn" onclick="E.insertAt(\'table\','+i+')">üìä –¢–∞–±–ª–∏—Ü–∞</button>'
                 +'<button class="ins-btn" onclick="E.insertAt(\'image\','+i+')">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>'
                 +'<button class="cancel" onclick="E.menu('+i+')">‚úï</button></div>';
            } else if(i<_b.length){
                h+='<div class="eb-divider"><div class="eb-div-line"></div>'
                 +'<button class="eb-div-btn" onclick="E.menu('+i+')">Ôºã –≤—Å—Ç–∞–≤–∏—Ç—å</button>'
                 +'<div class="eb-div-line"></div></div>';
            }
            if(i===_b.length) break;
            var b=_b[i];
            var icons={text:'üìù',table:'üìä',image:'üñºÔ∏è'};
            var labels={text:'–¢–µ–∫—Å—Ç',table:'–¢–∞–±–ª–∏—Ü–∞',image:'–ö–∞—Ä—Ç–∏–Ω–∫–∞'};
            h+='<div class="editor-block"><div class="eb-header">'
             +'<span class="eb-icon">'+icons[b.type]+'</span>'
             +'<span class="eb-label">'+labels[b.type]+'</span>'
             +'<div class="eb-actions">'
             +'<button onclick="E.move('+i+',-1)">‚Üë</button>'
             +'<button onclick="E.move('+i+',1)">‚Üì</button>'
             +'<button class="del" onclick="E.remove('+i+')">‚úï</button>'
             +'</div></div>';
            if(b.type==='text'){
                h+='<textarea class="eb-textarea" oninput="E.setText('+i+',this.value)" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">'+_e(b.content)+'</textarea>';
            } else if(b.type==='table'){
                h+='<div class="eb-tbl-ctrl">'
                 +'<button onclick="E.tblAddRow('+i+')">+ —Å—Ç—Ä–æ–∫–∞</button>'
                 +'<button onclick="E.tblRemRow('+i+')">‚àí —Å—Ç—Ä–æ–∫–∞</button>'
                 +'<button onclick="E.tblAddCol('+i+')">+ —Å—Ç–æ–ª–±–µ—Ü</button>'
                 +'<button onclick="E.tblRemCol('+i+')">‚àí —Å—Ç–æ–ª–±–µ—Ü</button>'
                 +'</div><div class="eb-tbl-wrap"><table><tr>';
                b.headers.forEach(function(hv,hi){
                    h+='<th><input type="text" value="'+_e(hv)+'" oninput="E.setHeader('+i+','+hi+',this.value)" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"></th>';
                });
                h+='</tr>';
                b.rows.forEach(function(row,ri){
                    h+='<tr>';
                    row.forEach(function(cell,ci){
                        h+='<td><input type="text" value="'+_e(cell)+'" oninput="E.setCell('+i+','+ri+','+ci+',this.value)" placeholder="‚Äî"></td>';
                    });
                    h+='</tr>';
                });
                h+='</table></div>';
            } else if(b.type==='image'){
                h+='<div class="eb-img-zone" onclick="E.imgClick('+i+')" ondragover="event.preventDefault()" ondrop="E.imgDrop(event,'+i+')">';
                if(b.content) h+='<img src="'+b.content+'"><span class="lbl">–ö–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å / Ctrl+V</span>';
                else          h+='<span class="ph">üñºÔ∏è –ö–ª–∏–∫–Ω–∏, –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ Ctrl+V</span><span class="lbl">PNG, JPG, GIF</span>';
                h+='</div><input type="file" id="_ef'+i+'" accept="image/*" style="display:none" onchange="E.imgChange(event,'+i+')">';
            }
            h+='</div>';
        }
        h+='<div class="eb-add-bar">'
         +'<button class="eb-add-btn" onclick="E.addEnd(\'text\')">üìù –¢–µ–∫—Å—Ç</button>'
         +'<button class="eb-add-btn" onclick="E.addEnd(\'table\')">üìä –¢–∞–±–ª–∏—Ü–∞</button>'
         +'<button class="eb-add-btn" onclick="E.addEnd(\'image\')">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>'
         +'</div>';
        c.innerHTML=h;
    }
    return{init:init,load:load,save:save,
           setText:setText,setHeader:setHeader,setCell:setCell,
           addEnd:addEnd,insertAt:insertAt,remove:remove,move:move,menu:menu,
           tblAddRow:tblAddRow,tblRemRow:tblRemRow,tblAddCol:tblAddCol,tblRemCol:tblRemCol,
           imgClick:imgClick,imgChange:imgChange,imgDrop:imgDrop};
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–û–ù–í–ï–†–¢–ï–†: –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç ‚Üí v2 (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π videoUrl, articleUrl)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function convertToV2(data){
    var td=data.topicsData||{};
    Object.keys(td).forEach(function(tid){
        var topic=td[tid];
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —Å—Å—ã–ª–æ–∫, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if(topic.videoUrl === undefined) topic.videoUrl = '';
        if(topic.articleUrl === undefined) topic.articleUrl = '';

        var cond=topic.condition||{};
        if(!cond.blocks){
            var cb=[];
            if(cond.text&&cond.text.trim())   cb.push({type:'text',content:cond.text});
            if(cond.image&&cond.image.trim()) cb.push({type:'image',content:cond.image});
            topic.condition={blocks:cb};
        }
        var rawTasks=topic.tasks, newTasks={};
        if(rawTasks){
            if(Array.isArray(rawTasks)){
                rawTasks.forEach(function(task,idx){
                    var tb=[];
                    var txt=task.text||task.description||task.content||'';
                    var img=task.image||'';
                    if(txt.trim()) tb.push({type:'text',content:txt});
                    if(img.trim()) tb.push({type:'image',content:img});
                    newTasks[idx+1]={blocks:task.blocks||tb,correct:task.correct||'',hint:task.hint||''};
                });
            } else {
                Object.keys(rawTasks).forEach(function(kid){
                    var task=rawTasks[kid];
                    var tb=[];
                    var txt=task.text||task.description||task.content||'';
                    var img=task.image||'';
                    if(txt.trim()) tb.push({type:'text',content:txt});
                    if(img.trim()) tb.push({type:'image',content:img});
                    newTasks[kid]={blocks:task.blocks||tb,correct:task.correct||'',hint:task.hint||''};
                });
            }
        }
        topic.tasks=newTasks;
    });
    data.topicsData=td; data.version='2.0'; return data;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){

var currentTopic  = null;
var currentTaskId = 0;
var accessLevel   = 'control';
var passwords     = {teacher:'1111',study:'2222'};
var topicsData    = {};
var progress      = {};
var topics        = [];

// –¢–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–æ–±–∞–≤–ª–µ–Ω—ã videoUrl, articleUrl)
var DEFAULT_DATA = {
    "paper":   {name:"–ë—É–º–∞–≥–∞",       icon:"üìÑ", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}},
    "tariffs": {name:"–¢–∞—Ä–∏—Ñ—ã",       icon:"üí°", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}},
    "land":    {name:"–£—á–∞—Å—Ç–∫–∏",      icon:"üåø", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}},
    "travel":  {name:"–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",  icon:"üöÜ", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}},
    "stove":   {name:"–ü–µ—á–∫–∞",        icon:"üî•", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}},
    "tyres":   {name:"–®–∏–Ω—ã",         icon:"üöó", videoUrl:"", articleUrl:"", condition:{blocks:[]}, tasks:{}}
};
var DEFAULT_ORDER = ["paper","tariffs","land","travel","stove","tyres"];

E.init(function(){ return topicsData; });

var appContainer       = document.getElementById('appContainer');
var switchTeacher      = document.getElementById('switchTeacher');
var switchStudy        = document.getElementById('switchStudy');
var switchControl      = document.getElementById('switchControl');
var authModal          = document.getElementById('authModal');
var authPass           = document.getElementById('authPass');
var authTeacher        = document.getElementById('authTeacher');
var authStudy          = document.getElementById('authStudy');
var authControl        = document.getElementById('authControl');
var importFile         = document.getElementById('importFile');
var exportBtn          = document.getElementById('exportBtn');
var resultBtn          = document.getElementById('resultBtn');
var statsCorrect       = document.getElementById('correctCount');
var statsIncorrect     = document.getElementById('incorrectCount');
var totalCorrect       = document.getElementById('totalCorrect');
var totalIncorrect     = document.getElementById('totalIncorrect');
var topicContainer     = document.getElementById('topicContainer');
var taskGrid           = document.getElementById('taskGrid');
var conditionCard      = document.getElementById('conditionCard');
var taskCard           = document.getElementById('taskCard');
var conditionTitle     = document.getElementById('conditionTitle');
var conditionImageZone = document.getElementById('conditionImageZone');
var conditionText      = document.getElementById('conditionText');
var currentTaskTitle   = document.getElementById('currentTaskTitle');
var currentTopicBadge  = document.getElementById('currentTopicBadge');
var prevTaskBtn        = document.getElementById('prevTaskBtn');
var nextTaskBtn        = document.getElementById('nextTaskBtn');
var currentImageZone   = document.getElementById('currentImageZone');
var currentTaskDesc    = document.getElementById('currentTaskDesc');
var correctAnswerInput = document.getElementById('correctAnswerInput');
var hintTextArea       = document.getElementById('hintTextArea');
var currentCalcInput   = document.getElementById('currentCalcInput');
var currentCalcBtn     = document.getElementById('currentCalcBtn');
var currentCalcResult  = document.getElementById('currentCalcResult');
var currentAnswerInput = document.getElementById('currentAnswerInput');
var currentCheckBtn    = document.getElementById('currentCheckBtn');
var currentResultBadge = document.getElementById('currentResultBadge');
var hintWrapper        = document.getElementById('hintWrapper');
var hintToggleBtn      = document.getElementById('hintToggleBtn');
var hintDisplay        = document.getElementById('hintDisplay');
var reportModal        = document.getElementById('reportModal');
var studentName        = document.getElementById('studentName');
var studentClass       = document.getElementById('studentClass');
var generateReport     = document.getElementById('generateReport');
var cancelReport       = document.getElementById('cancelReport');
var imageModal         = document.getElementById('imageModal');
var modalImage         = document.getElementById('modalImage');
var closeImageModal    = document.getElementById('closeImageModal');

// –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å—Å—ã–ª–æ–∫
var videoUrlInput      = document.getElementById('videoUrlInput');
var articleUrlInput    = document.getElementById('articleUrlInput');
var videoLink          = document.getElementById('videoLink');
var articleLink        = document.getElementById('articleLink');
var conditionLinksEdit = document.getElementById('conditionLinksEdit');
var conditionLinksView = document.getElementById('conditionLinksView');

function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function taskCount(){ return Object.keys((topicsData[currentTopic]&&topicsData[currentTopic].tasks)||{}).length||16; }

// –§–ò–ö–°: ensureTask –∏ ensureCondition –ø—Ä–∏–Ω–∏–º–∞—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
function ensureTask(tid, kid){
    if(!topicsData[tid].tasks) topicsData[tid].tasks={};
    if(!topicsData[tid].tasks[kid]) topicsData[tid].tasks[kid]={blocks:[],correct:'',hint:''};
    if(!topicsData[tid].tasks[kid].blocks) topicsData[tid].tasks[kid].blocks=[];
}
function ensureCondition(tid){
    if(!topicsData[tid].condition) topicsData[tid].condition={blocks:[]};
    if(!topicsData[tid].condition.blocks) topicsData[tid].condition.blocks=[];
}

window.showZoom=function(src){
    if(!src)return;
    modalImage.style.width='';modalImage.style.height='';
    modalImage.onload=function(){
        var s=Math.min(window.innerWidth*.9/modalImage.naturalWidth,window.innerHeight*.9/modalImage.naturalHeight,2);
        modalImage.style.width=Math.round(modalImage.naturalWidth*s)+'px';modalImage.style.height='auto';
    };
    modalImage.src=src; imageModal.style.display='block';
};

function renderView(blocks,container){
    if(!blocks||!blocks.length){
        container.innerHTML='<span style="color:#aaa;font-size:13px;">–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</span>'; return;
    }
    var h='<div class="blocks-render">';
    blocks.forEach(function(b){
        if(b.type==='text') h+='<p>'+esc(b.content).replace(/\n/g,'<br>')+'</p>';
        else if(b.type==='table'){
            h+='<table><tr>';
            b.headers.forEach(function(hv){ h+='<th>'+esc(hv)+'</th>'; });
            h+='</tr>';
            b.rows.forEach(function(row){ h+='<tr>'; row.forEach(function(c){ h+='<td>'+esc(c)+'</td>'; }); h+='</tr>'; });
            h+='</table>';
        } else if(b.type==='image'&&b.content) h+='<img src="'+b.content+'" onclick="showZoom(this.src)">';
    });
    container.innerHTML=h+'</div>';
}

// –§–ò–ö–° –ì–õ–ê–í–ù–´–ô: showEditor —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –≤—ã–∑—ã–≤–∞–µ—Ç ensure —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
function showEditor(container, tid, kid){
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–¥–∞—á–∏ –≤ topicsData
    if(kid===0) ensureCondition(tid); else ensureTask(tid, kid);
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º white-space –∏–Ω–ª–∞–π–Ω ‚Äî —ç—Ç–æ –ø–µ—Ä–µ–±—å—ë—Ç –ª—é–±–æ–π CSS –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
    container.style.whiteSpace = 'normal';
    container.style.lineHeight = 'normal';
    container.innerHTML = '<div id="_ebc" class="block-editor"></div>';
    E.load(tid, kid);
}

// ‚îÄ‚îÄ –†–ï–ñ–ò–ú–´ ‚îÄ‚îÄ
var _pending=null;
function setMode(level){
    accessLevel=level; _pending=null;
    [switchTeacher,switchStudy,switchControl].forEach(function(b){ b.classList.remove('active-mode'); });
    if(level==='teacher')    switchTeacher.classList.add('active-mode');
    else if(level==='study') switchStudy.classList.add('active-mode');
    else                     switchControl.classList.add('active-mode');
    appContainer.classList.remove('teacher-mode','study-mode','control-mode');
    appContainer.classList.add(level+'-mode');
    hintWrapper.classList.toggle('hidden',level==='control');
    document.querySelectorAll('.teacher-only').forEach(function(el){ el.style.display=(level==='teacher')?'':'none'; });
    if(currentTaskId===0) renderCondition(); else renderCurrentTask();
}

switchControl.addEventListener('click',function(){ setMode('control'); });
switchStudy.addEventListener('click',function(){
    if(accessLevel==='study') return;
    _pending='study'; authPass.value=''; authModal.style.display='block';
    setTimeout(function(){ authPass.focus(); },100);
});
switchTeacher.addEventListener('click',function(){
    if(accessLevel==='teacher') return;
    _pending='teacher'; authPass.value=''; authModal.style.display='block';
    setTimeout(function(){ authPass.focus(); },100);
});
function tryAuth(level){
    var pw=level==='teacher'?passwords.teacher:passwords.study;
    if(authPass.value===pw){ authModal.style.display='none'; setMode(level); }
    else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
}
authTeacher.addEventListener('click',function(){ tryAuth('teacher'); });
authStudy.addEventListener('click',function(){   tryAuth('study'); });
authControl.addEventListener('click',function(){ authModal.style.display='none'; setMode('control'); });
authPass.addEventListener('keydown',function(e){
    if(e.key!=='Enter') return;
    if(_pending==='teacher'||_pending==='study') tryAuth(_pending);
    else { authModal.style.display='none'; setMode('control'); }
});

function updateStats(){
    if(!currentTopic){ statsCorrect.innerText=statsIncorrect.innerText=totalCorrect.innerText=totalIncorrect.innerText='0'; return; }
    var tp=progress[currentTopic]||{},tc=taskCount(),c=0,ic=0;
    for(var i=1;i<=tc;i++){ var s=tp[i]&&tp[i].status; if(s==='correct')c++; else if(s==='incorrect')ic++; }
    statsCorrect.innerText=c; statsIncorrect.innerText=ic;
    totalCorrect.innerText=tc; totalIncorrect.innerText=tc;
    renderTaskGrid();
}

function renderTopicButtons(){
    if(!topics.length) return;
    var h='';
    topics.forEach(function(id){
        var t=topicsData[id]; if(!t) return;
        h+='<button class="topic-btn '+(id===currentTopic?'active':'')+'" data-topic="'+id+'">'+(t.icon||'üìÅ')+' '+(t.name||id)+'</button>';
    });
    topicContainer.innerHTML=h;
    document.querySelectorAll('.topic-btn').forEach(function(btn){
        btn.addEventListener('click',function(){
            currentTopic=btn.dataset.topic; currentTaskId=0;
            renderTopicButtons(); renderCondition(); renderTaskGrid(); updateStats();
        });
    });
}

function renderTaskGrid(){
    if(!currentTopic) return;
    var tp=progress[currentTopic]||{},tc=taskCount();
    var h='<div class="task-square '+(currentTaskId===0?'active condition':'condition')+'" data-task-id="0">0</div>';
    for(var i=1;i<=tc;i++){
        var s=tp[i]&&tp[i].status==='correct'?'correct':tp[i]&&tp[i].status==='incorrect'?'incorrect':'';
        h+='<div class="task-square '+s+' '+(i===currentTaskId?'active':'')+'" data-task-id="'+i+'">'+i+'</div>';
    }
    taskGrid.innerHTML=h;
    document.querySelectorAll('.task-square').forEach(function(sq){
        sq.addEventListener('click',function(){
            var id=parseInt(sq.dataset.taskId); if(isNaN(id)) return;
            currentTaskId=id; renderTaskGrid();
            if(id===0) renderCondition(); else renderCurrentTask();
        });
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –≤ —É—Å–ª–æ–≤–∏–∏
function updateConditionLinks(){
    if(!currentTopic || !topicsData[currentTopic]) return;
    var topic = topicsData[currentTopic];
    // –î–ª—è —É—á–∏—Ç–µ–ª—è ‚Äì –ø–æ–ª—è –≤–≤–æ–¥–∞
    if(accessLevel === 'teacher'){
        videoUrlInput.value = topic.videoUrl || '';
        articleUrlInput.value = topic.articleUrl || '';
    }
    // –î–ª—è –≤—Å–µ—Ö ‚Äì —Å—Å—ã–ª–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if(topic.videoUrl && topic.videoUrl.trim() !== ''){
        videoLink.href = topic.videoUrl;
        videoLink.style.display = 'inline-flex';
    } else {
        videoLink.style.display = 'none';
    }
    if(topic.articleUrl && topic.articleUrl.trim() !== ''){
        articleLink.href = topic.articleUrl;
        articleLink.style.display = 'inline-flex';
    } else {
        articleLink.style.display = 'none';
    }
}

function renderCondition(){
    conditionCard.style.display='block';
    taskCard.style.display='none';
    conditionImageZone.style.display='none';
    if(!currentTopic||!topicsData[currentTopic]) return;
    conditionTitle.innerText='–£—Å–ª–æ–≤–∏–µ: '+(topicsData[currentTopic].name||currentTopic);
    var blocks=(topicsData[currentTopic].condition&&topicsData[currentTopic].condition.blocks)||[];
    if(accessLevel==='teacher') {
        showEditor(conditionText,currentTopic,0);
        conditionLinksEdit.style.display = 'flex';
    } else {
        conditionLinksEdit.style.display = 'none';
        renderView(blocks,conditionText);
    }
    updateConditionLinks();
}

function renderCurrentTask(){
    if(!currentTopic||!topicsData[currentTopic]||currentTaskId===0) return;
    conditionCard.style.display='none';
    taskCard.style.display='block';
    currentImageZone.style.display='none';

    var tasks = topicsData[currentTopic].tasks||{};
    // –§–ò–ö–°: –±–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á—É ‚Äî –æ–Ω–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    var td    = tasks[currentTaskId]||{blocks:[],correct:'',hint:''};
    var tp    = (progress[currentTopic]&&progress[currentTopic][currentTaskId])||{answer:'',status:'none',hintShown:false};

    currentTaskTitle.innerText  = '–ó–∞–¥–∞–Ω–∏–µ '+currentTaskId;
    currentTopicBadge.innerText = topicsData[currentTopic].name||currentTopic;

    if(accessLevel==='teacher'){
        // showEditor –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç ensureTask —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        showEditor(currentTaskDesc, currentTopic, currentTaskId);
        correctAnswerInput.value = td.correct||'';
        hintTextArea.value       = td.hint||'';
    } else {
        currentTaskDesc.style.whiteSpace='';
        currentTaskDesc.style.lineHeight='';
        renderView(td.blocks||[], currentTaskDesc);
    }

    currentAnswerInput.value=tp.answer||'';
    if(tp.status==='correct'){
        currentResultBadge.innerHTML='‚úÖ –í–µ—Ä–Ω–æ'; currentResultBadge.style.background='#d4edda';
    } else if(tp.status==='incorrect'){
        currentResultBadge.innerHTML='‚ùå –ù–µ–≤–µ—Ä–Ω–æ'; currentResultBadge.style.background='#f8d7da';
    } else {
        currentResultBadge.innerHTML='‚ö™ –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ'; currentResultBadge.style.background='';
    }
    hintDisplay.innerText=td.hint||'–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    var showHint=tp.hintShown&&accessLevel!=='control';
    hintDisplay.classList.toggle('hidden',!showHint);
    hintToggleBtn.innerText=showHint?'üìñ –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É':'üìñ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
}

function checkAnswer(){
    if(!currentTopic||currentTaskId===0) return;
    var ua=currentAnswerInput.value.trim();
    var tasks=topicsData[currentTopic].tasks||{};
    var ca=(tasks[currentTaskId]&&tasks[currentTaskId].correct)||'';
    if(!progress[currentTopic]) progress[currentTopic]={};
    if(!progress[currentTopic][currentTaskId]) progress[currentTopic][currentTaskId]={};
    progress[currentTopic][currentTaskId].answer=ua;
    progress[currentTopic][currentTaskId].status=(ua===ca)?'correct':'incorrect';
    renderCurrentTask(); renderTaskGrid(); updateStats();
}

function toggleHint(){
    if(accessLevel==='control'||!currentTopic||currentTaskId===0) return;
    if(!progress[currentTopic]) progress[currentTopic]={};
    if(!progress[currentTopic][currentTaskId]) progress[currentTopic][currentTaskId]={};
    progress[currentTopic][currentTaskId].hintShown=!progress[currentTopic][currentTaskId].hintShown;
    renderCurrentTask();
}

function initTopics(){
    topicsData = JSON.parse(JSON.stringify(DEFAULT_DATA));
    topics     = DEFAULT_ORDER.slice();
    currentTopic  = topics[0];
    currentTaskId = 0;
    renderTopicButtons(); renderCondition(); renderTaskGrid(); updateStats();
}

importFile.addEventListener('change',function(e){
    var file=e.target.files[0]; if(!file) return;
    var r=new FileReader();
    r.onload=function(ev){
        try{
            var raw=JSON.parse(ev.target.result);
            if(!raw.topicsData){ alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞'); return; }
            var data=convertToV2(raw);
            topicsData=data.topicsData; topics=Object.keys(topicsData);
            if(data.progress)  progress=data.progress;
            if(data.passwords){
                if(data.passwords.teacher) passwords.teacher=data.passwords.teacher;
                if(data.passwords.study)   passwords.study=data.passwords.study;
            }
            if(topics.length>0){ currentTopic=topics[0]; currentTaskId=0; }
            renderTopicButtons(); renderTaskGrid(); updateStats();
            if(currentTaskId===0) renderCondition(); else renderCurrentTask();
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        } catch(err){ alert('‚ùå –û—à–∏–±–∫–∞: '+err.message); }
    };
    r.readAsText(file); importFile.value='';
});

exportBtn.addEventListener('click',function(){
    if(accessLevel!=='teacher'){ alert('–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); return; }
    E.save(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏
    var json=JSON.stringify({version:'2.0',exported:new Date().toISOString(),topicsData:topicsData,progress:progress,passwords:passwords},null,2);
    var blob=new Blob([json],{type:'application/json'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download='oge_data_'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});

resultBtn.addEventListener('click',function(){
    if(accessLevel==='control'){ alert('–û—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Ç—Ä–æ–ª—è'); return; }
    studentName.value=localStorage.getItem('studentName')||'';
    studentClass.value=localStorage.getItem('studentClass')||'';
    reportModal.style.display='block';
});
generateReport.addEventListener('click',function(){
    var name=studentName.value.trim()||'–£—á–µ–Ω–∏–∫',cls=studentClass.value.trim()||'9';
    localStorage.setItem('studentName',name); localStorage.setItem('studentClass',cls);
    reportModal.style.display='none';
    var totC=0,totI=0,totU=0,results=[];
    topics.forEach(function(tid){
        var t=topicsData[tid]; if(!t) return;
        var tp=progress[tid]||{},tc=Object.keys(t.tasks||{}).length||16;
        var c=0,ic=0,u=0;
        for(var j=1;j<=tc;j++){ var s=tp[j]&&tp[j].status; if(s==='correct'){c++;totC++;} else if(s==='incorrect'){ic++;totI++;} else{u++;totU++;} }
        results.push({topic:t.name||tid,correct:c,incorrect:ic,unanswered:u,total:tc,pct:Math.round(c/tc*100)});
    });
    var tt=results.reduce(function(s,r){return s+r.total;},0),pct=tt?Math.round(totC/tt*100):0;
    var text='–û–¢–ß–ï–¢ –ü–û –í–´–ü–û–õ–ù–ï–ù–ò–Æ –ó–ê–î–ê–ù–ò–ô\n================================\n\n–£—á–µ–Ω–∏–∫: '+name+'\n–ö–ª–∞—Å—Å: '+cls+'\n–î–∞—Ç–∞: '+new Date().toLocaleString('ru-RU')+'\n\n–û–ë–©–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢:\n–í—Å–µ–≥–æ: '+tt+' | ‚úÖ '+totC+' | ‚ùå '+totI+' | ‚ö™ '+totU+' | üìä '+pct+'%\n\n–ü–û –†–ê–ó–î–ï–õ–ê–ú:\n';
    results.forEach(function(r){ text+='\n'+r.topic+':\n  ‚úÖ '+r.correct+'/'+r.total+' ('+r.pct+'%)  ‚ùå '+r.incorrect+'  ‚ö™ '+r.unanswered+'\n'; });
    var blob=new Blob([text],{type:'text/plain;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=name+'_–æ—Ç—á–µ—Ç.txt';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});
cancelReport.addEventListener('click',function(){ reportModal.style.display='none'; });

prevTaskBtn.addEventListener('click',function(){
    if(currentTaskId>0){ currentTaskId--; renderTaskGrid(); if(currentTaskId===0) renderCondition(); else renderCurrentTask(); }
});
nextTaskBtn.addEventListener('click',function(){
    if(currentTaskId<taskCount()){ currentTaskId++; renderTaskGrid(); renderCurrentTask(); }
});
correctAnswerInput.addEventListener('input',function(){
    if(accessLevel!=='teacher'||currentTaskId===0) return;
    ensureTask(currentTopic, currentTaskId);
    topicsData[currentTopic].tasks[currentTaskId].correct=correctAnswerInput.value;
});
hintTextArea.addEventListener('input',function(){
    if(accessLevel!=='teacher'||currentTaskId===0) return;
    ensureTask(currentTopic, currentTaskId);
    topicsData[currentTopic].tasks[currentTaskId].hint=hintTextArea.value;
});
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
videoUrlInput.addEventListener('input',function(){
    if(accessLevel!=='teacher'||!currentTopic) return;
    if(!topicsData[currentTopic]) topicsData[currentTopic]={};
    topicsData[currentTopic].videoUrl = videoUrlInput.value;
    updateConditionLinks();
});
articleUrlInput.addEventListener('input',function(){
    if(accessLevel!=='teacher'||!currentTopic) return;
    if(!topicsData[currentTopic]) topicsData[currentTopic]={};
    topicsData[currentTopic].articleUrl = articleUrlInput.value;
    updateConditionLinks();
});

currentCheckBtn.addEventListener('click',checkAnswer);
currentAnswerInput.addEventListener('keydown',function(e){ if(e.key==='Enter') checkAnswer(); });
hintToggleBtn.addEventListener('click',toggleHint);
currentCalcBtn.addEventListener('click',function(){
    var expr=currentCalcInput.value.replace(/[^0-9+\-*/().\s]/g,''); if(!expr) return;
    try{ var res=new Function('return ('+expr+')')(); currentCalcResult.innerText=(res!=null)?Math.round(res*1000000)/1000000:'0'; }
    catch(ex){ currentCalcResult.innerText='–û—à–∏–±–∫–∞'; }
});
currentCalcInput.addEventListener('keydown',function(e){ if(e.key==='Enter') currentCalcBtn.click(); });
closeImageModal.addEventListener('click',function(){ imageModal.style.display='none'; });
window.addEventListener('click',function(e){
    if(e.target===imageModal)  imageModal.style.display='none';
    if(e.target===reportModal) reportModal.style.display='none';
});

window.addEventListener('load',function(){ initTopics(); setMode('control'); });

})();
</script>
</body>
</html>