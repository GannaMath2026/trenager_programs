<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ì–≠ –¢—Ä–µ–Ω–∞–∂—ë—Ä</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #eef2f6;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            max-width: 1200px;
            width: 100%;
        }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header-panel {
            background: linear-gradient(145deg, #ffffff, #f5f9ff);
            border-radius: 40px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,30,60,0.1);
            border: 1px solid #d9e6f2;
        }
        .mode-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .mode-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mode-badge {
            background: #e9f0fa;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            color: #1d3e63;
            border: 1px solid #b8cde0;
        }
        .mode-badge.teacher {
            background: #8e6baf;
            color: white;
            border-color: #6b4f8a;
        }
        .mode-badge.study {
            background: #5f7fa0;
            color: white;
        }
        .mode-badge.control {
            background: #9e6d6d;
            color: white;
        }
        .logout-btn {
            background: #2c3e50;
            border: none;
            border-radius: 40px;
            padding: 8px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .file-actions button {
            background: #f0f4fa;
            border: 1px solid #a5bad4;
            border-radius: 40px;
            padding: 10px 16px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        #resultBtn {
            background: #8e6baf;
            color: white;
            border-color: #6b4f8a;
        }
        .stats {
            display: flex;
            gap: 25px;
            background: #2c3e50;
            color: white;
            padding: 12px 35px;
            border-radius: 60px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.2);
        }
        .stats span {
            font-size: 1.15rem;
        }
        .stats .correct { color: #a3e0b0; font-weight: 700; }
        .stats .incorrect { color: #f9b5b5; font-weight: 700; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        .auth-modal-content {
            background: white;
            max-width: 400px;
            margin: 200px auto;
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        .auth-modal-content h3 {
            color: #1d3e63;
            margin-bottom: 20px;
        }
        .auth-modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        .auth-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-btn-teacher {
            background: #8e6baf;
            color: white;
        }
        .auth-btn-study {
            background: #5f7fa0;
            color: white;
        }
        .auth-btn-control {
            background: #9e6d6d;
            color: white;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ–º–∞–º */
        .nav-section {
            background: white;
            border-radius: 40px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px 25px;
            border: 1px solid #d0e1f0;
        }
        .topic-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .topic-btn {
            background: #e1ecf9;
            border: none;
            border-radius: 40px;
            padding: 10px 22px;
            font-weight: 600;
            color: #1a3f5c;
            cursor: pointer;
            transition: 0.1s;
            border: 1px solid #b3cbe3;
        }
        .topic-btn.active {
            background: #2b6c9e;
            color: white;
            border-color: #1b4c72;
        }
        
        /* –°–µ—Ç–∫–∞ –∑–∞–¥–∞—á */
        .task-grid {
            background: white;
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            border: 1px solid #c9ddec;
        }
        .task-square {
            aspect-ratio: 1/1;
            background: #e7f0fa;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f3b58;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .task-square.correct {
            background: #c8f0d1;
            border-color: #2e8b57;
            color: #1d5438;
        }
        .task-square.incorrect {
            background: #fad1d1;
            border-color: #b34a4a;
            color: #632626;
        }
        .task-square.active {
            border: 4px solid #f5b342;
            transform: scale(1.02);
        }
        .task-square.condition {
            background: #2b6c9e;
            color: white;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —É—Å–ª–æ–≤–∏—è (–∑–∞–¥–∞–Ω–∏–µ 0) */
        .condition-card {
            background: white;
            border-radius: 40px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0,40,70,0.1);
            border: 1px solid #d0e1f0;
            margin-bottom: 20px;
        }
        .condition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .condition-title {
            background: #2b6c9e;
            color: white;
            padding: 10px 30px;
            border-radius: 60px;
            font-weight: 700;
        }
        .condition-image-zone {
            border: 2px dashed #b2cbe4;
            border-radius: 30px;
            background: #fafdff;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin: 20px 0;
            flex-direction: column;
        }
        .condition-image-zone img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .condition-text {
            background: #f7faff;
            border-radius: 28px;
            padding: 20px;
            line-height: 1.6;
            border: 1px solid #c2d6ec;
            white-space: pre-wrap;
        }
        .condition-text.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .condition-text textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ */
        .task-card {
            background: white;
            border-radius: 40px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0,40,70,0.1);
            border: 1px solid #d0e1f0;
            margin-bottom: 20px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .task-title {
            background: #e1ecf9;
            padding: 10px 30px;
            border-radius: 60px;
            font-weight: 700;
            color: #1d4e7a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .topic-badge {
            background: #2b6c9e;
            color: white;
            padding: 5px 15px;
            border-radius: 40px;
            font-size: 0.9rem;
        }
        .task-nav {
            display: flex;
            gap: 10px;
        }
        .task-nav button {
            background: #cbdbea;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f3f60;
            cursor: pointer;
        }
        .task-image-zone {
            border: 2px dashed #b2cbe4;
            border-radius: 30px;
            background: #fafdff;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin: 20px 0;
            flex-direction: column;
        }
        .task-image-zone img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .task-desc {
            background: #f7faff;
            border-radius: 28px;
            padding: 20px;
            line-height: 1.6;
            border: 1px solid #c2d6ec;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        .task-desc.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .task-desc textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        /* –ü–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è */
        .teacher-only {
            display: none;
        }
        .teacher-mode .teacher-only {
            display: block;
        }
        
        .correct-answer {
            background: #e8f0fe;
            border-radius: 24px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #b0c6dd;
        }
        .correct-answer input {
            width: 200px;
            padding: 10px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            font-size: 1rem;
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        .hint-text {
            background: #fff4db;
            border-left: 6px solid #f5b342;
            border-radius: 24px;
            padding: 18px;
            margin: 15px 0;
            line-height: 1.6;
        }
        .hint-text.edit-mode {
            background: white;
            border: 2px solid #f5b342;
        }
        .hint-text textarea {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        .calc-area {
            background: #eef4fc;
            border-radius: 30px;
            padding: 18px;
            margin: 15px 0;
            border: 1px solid #bdcfe3;
        }
        .calc-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .calc-input {
            flex: 2;
            border: 1px solid #b2c7e0;
            border-radius: 60px;
            padding: 12px 22px;
            font-size: 1rem;
        }
        .calc-eval-btn {
            background: #497aa8;
            border: none;
            border-radius: 60px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .calc-result {
            background: white;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            border: 1px solid #acc4e0;
            min-width: 90px;
            text-align: center;
        }
        .input-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .input-area input {
            border: 2px solid #b6cde0;
            border-radius: 60px;
            padding: 12px 25px;
            font-size: 1rem;
            width: 220px;
        }
        .input-area button {
            background: #2b6c9e;
            border: none;
            border-radius: 60px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .result-badge {
            background: #f0f6ff;
            border-radius: 60px;
            padding: 12px 25px;
            font-weight: 600;
            border: 2px solid #acc4e0;
            min-width: 140px;
            text-align: center;
        }
        .hint-wrapper {
            margin-top: 15px;
        }
        .hint-button {
            background: #efe7d3;
            border: 1px solid #c5ac77;
            border-radius: 60px;
            padding: 10px 25px;
            font-weight: 600;
            color: #5e4e2b;
            cursor: pointer;
            display: inline-block;
        }
        .hidden { display: none; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            max-width: 90%;
            max-height: 90vh;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
        }
        .modal-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 20px;
        }
        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ */
        .input-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        .input-modal-content {
            background: white;
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 30px;
        }
        .input-modal-content h3 {
            color: #1d3e63;
            margin-bottom: 20px;
        }
        .input-modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #b6cde0;
            border-radius: 40px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .primary {
            background: #8e6baf;
            color: white;
        }
        .secondary {
            background: #e0e0e0;
        }
    
    .mode-switcher{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    .mode-switch-btn{padding:7px 14px;border-radius:30px;border:1px solid #c0cce0;background:#f0f4fc;color:#1e3a6b;font-size:13px;font-weight:600;cursor:pointer;transition:.15s;}
    .mode-switch-btn:hover{background:#dce7ff;}
    .mode-switch-btn.active-mode{background:#1e3c72;color:white;border-color:#1e3c72;}
    .block-editor{display:flex;flex-direction:column;gap:0;}
    .editor-block{border:1px solid #dde5f5;border-radius:14px;padding:12px;background:#fafcff;margin:0;}
    .editor-block:hover{border-color:#7f9fd9;}
    .eb-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .eb-icon{font-size:15px;}
    .eb-label{font-size:11px;font-weight:700;color:#7f9fd9;text-transform:uppercase;letter-spacing:.5px;flex:1;}
    .eb-actions button{background:none;border:none;cursor:pointer;font-size:14px;padding:2px 5px;border-radius:6px;color:#7f9fd9;}
    .eb-actions button:hover{background:#eef3fc;color:#1e3c72;}
    .eb-actions .del:hover{background:#ffebee;color:#c62828;}
    .eb-textarea{width:100%;border:1px solid #dde5f5;border-radius:10px;padding:9px;font-size:14px;font-family:inherit;resize:vertical;min-height:65px;outline:none;box-sizing:border-box;}
    .eb-textarea:focus{border-color:#3a7bd5;}
    .eb-tbl-ctrl{display:flex;gap:6px;margin-bottom:7px;flex-wrap:wrap;}
    .eb-tbl-ctrl button{padding:4px 11px;border-radius:20px;border:none;background:#e8f0fe;color:#1e3c72;font-size:12px;font-weight:600;cursor:pointer;}
    .eb-tbl-ctrl button:hover{background:#c8d6ee;}
    .eb-tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid #c8d6ee;}
    .eb-tbl-wrap table{border-collapse:collapse;width:100%;}
    .eb-tbl-wrap th{background:#e8f0fe;border:1px solid #c8d6ee;}
    .eb-tbl-wrap td{border:1px solid #dde5f5;}
    .eb-tbl-wrap th input,.eb-tbl-wrap td input{width:100%;border:none;padding:6px 8px;font-size:13px;font-family:inherit;background:transparent;outline:none;min-width:55px;}
    .eb-tbl-wrap th input{font-weight:700;color:#1e3c72;}
    .eb-tbl-wrap tr:hover td{background:#f5f8ff;}
    .eb-img-zone{border:2px dashed #a0b8e0;border-radius:10px;padding:16px;text-align:center;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;transition:.2s;min-height:70px;}
    .eb-img-zone:hover{background:#e3edff;border-color:#3a7bd5;}
    .eb-img-zone img{max-width:100%;max-height:150px;border-radius:8px;}
    .eb-img-zone .ph{color:#7f9fd9;font-size:13px;}
    .eb-img-zone .lbl{font-size:11px;color:#6b7f9a;}
    .eb-add-bar{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
    .eb-add-btn{padding:6px 13px;border-radius:20px;border:1.5px dashed #7f9fd9;background:#f0f6ff;color:#1e3c72;font-size:12px;font-weight:600;cursor:pointer;}
    .eb-add-btn:hover{background:#dce9ff;}
    .eb-divider{display:flex;align-items:center;gap:0;margin:5px 0;height:26px;}
    .eb-div-line{flex:1;height:2px;background:#dde5f5;border-radius:1px;transition:.15s;}
    .eb-div-btn{padding:2px 10px;border-radius:20px;border:1px solid #c8d6ee;background:white;color:#7f9fd9;font-size:11px;font-weight:700;cursor:pointer;opacity:0;white-space:nowrap;}
    .eb-divider:hover .eb-div-btn{opacity:1;}
    .eb-divider:hover .eb-div-line{background:#a0b8e0;}
    .eb-div-btn:hover{background:#e8f0fe;color:#1e3c72;border-color:#3a7bd5;}
    .eb-insert-menu{display:flex;align-items:center;gap:7px;margin:5px 0;background:#e8f0fe;border-radius:10px;padding:7px 10px;flex-wrap:wrap;}
    .eb-insert-menu span{font-size:11px;color:#4a5f7a;font-weight:700;}
    .eb-insert-menu .ins-btn{padding:4px 10px;border-radius:20px;border:1.5px dashed #7f9fd9;background:#f0f6ff;color:#1e3c72;font-size:11px;font-weight:600;cursor:pointer;}
    .eb-insert-menu .ins-btn:hover{background:#dce9ff;}
    .eb-insert-menu .cancel{border:none;background:#c8d6ee;color:#4a5f7a;border-radius:20px;padding:4px 9px;font-size:11px;cursor:pointer;}
    .blocks-render p{margin:0 0 10px 0;white-space:pre-wrap;font-size:14px;line-height:1.7;}
    .blocks-render table{border-collapse:collapse;width:100%;margin:10px 0;}
    .blocks-render th{background:#1e3c72;color:white;padding:7px 11px;font-size:13px;text-align:left;}
    .blocks-render td{border:1px solid #c8d6ee;padding:6px 11px;text-align:center;font-size:13px;}
    .blocks-render tr:nth-child(even) td{background:#f5f8ff;}
    .blocks-render img{max-width:100%;border-radius:10px;margin:6px 0;display:block;cursor:zoom-in;}
    #imageModal .modal-content img{max-width:min(90vw,1200px);max-height:90vh;width:auto;height:auto;border-radius:12px;display:block;}
</style>
</head>
<body>
<div class="app-container" id="appContainer">

    <!-- –®–ê–ü–ö–ê -->
    <div class="header-panel">
        <div class="mode-row">
            <div class="mode-info">
                <div class="mode-switcher" id="modeSwitcher">
                    <button class="mode-switch-btn" id="switchControl">üîí –ö–æ–Ω—Ç—Ä–æ–ª—å</button>
                    <button class="mode-switch-btn" id="switchStudy">üë®‚Äçüéì –û–±—É—á–µ–Ω–∏–µ</button>
                    <button class="mode-switch-btn" id="switchTeacher">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                </div>
            </div>
            <div class="file-actions">
                <label for="importFile" id="importBtn" style="cursor:pointer;">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</label>
                <button id="exportBtn" class="teacher-only">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="resultBtn" class="study-only">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <input type="file" id="importFile" accept=".json" hidden>
            </div>
            <div class="stats" id="statsDisplay">
                <span>‚úÖ <span id="correctCount">0</span>/<span id="totalCorrect">0</span></span>
                <span>‚ùå <span id="incorrectCount">0</span>/<span id="totalIncorrect">0</span></span>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <h3>üîê –í—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º</h3>
            <input type="password" id="authPass" placeholder="–ø–∞—Ä–æ–ª—å" maxlength="4">
            <div class="auth-buttons">
                <button class="auth-btn-teacher" id="authTeacher">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å</button>
                <button class="auth-btn-study" id="authStudy">üë®‚Äçüéì –ò–∑—É—á–µ–Ω–∏–µ</button>
                <button class="auth-btn-control" id="authControl">üîí –ö–æ–Ω—Ç—Ä–æ–ª—å</button>
            </div>
        </div>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –¢–ï–ú–ê–ú -->
    <div class="nav-section">
        <div class="topic-buttons" id="topicContainer"></div>
    </div>

    <!-- –°–ï–¢–ö–ê –ó–ê–î–ê–ß (–≤–∫–ª—é—á–∞—è –∑–∞–¥–∞–Ω–∏–µ 0 - —É—Å–ª–æ–≤–∏–µ) -->
    <div class="task-grid" id="taskGrid"></div>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –£–°–õ–û–í–ò–Ø (–∑–∞–¥–∞–Ω–∏–µ 0) -->
    <div class="condition-card" id="conditionCard">
        <div class="condition-header">
            <span class="condition-title" id="conditionTitle">–£—Å–ª–æ–≤–∏–µ</span>
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è -->
        <div class="condition-image-zone" id="conditionImageZone">
            <span class="image-placeholder">üìé –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è</span>
            <img id="conditionImagePreview" style="display: none;">
            <input type="file" id="conditionFileInput" accept="image/*" hidden>
        </div>

        <!-- –¢–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è -->
        <div class="condition-text" id="conditionText"></div>
    </div>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –ó–ê–î–ê–ß–ò -->
    <div class="task-card" id="taskCard">
        <div class="task-header">
            <div class="task-title">
                <span id="currentTaskTitle">–ó–∞–¥–∞–Ω–∏–µ</span>
                <span class="topic-badge" id="currentTopicBadge"></span>
            </div>
            <div class="task-nav">
                <button id="prevTaskBtn">‚Üê</button>
                <button id="nextTaskBtn">‚Üí</button>
            </div>
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
        <div class="task-image-zone" id="currentImageZone">
            <span class="image-placeholder">üìé –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</span>
            <img id="currentImagePreview" style="display: none;">
            <input type="file" id="currentFileInput" accept="image/*" hidden>
        </div>

        <!-- –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ -->
        <div class="task-desc" id="currentTaskDesc"></div>

        <!-- –ü–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
        <div class="teacher-only">
            <div class="correct-answer">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                <input type="text" id="correctAnswerInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 76108">
            </div>
            <div class="hint-text">
                <textarea id="hintTextArea" placeholder="–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏..."></textarea>
            </div>
        </div>

        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
        <div class="calc-area">
            <div style="margin-bottom:8px; font-weight:600;">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
            <div class="calc-row">
                <input type="text" class="calc-input" id="currentCalcInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 3*90/0.5">
                <button class="calc-eval-btn" id="currentCalcBtn">–í—ã—á–∏—Å–ª–∏—Ç—å</button>
                <span class="calc-result" id="currentCalcResult">0</span>
            </div>
        </div>

        <!-- –í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ -->
        <div class="input-area">
            <input type="text" id="currentAnswerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç">
            <button id="currentCheckBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <span class="result-badge" id="currentResultBadge">‚ö™ –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ –∏–∑—É—á–µ–Ω–∏—è) -->
        <div class="hint-wrapper" id="hintWrapper">
            <span class="hint-button" id="hintToggleBtn">üìñ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</span>
            <div class="hint-text hidden" id="hintDisplay"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
    <div id="reportModal" class="input-modal">
        <div class="input-modal-content">
            <h3>üìã –û—Ç—á–µ—Ç</h3>
            <input type="text" id="studentName" placeholder="–§–∞–º–∏–ª–∏—è –∏ –∏–º—è —É—á–µ–Ω–∏–∫–∞">
            <input type="text" id="studentClass" placeholder="–ö–ª–∞—Å—Å">
            <div class="modal-buttons">
                <button class="primary" id="generateReport">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="secondary" id="cancelReport">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeImageModal">&times;</span>
            <img id="modalImage">
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢ –†–ï–î–ê–ö–¢–û–†–ê (–Ω—É–∂–µ–Ω –¥–ª—è onclick= –≤ innerHTML) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var E = (function(){
    var _blocks  = [];   // —Ç–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏
    var _target  = null; // { topicId, taskId }
    var _menuAt  = -1;   // –æ—Ç–∫—Ä—ã—Ç–æ–µ –º–µ–Ω—é –≤—Å—Ç–∞–≤–∫–∏
    var _getTopicsData, _saveCallback;

    function init(getTopicsData, saveCallback){
        _getTopicsData = getTopicsData;
        _saveCallback  = saveCallback;
    }

    function load(topicId, taskId){
        _target = { topicId, taskId };
        _menuAt = -1;
        var td = _getTopicsData();
        var src = (taskId===0)
            ? (td[topicId]?.condition?.blocks || [])
            : (td[topicId]?.tasks?.[taskId]?.blocks || []);
        _blocks = JSON.parse(JSON.stringify(src));
        render();
    }

    function sync(){
        _blocks.forEach(function(b,i){
            if(b.type==='text'){
                var el=document.getElementById('ebtxt_'+i); if(el) b.content=el.value;
            } else if(b.type==='table'){
                b.headers.forEach(function(_,hi){ var el=document.getElementById('ebth_'+i+'_'+hi); if(el) b.headers[hi]=el.value; });
                b.rows.forEach(function(row,ri){ row.forEach(function(_,ci){ var el=document.getElementById('ebtd_'+i+'_'+ri+'_'+ci); if(el) b.rows[ri][ci]=el.value; }); });
            }
        });
    }

    function save(){
        sync();
        if(!_target) return;
        var td = _getTopicsData();
        var blocks = JSON.parse(JSON.stringify(_blocks));
        if(_target.taskId===0){
            if(!td[_target.topicId].condition) td[_target.topicId].condition={};
            td[_target.topicId].condition.blocks = blocks;
        } else {
            if(!td[_target.topicId].tasks) td[_target.topicId].tasks={};
            if(!td[_target.topicId].tasks[_target.taskId]) td[_target.topicId].tasks[_target.taskId]={};
            td[_target.topicId].tasks[_target.taskId].blocks = blocks;
        }
        if(_saveCallback) _saveCallback();
    }

    // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã ‚Äî –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ onclick=
    function addEnd(type){ sync(); insertAt(type, _blocks.length); }

    function insertAt(type, pos){
        sync();
        var b;
        if(type==='text')       b={type:'text',  content:''};
        else if(type==='table') b={type:'table', headers:['–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1','–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2','–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3'], rows:[['','','']]};
        else                    b={type:'image', content:''};
        _blocks.splice(pos,0,b);
        _menuAt=-1; save(); render();
    }

    function remove(i){ sync(); _blocks.splice(i,1); _menuAt=-1; save(); render(); }

    function move(i,d){ sync(); var j=i+d; if(j<0||j>=_blocks.length) return; var t=_blocks[i]; _blocks[i]=_blocks[j]; _blocks[j]=t; save(); render(); }

    function toggleMenu(pos){ sync(); _menuAt=(_menuAt===pos)?-1:pos; render(); }

    function tblAddRow(i)   { sync(); _blocks[i].rows.push(Array(_blocks[i].headers.length).fill('')); save(); render(); }
    function tblRemRow(i)   { sync(); if(_blocks[i].rows.length>1) _blocks[i].rows.pop(); save(); render(); }
    function tblAddCol(i)   { sync(); _blocks[i].headers.push('–ó–∞–≥–æ–ª–æ–≤–æ–∫'); _blocks[i].rows.forEach(function(r){r.push('');}); save(); render(); }
    function tblRemCol(i)   { sync(); if(_blocks[i].headers.length>1){ _blocks[i].headers.pop(); _blocks[i].rows.forEach(function(r){r.pop();}); } save(); render(); }

    function imgClick(i)    { var f=document.getElementById('ebimgfile_'+i); if(f) f.click(); }
    function imgChange(e,i) {
        var f=e.target.files[0]; if(!f) return;
        var r=new FileReader(); r.onload=function(ev){ _blocks[i].content=ev.target.result; save(); render(); }; r.readAsDataURL(f);
    }
    function imgDrop(e,i)   {
        e.preventDefault(); var f=e.dataTransfer.files[0]; if(!f) return;
        var r=new FileReader(); r.onload=function(ev){ _blocks[i].content=ev.target.result; save(); render(); }; r.readAsDataURL(f);
    }

    // Paste –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π image-–±–ª–æ–∫
    document.addEventListener('paste', function(e){
        var container=document.getElementById('blockEditorContainer');
        if(!container) return;
        var items=(e.clipboardData||e.originalEvent.clipboardData).items;
        for(var k=0;k<items.length;k++){
            if(items[k].type.indexOf('image')===0){
                var t=-1; _blocks.forEach(function(b,bi){ if(b.type==='image') t=bi; });
                if(t!==-1){
                    (function(idx,item){
                        var r=new FileReader(); r.onload=function(ev){ _blocks[idx].content=ev.target.result; save(); render(); }; r.readAsDataURL(item.getAsFile());
                    })(t, items[k]);
                    e.preventDefault();
                }
                return;
            }
        }
    });

    function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function render(){
        var c=document.getElementById('blockEditorContainer');
        if(!c) return;
        var html='';
        for(var i=0;i<=_blocks.length;i++){
            if(_menuAt===i){
                html+='<div class="eb-insert-menu">'
                    +'<span>–í—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞:</span>'
                    +'<button class="ins-btn" onclick="E.insertAt(\'text\','+i+')">üìù –¢–µ–∫—Å—Ç</button>'
                    +'<button class="ins-btn" onclick="E.insertAt(\'table\','+i+')">üìä –¢–∞–±–ª–∏—Ü–∞</button>'
                    +'<button class="ins-btn" onclick="E.insertAt(\'image\','+i+')">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>'
                    +'<button class="cancel" onclick="E.toggleMenu('+i+')">‚úï</button>'
                    +'</div>';
            } else if(i<_blocks.length){
                html+='<div class="eb-divider">'
                    +'<div class="eb-div-line"></div>'
                    +'<button class="eb-div-btn" onclick="E.toggleMenu('+i+')">Ôºã –≤—Å—Ç–∞–≤–∏—Ç—å</button>'
                    +'<div class="eb-div-line"></div>'
                    +'</div>';
            }
            if(i===_blocks.length) break;
            var b=_blocks[i];
            var icons={text:'üìù',table:'üìä',image:'üñºÔ∏è'};
            var labels={text:'–¢–µ–∫—Å—Ç',table:'–¢–∞–±–ª–∏—Ü–∞',image:'–ö–∞—Ä—Ç–∏–Ω–∫–∞'};
            html+='<div class="editor-block">'
                +'<div class="eb-header">'
                +'<span class="eb-icon">'+icons[b.type]+'</span>'
                +'<span class="eb-label">'+labels[b.type]+'</span>'
                +'<div class="eb-actions">'
                +'<button onclick="E.move('+i+',-1)" title="–í–≤–µ—Ä—Ö">‚Üë</button>'
                +'<button onclick="E.move('+i+',1)" title="–í–Ω–∏–∑">‚Üì</button>'
                +'<button class="del" onclick="E.remove('+i+')" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>'
                +'</div></div>';

            if(b.type==='text'){
                html+='<textarea class="eb-textarea" id="ebtxt_'+i+'" oninput="_ebInput('+i+',this.value)" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">'+esc(b.content)+'</textarea>';
            } else if(b.type==='table'){
                html+='<div class="eb-tbl-ctrl">'
                    +'<button onclick="E.tblAddRow('+i+')">+ —Å—Ç—Ä–æ–∫–∞</button>'
                    +'<button onclick="E.tblRemRow('+i+')">‚àí —Å—Ç—Ä–æ–∫–∞</button>'
                    +'<button onclick="E.tblAddCol('+i+')">+ —Å—Ç–æ–ª–±–µ—Ü</button>'
                    +'<button onclick="E.tblRemCol('+i+')">‚àí —Å—Ç–æ–ª–±–µ—Ü</button>'
                    +'</div><div class="eb-tbl-wrap"><table><tr>';
                b.headers.forEach(function(h,hi){
                    html+='<th><input type="text" id="ebth_'+i+'_'+hi+'" value="'+esc(h)+'" oninput="_ebTh('+i+','+hi+',this.value)" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"></th>';
                });
                html+='</tr>';
                b.rows.forEach(function(row,ri){
                    html+='<tr>';
                    row.forEach(function(cell,ci){
                        html+='<td><input type="text" id="ebtd_'+i+'_'+ri+'_'+ci+'" value="'+esc(cell)+'" oninput="_ebTd('+i+','+ri+','+ci+',this.value)" placeholder="‚Äî"></td>';
                    });
                    html+='</tr>';
                });
                html+='</table></div>';
            } else if(b.type==='image'){
                html+='<div class="eb-img-zone" onclick="E.imgClick('+i+')" ondragover="event.preventDefault()" ondrop="E.imgDrop(event,'+i+')">';
                if(b.content) html+='<img src="'+b.content+'"><span class="lbl">–ö–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å / Ctrl+V</span>';
                else html+='<span class="ph">üñºÔ∏è –ö–ª–∏–∫–Ω–∏, –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ Ctrl+V</span><span class="lbl">PNG, JPG, GIF</span>';
                html+='</div><input type="file" id="ebimgfile_'+i+'" accept="image/*" style="display:none" onchange="E.imgChange(event,'+i+')">';
            }
            html+='</div>';
        }
        html+='<div class="eb-add-bar">'
            +'<button class="eb-add-btn" onclick="E.addEnd(\'text\')">üìù –¢–µ–∫—Å—Ç</button>'
            +'<button class="eb-add-btn" onclick="E.addEnd(\'table\')">üìä –¢–∞–±–ª–∏—Ü–∞</button>'
            +'<button class="eb-add-btn" onclick="E.addEnd(\'image\')">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>'
            +'</div>';
        c.innerHTML=html;
    }

    function getBlocks(){ return _blocks; }

    return { init:init, load:load, save:save, addEnd:addEnd, insertAt:insertAt,
             remove:remove, move:move, toggleMenu:toggleMenu,
             tblAddRow:tblAddRow, tblRemRow:tblRemRow, tblAddCol:tblAddCol, tblRemCol:tblRemCol,
             imgClick:imgClick, imgChange:imgChange, imgDrop:imgDrop,
             getBlocks:getBlocks, render:render };
})();

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è oninput –≤ –ø–æ–ª—è—Ö —Ç–∞–±–ª–∏—Ü—ã/—Ç–µ–∫—Å—Ç (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º sync)
function _ebInput(i,v){ /* live, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π sync */ }
function _ebTh(i,hi,v){ /* live */ }
function _ebTd(i,ri,ci,v){ /* live */ }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){

var currentTopic  = null;
var currentTaskId = 0;
var accessLevel   = 'control';
var passwords     = { teacher:'1111', study:'2222' };
var topicsData    = {};
var progress      = {};
var topics        = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
E.init(function(){ return topicsData; }, null);

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var switchTeacher      = document.getElementById('switchTeacher');
var switchStudy        = document.getElementById('switchStudy');
var switchControl      = document.getElementById('switchControl');
var authModal          = document.getElementById('authModal');
var authPass           = document.getElementById('authPass');
var authTeacher        = document.getElementById('authTeacher');
var authStudy          = document.getElementById('authStudy');
var authControl        = document.getElementById('authControl');
var importFile         = document.getElementById('importFile');
var exportBtn          = document.getElementById('exportBtn');
var resultBtn          = document.getElementById('resultBtn');
var statsCorrectSpan   = document.getElementById('correctCount');
var statsIncorrectSpan = document.getElementById('incorrectCount');
var totalCorrectSpan   = document.getElementById('totalCorrect');
var totalIncorrectSpan = document.getElementById('totalIncorrect');
var topicContainer     = document.getElementById('topicContainer');
var taskGrid           = document.getElementById('taskGrid');
var conditionCard      = document.getElementById('conditionCard');
var taskCard           = document.getElementById('taskCard');
var conditionTitle     = document.getElementById('conditionTitle');
var conditionImageZone = document.getElementById('conditionImageZone');
var conditionText      = document.getElementById('conditionText');
var currentTaskTitle   = document.getElementById('currentTaskTitle');
var currentTopicBadge  = document.getElementById('currentTopicBadge');
var prevTaskBtn        = document.getElementById('prevTaskBtn');
var nextTaskBtn        = document.getElementById('nextTaskBtn');
var currentImageZone   = document.getElementById('currentImageZone');
var currentTaskDesc    = document.getElementById('currentTaskDesc');
var correctAnswerInput = document.getElementById('correctAnswerInput');
var hintTextArea       = document.getElementById('hintTextArea');
var currentCalcInput   = document.getElementById('currentCalcInput');
var currentCalcBtn     = document.getElementById('currentCalcBtn');
var currentCalcResult  = document.getElementById('currentCalcResult');
var currentAnswerInput = document.getElementById('currentAnswerInput');
var currentCheckBtn    = document.getElementById('currentCheckBtn');
var currentResultBadge = document.getElementById('currentResultBadge');
var hintWrapper        = document.getElementById('hintWrapper');
var hintToggleBtn      = document.getElementById('hintToggleBtn');
var hintDisplay        = document.getElementById('hintDisplay');
var reportModal        = document.getElementById('reportModal');
var studentName        = document.getElementById('studentName');
var studentClass       = document.getElementById('studentClass');
var generateReport     = document.getElementById('generateReport');
var cancelReport       = document.getElementById('cancelReport');
var imageModal         = document.getElementById('imageModal');
var modalImage         = document.getElementById('modalImage');
var closeImageModal    = document.getElementById('closeImageModal');

// ‚îÄ‚îÄ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function taskCount(){ return Object.keys(topicsData[currentTopic]?.tasks||{}).length||16; }

function ensureTask(){
    if(!topicsData[currentTopic].tasks) topicsData[currentTopic].tasks={};
    if(!topicsData[currentTopic].tasks[currentTaskId]) topicsData[currentTopic].tasks[currentTaskId]={};
}

window.showZoom = function(src){
    if(!src) return;
    modalImage.style.width=''; modalImage.style.height='';
    modalImage.onload=function(){
        var s=Math.min(window.innerWidth*.9/modalImage.naturalWidth, window.innerHeight*.9/modalImage.naturalHeight, 2);
        modalImage.style.width=Math.round(modalImage.naturalWidth*s)+'px'; modalImage.style.height='auto';
    };
    modalImage.src=src; imageModal.style.display='block';
};

// ‚îÄ‚îÄ –†–ï–ù–î–ï–† –ë–õ–û–ö–û–í (—Ä–µ–∂–∏–º —É—á–µ–Ω–∏–∫–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBlocksView(blocks, container){
    if(!blocks||!blocks.length){
        container.innerHTML='<span style="color:#aaa;font-size:13px;">–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</span>';
        return;
    }
    var html='<div class="blocks-render">';
    blocks.forEach(function(b){
        if(b.type==='text'){
            html+='<p>'+esc(b.content).replace(/\n/g,'<br>')+'</p>';
        } else if(b.type==='table'){
            html+='<table><tr>';
            b.headers.forEach(function(h){ html+='<th>'+esc(h)+'</th>'; });
            html+='</tr>';
            b.rows.forEach(function(row){ html+='<tr>'; row.forEach(function(c){ html+='<td>'+esc(c)+'</td>'; }); html+='</tr>'; });
            html+='</table>';
        } else if(b.type==='image'&&b.content){
            html+='<img src="'+b.content+'" onclick="showZoom(this.src)">';
        }
    });
    html+='</div>';
    container.innerHTML=html;
}

// ‚îÄ‚îÄ –†–ï–ñ–ò–ú–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var pendingLevel=null;

function setMode(level){
    accessLevel=level; pendingLevel=null;
    [switchTeacher,switchStudy,switchControl].forEach(function(b){ b.classList.remove('active-mode'); });
    if(level==='teacher')    switchTeacher.classList.add('active-mode');
    else if(level==='study') switchStudy.classList.add('active-mode');
    else                     switchControl.classList.add('active-mode');
    appContainer.classList.remove('teacher-mode','study-mode','control-mode');
    appContainer.classList.add(level+'-mode');
    hintWrapper.classList.toggle('hidden', level==='control');
    document.querySelectorAll('.teacher-only').forEach(function(el){ el.style.display=(level==='teacher')?'':'none'; });
    if(currentTaskId===0) renderCondition(); else renderCurrentTask();
}

var appContainer = document.getElementById('appContainer');

switchControl.addEventListener('click', function(){ setMode('control'); });
switchStudy.addEventListener('click', function(){
    if(accessLevel==='study') return;
    pendingLevel='study'; authPass.value=''; authModal.style.display='block'; setTimeout(function(){ authPass.focus(); },100);
});
switchTeacher.addEventListener('click', function(){
    if(accessLevel==='teacher') return;
    pendingLevel='teacher'; authPass.value=''; authModal.style.display='block'; setTimeout(function(){ authPass.focus(); },100);
});

authTeacher.addEventListener('click', function(){
    if(authPass.value===passwords.teacher){ authModal.style.display='none'; setMode('teacher'); }
    else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
});
authStudy.addEventListener('click', function(){
    if(authPass.value===passwords.study){ authModal.style.display='none'; setMode('study'); }
    else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
});
authControl.addEventListener('click', function(){ authModal.style.display='none'; setMode('control'); });
authPass.addEventListener('keydown', function(e){
    if(e.key!=='Enter') return;
    if(pendingLevel==='teacher'){ if(authPass.value===passwords.teacher){ authModal.style.display='none'; setMode('teacher'); } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); }
    else if(pendingLevel==='study'){ if(authPass.value===passwords.study){ authModal.style.display='none'; setMode('study'); } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); }
    else { authModal.style.display='none'; setMode('control'); }
});

// ‚îÄ‚îÄ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats(){
    if(!currentTopic||!progress[currentTopic]){
        statsCorrectSpan.innerText=statsIncorrectSpan.innerText=totalCorrectSpan.innerText=totalIncorrectSpan.innerText='0'; return;
    }
    var tp=progress[currentTopic]||{}, tc=taskCount(), correct=0, incorrect=0;
    for(var i=1;i<=tc;i++){ if(tp[i]?.status==='correct') correct++; else if(tp[i]?.status==='incorrect') incorrect++; }
    statsCorrectSpan.innerText=correct; statsIncorrectSpan.innerText=incorrect;
    totalCorrectSpan.innerText=tc; totalIncorrectSpan.innerText=tc;
    renderTaskGrid();
}

// ‚îÄ‚îÄ –¢–ï–ú–´ / –°–ï–¢–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTopicButtons(){
    if(!topics.length) return;
    var html='';
    topics.forEach(function(id){
        var t=topicsData[id]; if(!t) return;
        html+='<button class="topic-btn '+(id===currentTopic?'active':'')+'" data-topic="'+id+'">'+(t.icon||'üìÅ')+' '+(t.name||id)+'</button>';
    });
    topicContainer.innerHTML=html;
    document.querySelectorAll('.topic-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            currentTopic=btn.dataset.topic; currentTaskId=0;
            renderTopicButtons(); renderCondition(); renderTaskGrid(); updateStats();
        });
    });
}

function renderTaskGrid(){
    if(!currentTopic) return;
    var tp=progress[currentTopic]||{}, tc=taskCount();
    var html='<div class="task-square '+(currentTaskId===0?'active condition':'condition')+'" data-task-id="0">0</div>';
    for(var i=1;i<=tc;i++){
        var s=tp[i]?.status==='correct'?'correct':tp[i]?.status==='incorrect'?'incorrect':'';
        html+='<div class="task-square '+s+' '+(i===currentTaskId?'active':'')+'" data-task-id="'+i+'">'+i+'</div>';
    }
    taskGrid.innerHTML=html;
    document.querySelectorAll('.task-square').forEach(function(sq){
        sq.addEventListener('click', function(){
            var id=parseInt(sq.dataset.taskId); if(isNaN(id)) return;
            currentTaskId=id; renderTaskGrid();
            if(id===0) renderCondition(); else renderCurrentTask();
        });
    });
}

// ‚îÄ‚îÄ –£–°–õ–û–í–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCondition(){
    if(conditionCard) conditionCard.style.display='block';
    if(taskCard)      taskCard.style.display='none';
    if(conditionImageZone) conditionImageZone.style.display='none'; // –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã—Ç–∞, –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –±–ª–æ–∫–∞—Ö
    if(!currentTopic||!topicsData[currentTopic]) return;
    conditionTitle.innerText='–£—Å–ª–æ–≤–∏–µ: '+(topicsData[currentTopic].name||currentTopic);
    var blocks=(topicsData[currentTopic].condition||{}).blocks||[];
    if(accessLevel==='teacher'){
        conditionText.innerHTML='<div id="blockEditorContainer" class="block-editor"></div>';
        E.load(currentTopic, 0);
    } else {
        renderBlocksView(blocks, conditionText);
    }
}

// ‚îÄ‚îÄ –ó–ê–î–ê–ß–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCurrentTask(){
    if(!currentTopic||!topicsData[currentTopic]||currentTaskId===0) return;
    if(conditionCard) conditionCard.style.display='none';
    if(taskCard)      taskCard.style.display='block';
    if(currentImageZone) currentImageZone.style.display='none';
    var td=topicsData[currentTopic].tasks?.[currentTaskId]||{blocks:[],correct:'',hint:''};
    var tp=progress[currentTopic]?.[currentTaskId]||{answer:'',status:'none',hintShown:false};
    currentTaskTitle.innerText='–ó–∞–¥–∞–Ω–∏–µ '+currentTaskId;
    currentTopicBadge.innerText=topicsData[currentTopic].name||currentTopic;
    if(accessLevel==='teacher'){
        currentTaskDesc.innerHTML='<div id="blockEditorContainer" class="block-editor"></div>';
        E.load(currentTopic, currentTaskId);
        correctAnswerInput.value=td.correct||'';
        hintTextArea.value=td.hint||'';
    } else {
        renderBlocksView(td.blocks||[], currentTaskDesc);
    }
    currentAnswerInput.value=tp.answer||'';
    if(tp.status==='correct'){ currentResultBadge.innerHTML='‚úÖ –í–µ—Ä–Ω–æ'; currentResultBadge.style.background='#d4edda'; }
    else if(tp.status==='incorrect'){ currentResultBadge.innerHTML='‚ùå –ù–µ–≤–µ—Ä–Ω–æ'; currentResultBadge.style.background='#f8d7da'; }
    else { currentResultBadge.innerHTML='‚ö™ –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ'; currentResultBadge.style.background=''; }
    hintDisplay.innerText=td.hint||'–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    var showHint=tp.hintShown&&accessLevel!=='control';
    hintDisplay.classList.toggle('hidden',!showHint);
    hintToggleBtn.innerText=showHint?'üìñ –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É':'üìñ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
}

// ‚îÄ‚îÄ –û–¢–í–ï–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkAnswer(){
    if(!currentTopic||currentTaskId===0) return;
    var ua=currentAnswerInput.value.trim();
    var ca=topicsData[currentTopic].tasks?.[currentTaskId]?.correct||'';
    if(!progress[currentTopic]) progress[currentTopic]={};
    if(!progress[currentTopic][currentTaskId]) progress[currentTopic][currentTaskId]={};
    progress[currentTopic][currentTaskId].answer=ua;
    progress[currentTopic][currentTaskId].status=(ua===ca)?'correct':'incorrect';
    renderCurrentTask(); renderTaskGrid(); updateStats();
}

function toggleHint(){
    if(accessLevel==='control'||!currentTopic||currentTaskId===0) return;
    if(!progress[currentTopic]) progress[currentTopic]={};
    if(!progress[currentTopic][currentTaskId]) progress[currentTopic][currentTaskId]={};
    progress[currentTopic][currentTaskId].hintShown=!progress[currentTopic][currentTaskId].hintShown;
    renderCurrentTask();
}

// ‚îÄ‚îÄ –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
importFile.addEventListener('change', function(e){
    var file=e.target.files[0]; if(!file) return;
    var r=new FileReader();
    r.onload=function(ev){
        try {
            var data=JSON.parse(ev.target.result);
            if(data.version!=='2.0'){ alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω—É–∂–µ–Ω version: "2.0")'); return; }
            if(data.topicsData){ topicsData=data.topicsData; topics=Object.keys(topicsData); }
            if(data.progress)   progress=data.progress;
            if(data.passwords){ if(data.passwords.teacher) passwords.teacher=data.passwords.teacher; if(data.passwords.study) passwords.study=data.passwords.study; }
            if(topics.length>0){ currentTopic=topics[0]; currentTaskId=0; }
            renderTopicButtons(); renderCondition(); renderTaskGrid(); updateStats();
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        } catch(err){ alert('‚ùå –û—à–∏–±–∫–∞: '+err.message); }
    };
    r.readAsText(file); importFile.value='';
});

exportBtn.addEventListener('click', function(){
    if(accessLevel!=='teacher'){ alert('–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); return; }
    E.save(); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
    var blob=new Blob([JSON.stringify({version:'2.0',exported:new Date().toISOString(),topicsData:topicsData,progress:progress,passwords:passwords},null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download='oge_data_'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});

// ‚îÄ‚îÄ –û–¢–ß–Å–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
resultBtn.addEventListener('click', function(){
    if(accessLevel==='control'){ alert('–û—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Ç—Ä–æ–ª—è'); return; }
    studentName.value=localStorage.getItem('studentName')||'';
    studentClass.value=localStorage.getItem('studentClass')||'';
    reportModal.style.display='block';
});
generateReport.addEventListener('click', function(){
    var name=studentName.value.trim()||'–£—á–µ–Ω–∏–∫', cls=studentClass.value.trim()||'9';
    localStorage.setItem('studentName',name); localStorage.setItem('studentClass',cls);
    reportModal.style.display='none';
    var totC=0,totI=0,totU=0, results=[];
    topics.forEach(function(tid){
        var t=topicsData[tid]; if(!t) return;
        var tp=progress[tid]||{}, tc=Object.keys(t.tasks||{}).length||16;
        var c=0,i=0,u=0;
        for(var j=1;j<=tc;j++){ var s=tp[j]?.status; if(s==='correct'){c++;totC++;} else if(s==='incorrect'){i++;totI++;} else{u++;totU++;} }
        results.push({topic:t.name||tid,correct:c,incorrect:i,unanswered:u,total:tc,pct:Math.round(c/tc*100)});
    });
    var totalTasks=results.reduce(function(s,r){ return s+r.total; },0);
    var totalPct=totalTasks?Math.round(totC/totalTasks*100):0;
    var text='–û–¢–ß–ï–¢ –ü–û –í–´–ü–û–õ–ù–ï–ù–ò–Æ –ó–ê–î–ê–ù–ò–ô\n================================\n\n–£—á–µ–Ω–∏–∫: '+name+'\n–ö–ª–∞—Å—Å: '+cls+'\n–î–∞—Ç–∞: '+new Date().toLocaleString('ru-RU')+'\n\n–û–ë–©–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢:\n–í—Å–µ–≥–æ: '+totalTasks+' | ‚úÖ '+totC+' | ‚ùå '+totI+' | ‚ö™ '+totU+' | üìä '+totalPct+'%\n\n–ü–û –†–ê–ó–î–ï–õ–ê–ú:\n';
    results.forEach(function(r){ text+='\n'+r.topic+':\n  ‚úÖ '+r.correct+'/'+r.total+' ('+r.pct+'%)  ‚ùå '+r.incorrect+'  ‚ö™ '+r.unanswered+'\n'; });
    var blob=new Blob([text],{type:'text/plain;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=name+'_–æ—Ç—á–µ—Ç.txt';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});
cancelReport.addEventListener('click', function(){ reportModal.style.display='none'; });

// ‚îÄ‚îÄ –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
prevTaskBtn.addEventListener('click', function(){
    if(currentTaskId>0){ currentTaskId--; renderTaskGrid(); if(currentTaskId===0) renderCondition(); else renderCurrentTask(); }
});
nextTaskBtn.addEventListener('click', function(){
    if(currentTaskId<taskCount()){ currentTaskId++; renderTaskGrid(); renderCurrentTask(); }
});

correctAnswerInput.addEventListener('input', function(){
    if(accessLevel!=='teacher'||currentTaskId===0) return;
    ensureTask(); topicsData[currentTopic].tasks[currentTaskId].correct=correctAnswerInput.value;
});
hintTextArea.addEventListener('input', function(){
    if(accessLevel!=='teacher'||currentTaskId===0) return;
    ensureTask(); topicsData[currentTopic].tasks[currentTaskId].hint=hintTextArea.value;
});

currentCheckBtn.addEventListener('click', checkAnswer);
currentAnswerInput.addEventListener('keydown', function(e){ if(e.key==='Enter') checkAnswer(); });
hintToggleBtn.addEventListener('click', toggleHint);

currentCalcBtn.addEventListener('click', function(){
    var expr=currentCalcInput.value.replace(/[^0-9+\-*/().\s]/g,'');
    if(!expr) return;
    try { var res=new Function('return ('+expr+')')(); currentCalcResult.innerText=(res!=null)?Math.round(res*1000000)/1000000:'0'; }
    catch(e){ currentCalcResult.innerText='–û—à–∏–±–∫–∞'; }
});
currentCalcInput.addEventListener('keydown', function(e){ if(e.key==='Enter') currentCalcBtn.click(); });

closeImageModal.addEventListener('click', function(){ imageModal.style.display='none'; });
window.addEventListener('click', function(e){
    if(e.target===imageModal)  imageModal.style.display='none';
    if(e.target===reportModal) reportModal.style.display='none';
});

window.addEventListener('load', function(){ setMode('control'); });

})();
</script>
</body>
</html>