<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Python Runner + Tasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js"></script>

<style>
body {
    margin: 0;
    background: #0f172a;
    color: white;
    font-family: Segoe UI, Tahoma, sans-serif;
    padding: 12px;
}

.toolbar {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    padding: 8px;
    background: #1e293b;
    border-radius: 12px;
    position: relative;
}

.toolbar:hover {
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
}

.toolbar button:hover,
.toolbar input:hover,
.toolbar select:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

button, input, select {
    padding: 8px 12px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    transition: all 0.2s ease;
    position: relative;
    background: #334155;
    color: white;
}

select {
    background: #334155 !important;
    color: white !important;
}

select option {
    background: #1e293b;
    color: white;
}

button {
    cursor: pointer;
    background: #3b82f6;
    color: white;
    position: relative;
    overflow: hidden;
}

button::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.3);
    transform: skewX(-20deg);
    transition: left 0.3s;
}

button:active::after {
    left: 100%;
}

button.gray { background:#64748b; }
button.green { background:#10b981; }
button.red { background:#ef4444; }

button.active {
    outline: 3px solid #facc15;
}

button:hover::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1e293b;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    margin-bottom: 4px;
}

.color-thickness-group {
    display: flex;
    gap: 4px;
    align-items: center;
    position: relative;
}

.color-btn, .thickness-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 6px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.thickness-btn {
    background: #475569;
}

.thickness-btn.active {
    background: #facc15;
    color: #000;
}

#taskImage, #taskText {
    position: relative;
}

.no-draw-zone * {
    pointer-events: auto !important;
}

#taskImage {
    max-width: 100%;
    max-height: 240px;
    display: none;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 2px solid #334155;
    transform: scale(1.1);
    transform-origin: top left;
}

#taskText {
    display: none;
    margin-bottom: 10px;
    padding: 12px;
    background: #1e293b;
    border-radius: 8px;
    border: 2px solid #334155;
    white-space: pre-wrap;
    font-family: Consolas, monospace;
    font-size: 18px;
    max-height: 240px;
    overflow-y: auto;
}

#taskText .number {
    color: #ef4444;
    font-weight: bold;
}

.answer-section, .video-section {
    cursor: pointer;
    margin-top: 12px;
    padding: 8px;
    background: #1e293b;
    border-radius: 8px;
    border: 2px solid #334155;
    font-size: 16px;
}

.answer-section:hover, .video-section:hover {
    background: #334155;
}

#answerInput, #videoInput {
    width: 100%;
    margin-top: 12px;
    margin-bottom: 12px;
    font-size: 18px;
    padding: 10px;
    border-radius: 8px;
    display: none;
    box-sizing: border-box;
}

#videoInput {
    font-size: 16px;
    background: #1e293b;
    border: 2px solid #475569;
}

#videoInput.valid-link {
    color: #10b981 !important;
    background: linear-gradient(90deg, #1e293b 0%, #10b98120 100%);
    border-color: #10b981;
    cursor: pointer !important;
    text-decoration: none;
}

#videoInput.valid-link:hover {
    background: linear-gradient(90deg, #1e293b 0%, #10b98140 100%);
    text-decoration: underline;
}

.task-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.task-controls label {
    font-size: 14px;
    user-select: none;
}

.split-wrap {
    display: flex;
    width: 100%;
    margin-top: 10px;
}

.split-container {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: calc(100vh - 320px);
    gap: 0;
}

.code-panel, .output-panel {
    background: #020617;
    height: 100%;
    overflow: hidden;
}

.code-panel { border-radius: 10px 0 0 10px; }
.output-panel { border-radius: 0 10px 10px 0; }

textarea, #output {
    width: 100%;
    height: 100%;
    border: none;
    padding: 14px;
    font-family: Consolas, monospace;
    font-size: 20px;
    line-height: 1.5;
    background: #020617;
    color: #e5e7eb;
    box-sizing: border-box;
}

#code { border-radius: 10px 0 0 10px; resize: none; }

#output {
    border-radius: 0 10px 10px 0;
    white-space: pre-wrap;
    overflow-y: auto;
    color: #22c55e;
}

.gutter {
    cursor: col-resize;
    background: #334155;
    width: 6px;
    border-radius: 3px;
}

.gutter:hover {
    background: #facc15;
}

#drawCanvas {
    position: fixed;
    inset: 0;
    z-index: 1000;
    pointer-events: none;
}

.error { color:#ef4444; }

#taskFilter, #taskSelect {
    background: #334155;
    color: white;
}

#taskName.new-task {
    background: #10b981;
    color: white;
}
</style>
</head>

<body>

<div class="toolbar" id="toolbar">
    <button data-tooltip="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞" onclick="pasteImage()">üìã –£—Å–ª–æ–≤–∏–µ (img)</button>
    <button data-tooltip="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞" onclick="pasteText()">üìÑ –£—Å–ª–æ–≤–∏–µ (—Ç–µ–∫—Å—Ç)</button>

    <input id="taskName" placeholder="–ù–æ–≤–æ–µ –∏–º—è –∑–∞–¥–∞—á–∏" data-tooltip="–í–≤–µ–¥–∏—Ç–µ –∏–º—è ‚Üí Enter">
    
    <select id="taskFilter" data-tooltip="–§–∏–ª—å—Ç—Ä –∑–∞–¥–∞—á">
        <option value="all">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
        <option value="solved">‚úÖ –†–µ—à—ë–Ω–Ω—ã–µ</option>
        <option value="unsolved">‚è≥ –ù–µ—Ä–µ—à—ë–Ω–Ω—ã–µ</option>
    </select>

    <select id="taskSelect" data-tooltip="–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É" onchange="selectTask()">
        <option value="">‚Äî –∑–∞–¥–∞—á–∏ ‚Äî</option>
    </select>

    <button class="gray" data-tooltip="–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á –∏–∑ JSON" onclick="importTasks()">‚¨Ü –ò–º–ø–æ—Ä—Ç</button>
    <button class="gray" data-tooltip="–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á –≤ JSON" onclick="exportTasks()">‚¨á –≠–∫—Å–ø–æ—Ä—Ç</button>

    <button class="green" data-tooltip="–ó–∞–ø—É—Å—Ç–∏—Ç—å Python –∫–æ–¥" onclick="runPython()">‚ñ∂ Run</button>
    <button class="green" style="background:#ff9800" data-tooltip="–ü–æ—Å—Ç—Ä–æ—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è" onclick="startCodeAnimation()">üé¨ –ê–Ω–∏–º–∞—Ü–∏—è</button>
    <button class="gray" data-tooltip="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ –±—É—Ñ–µ—Ä" onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>

    <button id="drawBtn" data-tooltip="–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è (Esc=–≤—ã–∫–ª)" onclick="toggleDraw()">‚úèÔ∏è –†–∏—Å–æ–≤–∞–Ω–∏–µ</button>
    
    <div class="color-thickness-group">
        <button class="color-btn active" style="background:#ff0000" data-color="#ff0000" data-tooltip="–ö—Ä–∞—Å–Ω—ã–π">‚óè</button>
        <button class="color-btn" style="background:#00ff00" data-color="#00ff00" data-tooltip="–ó–µ–ª—ë–Ω—ã–π">‚óè</button>
        <button class="color-btn" style="background:#0000ff" data-color="#0000ff" data-tooltip="–°–∏–Ω–∏–π">‚óè</button>
        <button class="color-btn" style="background:#ffff00" data-color="#ffff00" data-tooltip="–ñ—ë–ª—Ç—ã–π">‚óè</button>
        <button class="color-btn" style="background:#ff00ff" data-color="#ff00ff" data-tooltip="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π">‚óè</button>
        <button class="color-btn" style="background:#00ffff" data-color="#00ffff" data-tooltip="–ì–æ–ª—É–±–æ–π">‚óè</button>
        <button class="color-btn" style="background:#ffffff" data-color="#ffffff" data-tooltip="–ë–µ–ª—ã–π">‚óè</button>
        <button class="color-btn" style="background:#ff8000" data-color="#ff8000" data-tooltip="–û—Ä–∞–Ω–∂–µ–≤—ã–π">‚óè</button>
        <button class="color-btn" style="background:#8000ff" data-color="#8000ff" data-tooltip="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ç—ë–º–Ω—ã–π">‚óè</button>
        <button class="color-btn" style="background:#ff4080" data-color="#ff4080" data-tooltip="–†–æ–∑–æ–≤—ã–π">‚óè</button>
    </div>

    <div class="color-thickness-group">
        <span style="font-size:12px; opacity:0.7;">–¢–æ–ª—â–∏–Ω–∞:</span>
        <button class="thickness-btn active" data-thickness="1" data-tooltip="1px">1</button>
        <button class="thickness-btn" data-thickness="3" data-tooltip="3px">3</button>
        <button class="thickness-btn" data-thickness="6" data-tooltip="6px">6</button>
        <button class="thickness-btn" data-thickness="12" data-tooltip="12px">12</button>
        <button class="thickness-btn" data-thickness="20" data-tooltip="20px">20</button>
    </div>

    <button class="gray" data-tooltip="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ" onclick="undo()">‚Ü© Undo</button>
    <button class="red" data-tooltip="–û—á–∏—Å—Ç–∏—Ç—å –≠–ö–†–ê–ù —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏" onclick="clearCurrentTaskCanvas()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<!-- ‚úÖ –ó–û–ù–ê –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø –†–ò–°–û–í–ê–ù–ò–Ø -->
<div class="no-draw-zone" id="noDrawZone">
    <div class="task-controls">
        <input type="checkbox" id="solvedCheckbox">
        <label for="solvedCheckbox">‚úÖ –†–µ—à–µ–Ω–æ</label>
    </div>

    <img id="taskImage">
    <div id="taskText"></div>

    <div class="answer-section" onclick="toggleAnswer()" id="answerToggle" data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç">
        üëÅÔ∏è –û—Ç–≤–µ—Ç
    </div>
    <input id="answerInput" placeholder="–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç">

    <div class="video-section" onclick="toggleVideo()" id="videoToggle" data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ">
        üé• –í–∏–¥–µ–æ—Ä–∞–∑–±–æ—Ä
    </div>
    <input id="videoInput" placeholder="https://youtube.com/watch?v=... –∏–ª–∏ –ª—é–±–∞—è —Å—Å—ã–ª–∫–∞">
</div>

<div class="split-wrap">
    <div class="split-container" id="splitContainer">
        <div class="code-panel" id="codePanel">
            <textarea id="code">print("–ü—Ä–∏–≤–µ—Ç, Python")</textarea>
        </div>
        <div class="output-panel" id="outputPanel">
            <div id="output">–ó–∞–≥—Ä—É–∑–∫–∞ Python‚Ä¶</div>
        </div>
    </div>
</div>

<canvas id="drawCanvas"></canvas>
<input type="file" id="importFile" accept=".json" hidden>

<script>
/* ================= PYTHON ================= */
let pyodide, ready=false;
let taskTextGlobal = "";
let currentColor = '#ff0000';
let currentThickness = 1;

let animationActive = false;
let animationLines = [];
let currentAnimLine = 0;
let animationSpeed = 20;
let animationInterval = null;
let lineElement = null;
let currentLineText = '';

async function initPy() {
    pyodide = await loadPyodide();
    ready = true;
    output.textContent = "Python –≥–æ—Ç–æ–≤.";
    
    pyodide.runPython(`
task_text = ""
def set_task_text(text):
    global task_text
    task_text = text
    print(f"üìÑ –¢–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
    `);
}
initPy();

window.addEventListener("load", () => {
    if (typeof Split !== "undefined") {
        Split(["#codePanel", "#outputPanel"], {
            sizes: [55, 45],
            minSize: [220, 220],
            gutterSize: 6,
            cursor: "col-resize"
        });
    }
});

async function runPython() {
    if (!ready) return;
    try {
        const escapedTaskText = JSON.stringify(taskTextGlobal);
        pyodide.runPython(`
import json
set_task_text(json.loads(${escapedTaskText}))
        `);
        
        pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
        `);
        pyodide.runPython(code.value);
        output.textContent = pyodide.runPython("sys.stdout.getvalue()") || "–ë–µ–∑ –≤—ã–≤–æ–¥–∞";
        output.className="";
    } catch (e) {
        output.textContent = e;
        output.className="error";
    }
}


function startCodeAnimation() {
    const codeText = code.value;
    if (!codeText.trim()) return alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥!');

    stopAnimation();
    animationLines = codeText.split('\n');
    currentAnimLine = 0;
    animationActive = true;

    output.innerHTML = '';
    output.style.whiteSpace = 'pre';
    output.style.color = '#e5e7eb';

    document.addEventListener('keydown', handleAnimationKey);
    processNextLine();
}

function stopAnimation() {
    animationActive = false;
    if (animationInterval) {
        clearTimeout(animationInterval);
        animationInterval = null;
    }
    document.removeEventListener('keydown', handleAnimationKey);
}

function handleAnimationKey(e) {
    if (!animationActive) return;
    if (e.key === 'Escape') return;
    e.preventDefault();

    if (animationInterval) {
        if (lineElement) {
            lineElement.innerHTML = highlightComment(currentLineText);
            clearTimeout(animationInterval);
            animationInterval = null;
            setTimeout(() => {
                if (animationActive) {
                    currentAnimLine++;
                    processNextLine();
                }
            }, 50);
        }
    } else {
        currentAnimLine++;
        processNextLine();
    }
}

function processNextLine() {
    if (!animationActive) return;
    if (currentAnimLine >= animationLines.length) {
        output.innerHTML += '\n\n‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
        output.style.color = '#22c55e';
        stopAnimation();
        return;
    }

    const line = animationLines[currentAnimLine];
    lineElement = document.createElement('div');
    lineElement.style.whiteSpace = 'pre';
    output.appendChild(lineElement);
    output.scrollTop = output.scrollHeight;

    const isCommentLine = line.trim().startsWith('#');
    if (isCommentLine) {
        lineElement.innerHTML = `<span style="color:#ff8c00;">${line}</span>`;
        setTimeout(() => {
            if (animationActive) {
                currentAnimLine++;
                processNextLine();
            }
        }, 50);
        return;
    }

    currentLineText = line;
    animateLine(lineElement, line);
}

function animateLine(element, fullLine) {
    let index = 0;
    element.innerHTML = '';

    const typeNext = () => {
        if (!animationActive) return;
        if (index < fullLine.length) {
            const currentText = fullLine.substring(0, index + 1);
            element.innerHTML = highlightComment(currentText);
            index++;
            output.scrollTop = output.scrollHeight;
            animationInterval = setTimeout(typeNext, animationSpeed);
        } else {
            animationInterval = null;
        }
    };

    typeNext();
}

function highlightComment(line) {
    const i = line.indexOf('#');
    if (i === -1) return line;
    return `${line.substring(0, i)}<span style="color:#ff8c00;">${line.substring(i)}</span>`;
}

/* ================= TEXT PASTE ================= */
async function pasteText() {
    try {
        const text = await navigator.clipboard.readText();
        taskTextGlobal = text;
        const taskTextDiv = document.getElementById("taskText");
        taskTextDiv.innerHTML = highlightNumbers(text);
        taskTextDiv.style.display = "block";
        document.getElementById("taskImage").style.display = "none";
        alert("‚úÖ –¢–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω!");
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞: " + e.message + "\\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è");
    }
}

function highlightNumbers(text) {
    const numberRegex = /\\b\\d+(?:\\.\\d+)?(?:[+%√ó√∑=‚â§‚â•<>]|—Ä—É–±|[a-zA-Z–∞-—è–ê-–Ø]{0,3})?\\b/g;
    return text.replace(numberRegex, '<span class="number">$&</span>');
}

/* ================= ANSWER & VIDEO TOGGLE ================= */
function toggleAnswer() {
    const answerInput = document.getElementById("answerInput");
    answerInput.style.display = answerInput.style.display === "none" ? "block" : "none";
}

function toggleVideo() {
    const videoInput = document.getElementById("videoInput");
    videoInput.style.display = videoInput.style.display === "none" ? "block" : "none";
    if (videoInput.style.display === "block") {
        setTimeout(() => validateVideoLink(videoInput), 10);
    }
}

/* ================= VIDEO LINK VALIDATION - –õ–Æ–ë–ê–Ø HTTPS –°–°–´–õ–ö–ê ================= */
function validateVideoLink(input) {
    const url = input.value.trim();
    // ‚úÖ –ü–†–û–í–ï–†–Ø–ï–ú –õ–Æ–ë–£–Æ HTTPS/HTTP –°–°–´–õ–ö–£
    const isValid = url.match(/https?:\/\//i);
    
    input.classList.toggle('valid-link', isValid);
    
    if (isValid) {
        input.style.cursor = 'pointer';
        input.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å: ' + url;
        // ‚úÖ –ù–ê–î–ï–ñ–ù–û–ï –û–¢–ö–†–´–¢–ò–ï –°–°–´–õ–ö–ò
        input.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            window.open(url, '_blank', 'noopener,noreferrer');
        };
    } else {
        input.style.cursor = 'text';
        input.title = '';
        input.onclick = null;
    }
}

const videoInput = document.getElementById("videoInput");
videoInput.addEventListener('input', () => validateVideoLink(videoInput));
videoInput.addEventListener('blur', () => validateVideoLink(videoInput));
videoInput.addEventListener('focus', () => validateVideoLink(videoInput));

/* ================= COPY ================= */
function copyCode() {
    navigator.clipboard.writeText(code.value).then(() => {
        alert("‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω:\\n" + code.value.split('\\n')[0]);
    }).catch(err => {
        alert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err);
    });
}

/* ================= TASKS ================= */
let tasks = [];
let current = -1;

function saveCurrentCanvasState() {
    if (current >= 0 && tasks[current]) {
        tasks[current].canvasState = canvas.toDataURL('image/png', 0.7);
        tasks[current].code = code.value;
        tasks[current].answer = answerInput.value;
        tasks[current].video = videoInput.value;
        tasks[current].text = taskTextGlobal;
        tasks[current].image = taskImage.src || "";
        tasks[current].solved = solvedCheckbox.checked;
        tasks[current].color = currentColor;
        tasks[current].thickness = currentThickness;
    }
}

function clearCurrentTaskCanvas() {
    history = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (current >= 0) {
        tasks[current].canvasState = "";
    }
}

function createNewTask() {
    const name = taskName.value.trim();
    if (!name) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏");
        return;
    }

    saveCurrentCanvasState();
    
    const canvasState = canvas.toDataURL('image/png', 0.7);
    
    const newTask = {
        name,
        code: code.value,
        answer: answerInput.value,
        video: videoInput.value,
        image: taskImage.src || "",
        text: taskTextGlobal,
        solved: solvedCheckbox.checked,
        canvasState: canvasState,
        color: currentColor,
        thickness: currentThickness
    };
    
    tasks.push(newTask);
    current = tasks.length - 1;
    taskName.value = "";
    taskName.placeholder = "–ù–æ–≤–æ–µ –∏–º—è –∑–∞–¥–∞—á–∏";
    taskName.classList.remove('new-task');
    
    updateSelect();
    showTask(current);
}

function updateSelect() {
    const filter = taskFilter.value;
    taskSelect.innerHTML = '<option value="">‚Äî –∑–∞–¥–∞—á–∏ ‚Äî</option>';
    
    tasks.forEach((t,i) => {
        if (filter === "all" || 
            (filter === "solved" && t.solved) || 
            (filter === "unsolved" && !t.solved)) {
            const o = document.createElement("option");
            o.value = i;
            o.textContent = `${t.solved ? "‚úÖ" : "‚è≥"} ${t.name}`;
            taskSelect.appendChild(o);
        }
    });
}

function showTask(i) {
    saveCurrentCanvasState();
    
    const t = tasks[i];
    current = i;
    
    code.value = t.code || "print('–ü—Ä–∏–≤–µ—Ç, Python')";
    taskName.value = t.name;
    taskName.placeholder = "–ò–º—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏";
    
    answerInput.value = t.answer || "";
    videoInput.value = t.video || "";
    solvedCheckbox.checked = t.solved || false;
    currentColor = t.color || '#ff0000';
    currentThickness = t.thickness || 1;
    
    // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –°–°–´–õ–ö–ò –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò –ó–ê–î–ê–ß–ò
    setTimeout(() => validateVideoLink(videoInput), 50);
    
    document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.thickness-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-color="${currentColor}"]`)?.classList.add('active');
    document.querySelector(`[data-thickness="${currentThickness}"]`)?.classList.add('active');
    
    history = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (t.canvasState) {
        const img = new Image();
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
            history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        };
        img.src = t.canvasState;
    }
    
    if (t.image) {
        taskImage.src = t.image;
        taskImage.style.display = "block";
        document.getElementById("taskText").style.display = "none";
        taskTextGlobal = "";
    } else if (t.text) {
        taskTextGlobal = t.text;
        document.getElementById("taskText").innerHTML = highlightNumbers(t.text);
        document.getElementById("taskText").style.display = "block";
        taskImage.style.display = "none";
    } else {
        taskImage.style.display = "none";
        document.getElementById("taskText").style.display = "none";
    }
    
    taskSelect.value = i;
    updateSolvedCheckbox();
}

function selectTask() {
    if (taskSelect.value !== "") {
        showTask(+taskSelect.value);
    }
}

function updateSolvedCheckbox() {
    solvedCheckbox.parentElement.style.background = solvedCheckbox.checked ? "#10b981" : "#1e293b";
}

solvedCheckbox.onchange = () => {
    if (current >= 0) {
        tasks[current].solved = solvedCheckbox.checked;
        updateSelect();
        updateSolvedCheckbox();
    }
};

taskFilter.onchange = updateSelect;

function exportTasks() {
    saveCurrentCanvasState();
    const blob = new Blob([JSON.stringify(tasks,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    const objectUrl = URL.createObjectURL(blob);
    a.href = objectUrl;
    a.download = "tasks.json";
    a.click();
    URL.revokeObjectURL(objectUrl);
}

function importTasks() { 
    importFile.click(); 
}
importFile.onchange = () => {
    if (!importFile.files[0]) return;
    const r = new FileReader();
    r.onload = () => {
        try {
            const imported = JSON.parse(r.result);
            if (!Array.isArray(imported)) {
                throw new Error("–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á");
            }

            const normalized = imported.map((task, idx) => {
                if (!task || typeof task !== 'object') {
                    throw new Error(`–ó–∞–¥–∞—á–∞ ‚Ññ${idx + 1} –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞`);
                }
                return {
                    name: task.name || `–ó–∞–¥–∞—á–∞ ${tasks.length + idx + 1}`,
                    code: task.code || "print('–ü—Ä–∏–≤–µ—Ç, Python')",
                    answer: task.answer || '',
                    video: task.video || '',
                    image: task.image || '',
                    text: task.text || '',
                    solved: Boolean(task.solved),
                    canvasState: task.canvasState || '',
                    color: task.color || '#ff0000',
                    thickness: Number.isFinite(Number(task.thickness)) ? Number(task.thickness) : 1
                };
            });

            saveCurrentCanvasState();
            const startIndex = tasks.length;
            tasks.push(...normalized);

            if (tasks.length > 0) {
                showTask(startIndex);
            }
            updateSelect();
            alert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${normalized.length} –∑–∞–¥–∞—á`);
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + e.message);
        }
    };
    r.readAsText(importFile.files[0]);
    importFile.value = '';
};

taskName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        createNewTask();
    }
});

taskName.addEventListener('focus', () => {
    if (current < 0 || !tasks[current]) {
        taskName.classList.add('new-task');
        taskName.placeholder = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è ‚Üí Enter";
    }
});

/* ================= –¶–í–ï–¢–ê –ò –¢–û–õ–©–ò–ù–ê ================= */
document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentColor = btn.dataset.color;
    });
});

document.querySelectorAll('.thickness-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.thickness-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentThickness = parseInt(btn.dataset.thickness);
    });
});

/* ================= IMAGE ================= */
async function pasteImage() {
    try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
            for (const type of item.types) {
                if (type.startsWith("image/")) {
                    const blob = await item.getType(type);
                    const reader = new FileReader();
                    reader.onload = () => {
                        taskImage.src = reader.result;
                        taskImage.style.display = "block";
                        document.getElementById("taskText").style.display = "none";
                        taskTextGlobal = "";
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        }
        alert("–í –±—É—Ñ–µ—Ä–µ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞: " + e.message);
    }
}

/* ================= CANVAS ================= */
const canvas = drawCanvas;
const ctx = canvas.getContext("2d");
let drawEnabled=false, drawing=false, history=[];

function resize() {
    canvas.width = innerWidth;
    canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

function toggleDraw() {
    drawEnabled = !drawEnabled;
    canvas.style.pointerEvents = drawEnabled ? "auto" : "none";
    drawBtn.classList.toggle("active", drawEnabled);
    drawBtn.title = drawEnabled ? "–†–∏—Å–æ–≤–∞–Ω–∏–µ –í–ö–õ (Esc=–≤—ã–∫–ª)" : "–†–∏—Å–æ–≤–∞–Ω–∏–µ –í–´–ö–õ";
}

// ‚úÖ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –†–ò–°–û–í–ê–ù–ò–Ø
const toolbar = document.getElementById('toolbar');
const noDrawZone = document.getElementById('noDrawZone');

toolbar.addEventListener('mouseenter', () => {
    if (drawEnabled) {
        toggleDraw();
        drawBtn.title = "–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ (toolbar)";
    }
});

noDrawZone.addEventListener('mouseenter', () => {
    if (drawEnabled) {
        toggleDraw();
        drawBtn.title = "–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ (—É—Å–ª–æ–≤–∏–µ)";
    }
});

toolbar.addEventListener('mouseleave', () => {
    drawBtn.title = drawEnabled ? "–†–∏—Å–æ–≤–∞–Ω–∏–µ –í–ö–õ (Esc=–≤—ã–∫–ª)" : "–†–∏—Å–æ–≤–∞–Ω–∏–µ –í–´–ö–õ";
});

canvas.addEventListener("pointerdown", e => {
    if (!drawEnabled) return;
    drawing = true;
    history.push(ctx.getImageData(0,0,canvas.width,canvas.height));
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentThickness;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.beginPath();
    ctx.moveTo(e.clientX, e.clientY);
});

canvas.addEventListener("pointermove", e => {
    if (!drawing) return;
    ctx.lineTo(e.clientX, e.clientY);
    ctx.stroke();
});

canvas.addEventListener("pointerup", () => drawing=false);
canvas.addEventListener("pointerleave", () => drawing=false);

function undo() {
    if (history.length) ctx.putImageData(history.pop(),0,0);
}

document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
        if (drawEnabled) toggleDraw();
        if (animationActive) {
            stopAnimation();
            output.innerHTML += "\n\n‚è∏Ô∏è –ê–Ω–∏–º–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
        }
    }
});

/* ================= PYTHON INDENT ================= */
const TAB="    ";
code.addEventListener("keydown", e => {
    const s = code.selectionStart;
    const v = code.value;

    if (e.key === "Tab") {
        e.preventDefault();
        code.value = v.slice(0,s)+TAB+v.slice(code.selectionEnd);
        code.selectionStart = code.selectionEnd = s+4;
    }

    if (e.key === "Enter") {
        e.preventDefault();
        const ls = v.lastIndexOf("\\n",s-1)+1;
        let ind = (v.slice(ls,s).match(/^\\s*/)||[""])[0];
        if (v.slice(ls,s).trim().endsWith(":")) ind += TAB;
        code.value = v.slice(0,s)+"\\n"+ind+v.slice(s);
        code.selectionStart = code.selectionEnd = s+1+ind.length;
    }
});
</script>

</body>
</html>
