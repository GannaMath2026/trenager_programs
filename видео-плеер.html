<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–µ–µ—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–Ω–æ–π –º–∞—à–∏–Ω–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { padding: 20px; display: flex; justify-content: center; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        body.theme-dark { background: #0f172a; color: #e2e8f0; }
        body.theme-light { background: #f8fafc; color: #1e293b; }
        .container { max-width: 1400px; width: 100%; border-radius: 24px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); transition: background 0.3s; }
        .theme-dark .container { background: #1e293b; }
        .theme-light .container { background: #ffffff; }
        h1 { margin: 0 0 10px; font-size: 28px; display: flex; align-items: center; gap: 10px; }
        .theme-dark h1 { color: #f1f5f9; }
        .theme-light h1 { color: #0f172a; }
        .top-bar { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .mode-switch { display: flex; gap: 10px; background: #334155; padding: 5px; border-radius: 40px; width: fit-content; }
        .mode-btn { padding: 10px 25px; border: none; border-radius: 40px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .theme-dark .mode-btn { background: transparent; color: #cbd5e1; }
        .theme-light .mode-btn { background: transparent; color: #475569; }
        .mode-btn.active { background: #3b82f6; color: white; box-shadow: 0 4px 12px #3b82f680; }
        .theme-switch { display: flex; gap: 5px; }
        .theme-btn { padding: 8px 16px; border: none; border-radius: 30px; cursor: pointer; font-weight: 600; }
        .theme-dark .theme-btn { background: #334155; color: #e2e8f0; }
        .theme-light .theme-btn { background: #e2e8f0; color: #1e293b; }
        .theme-btn.active { background: #3b82f6; color: white; }
        
        .main-panel { display: flex; gap: 20px; }
        .editor-panel { flex: 2; border-radius: 20px; padding: 20px; }
        .theme-dark .editor-panel { background: #0f172a; }
        .theme-light .editor-panel { background: #f1f5f9; }
        .preview-panel { flex: 1; border-radius: 20px; padding: 20px; position: sticky; top: 20px; height: fit-content; max-height: 80vh; overflow-y: auto; }
        .theme-dark .preview-panel { background: #0f172a; }
        .theme-light .preview-panel { background: #f1f5f9; }
        .preview-panel h3 { margin-bottom: 15px; }
        .theme-dark .preview-panel h3 { color: #94a3b8; }
        .theme-light .preview-panel h3 { color: #475569; }
        .preview-content { border-radius: 12px; padding: 15px; font-size: 0.9rem; overflow-y: auto; max-height: 70vh; }
        .theme-dark .preview-content { background: #1e293b; }
        .theme-light .preview-content { background: #ffffff; }
        .preview-content .stage { margin-bottom: 20px; }
        .preview-content img { max-width: 100%; border-radius: 8px; }
        
        /* –ü–ª–µ–µ—Ä */
        .player-area {
            border: 2px solid #334155;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            background: #0f172a;
        }
        .theme-light .player-area { background: #f8fafc; border-color: #cbd5e1; }
        .player-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .player-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 30px;
            background: #3b82f6;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .player-controls button:hover { background: #2563eb; }
        .player-controls button.secondary { background: #475569; }
        .player-controls button.secondary:hover { background: #334155; }
        .player-controls .speed-select {
            padding: 6px 12px;
            border-radius: 20px;
            background: #1e293b;
            color: white;
            border: 1px solid #3b82f6;
        }
        .player-slider {
            flex: 1;
            min-width: 200px;
        }
        .player-slider input {
            width: 100%;
            cursor: pointer;
        }
        .player-content {
            background: #0f172a;
            border-radius: 16px;
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            border: 1px solid #334155;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
        }
        .theme-light .player-content { background: #ffffff; border-color: #cbd5e1; }
        .player-line {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            transition: background 0.2s, opacity 0.2s;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .player-line.current-line {
            background: #1e293b;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .theme-light .player-line.current-line { background: #e2e8f0; border-left-color: #3b82f6; }
        .player-line.past-line { opacity: 0.7; }
        .player-line.future-line { opacity: 0.5; }
        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #3b82f6;
            vertical-align: middle;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .placeholder-stage {
            background: #334155;
            color: #94a3b8;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            font-style: italic;
            margin: 10px 0;
        }
        
        button { padding: 8px 20px; border: none; border-radius: 40px; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px #00000030; }
        .theme-dark button { background: #3b82f6; color: white; }
        .theme-light button { background: #3b82f6; color: white; }
        button:hover { background: #2563eb; }
        button.secondary { background: #475569; }
        button.secondary:hover { background: #334155; }
        
        .block-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .block-list { border-radius: 16px; padding: 15px; max-height: 400px; overflow-y: auto; }
        .theme-dark .block-list { background: #1e293b; }
        .theme-light .block-list { background: #ffffff; }
        .block-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; margin-bottom: 8px; flex-wrap: wrap; }
        .theme-dark .block-item { background: #334155; }
        .theme-light .block-item { background: #f1f5f9; }
        .block-type { width: 80px; font-weight: 700; color: #3b82f6; }
        .block-preview { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .theme-dark .block-preview { color: #cbd5e1; }
        .theme-light .block-preview { color: #334155; }
        .block-item button { padding: 4px 10px; font-size: 0.8rem; background: #1e293b; color: #e2e8f0; margin: 2px; }
        
        .import-export { margin-top: 20px; padding: 15px; border-radius: 16px; }
        .theme-dark .import-export { background: #1e293b; }
        .theme-light .import-export { background: #ffffff; }
        textarea { width: 100%; height: 120px; padding: 10px; border-radius: 12px; border: 1px solid #475569; font-family: monospace; }
        .theme-dark textarea { background: #0f172a; color: #e2e8f0; }
        .theme-light textarea { background: #f8fafc; color: #1e293b; }
        .stats { font-size: 0.9rem; margin: 5px 0; }
        .theme-dark .stats { color: #94a3b8; }
        .theme-light .stats { color: #475569; }
        .footer { margin-top: 20px; font-size: 0.85rem; text-align: center; }
        .theme-dark .footer { color: #64748b; }
        .theme-light .footer { color: #94a3b8; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #00000080; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 24px; width: 500px; max-width: 90%; }
        .modal-content textarea { width: 100%; height: 150px; margin: 15px 0; }
    </style>
</head>
<body class="theme-dark">
<div class="container">
    <div class="top-bar">
        <h1>üì∫ –ü–ª–µ–µ—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–Ω–æ–π –º–∞—à–∏–Ω–∫–∏</h1>
        <div class="theme-switch">
            <button class="theme-btn active" onclick="setTheme('dark')">üåô –¢—ë–º–Ω–∞—è</button>
            <button class="theme-btn" onclick="setTheme('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
        </div>
    </div>
    
    <div class="mode-switch">
        <button class="mode-btn active" id="modeEditBtn" onclick="setMode('edit')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        <button class="mode-btn" id="modeDemoBtn" onclick="setMode('demo')">‚ñ∂Ô∏è –ü–ª–µ–µ—Ä</button>
    </div>

    <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞ -->
    <div id="editorMode" style="display: flex; gap: 20px;">
        <div class="editor-panel">
            <div class="block-actions">
                <button onclick="addTextBlock()">‚ûï –¢–µ–∫—Å—Ç</button>
                <button onclick="addFormulaBlock()">üìê –§–æ—Ä–º—É–ª–∞</button>
                <button onclick="addImageBlock()">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (Ctrl+V)</button>
                <button onclick="addPlaceholderBlock()">‚¨ú –ó–∞–≥–ª—É—à–∫–∞</button>
                <button class="danger" onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div class="block-list" id="blockList">
                <h3>–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è</h3>
                <div id="blocksContainer"></div>
            </div>
            
            <div class="import-export">
                <h3>–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</h3>
                <textarea id="jsonArea" placeholder='[{"type":"text","content":"..."}, ...]'></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button onclick="exportJSON()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
                    <button onclick="importJSON()">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
                    <button onclick="exportToFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
                    <button onclick="importFromFile()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞ -->
        <div class="preview-panel">
            <h3>üîç –ü—Ä–µ–≤—å—é —Ä–µ—à–µ–Ω–∏—è</h3>
            <div class="preview-content" id="previewContent"></div>
        </div>
    </div>

    <!-- –†–µ–∂–∏–º –ø–ª–µ–µ—Ä–∞ -->
    <div id="demoMode" style="display: none;">
        <div class="player-area">
            <div class="player-controls">
                <button onclick="play()" id="playBtn">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                <button onclick="pause()" id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                <button onclick="prevStep()">‚è™ –ü—Ä–µ–¥</button>
                <button onclick="nextStep()">‚è© –°–ª–µ–¥</button>
                <select class="speed-select" id="speedSelect" onchange="changeSpeed()">
                    <option value="1">1 —Å–∏–º/—Å–µ–∫</option>
                    <option value="2">2 —Å–∏–º/—Å–µ–∫</option>
                    <option value="4">4 —Å–∏–º/—Å–µ–∫</option>
                    <option value="8">8 —Å–∏–º/—Å–µ–∫</option>
                    <option value="16">16 —Å–∏–º/—Å–µ–∫</option>
                    <option value="9999">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</option>
                </select>
                <div class="player-slider">
                    <input type="range" id="playerSlider" min="0" max="0" value="0" step="1" oninput="sliderChange()">
                </div>
                <span class="stats" id="lineCounter">0 / 0</span>
            </div>
            <div class="player-content" id="playerContent"></div>
        </div>
    </div>

    <div class="footer">
        <p>–°—Ç—Ä–æ–∫–∏ –ø–µ—á–∞—Ç–∞—é—Ç—Å—è –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ. –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è. –ë–µ–≥—É–Ω–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π.</p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <h3>üìã –í—Å—Ç–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        <p>–ù–∞–∂–º–∏—Ç–µ Ctrl+V, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞.</p>
        <textarea id="imagePasteArea" placeholder="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeImageModal()">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="processPastedImage()">–í—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    // ---------- –ë–ª–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∏ —Ä–µ—à–µ–Ω–∏—è) ----------
    let blocks = [];
    let currentIndex = 0; // —Ç–µ–∫—É—â–∞—è –ø–µ—á–∞—Ç–∞–µ–º–∞—è —Å—Ç—Ä–æ–∫–∞
    let currentMode = 'edit';
    let currentTheme = 'dark';
    let playInterval = null;
    let charSpeed = 4; // —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4)

    // –î–ª—è –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏ —Ö—Ä–∞–Ω–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ (—Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ)
    let lineProgress = {}; // –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤

    // –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    const defaultBlocks = [
        { type: 'text', content: '–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–æ–º–µ—Ä 1' },
        { type: 'text', content: '–ê —ç—Ç–æ –≤—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞, –æ–Ω–∞ –Ω–µ–º–Ω–æ–≥–æ –¥–ª–∏–Ω–Ω–µ–µ, —á–µ–º –ø–µ—Ä–≤–∞—è' },
        { type: 'text', content: '–¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞ —Å —Ñ–æ—Ä–º—É–ª–æ–π: $x^2 + y^2 = z^2$ (–Ω–æ –ø–æ–∫–∞ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º)' },
        { type: 'text', content: '–ò —á–µ—Ç–≤—ë—Ä—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –±—ã–ª–æ –±–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫.' },
        { type: 'text', content: '–ü—è—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.' },
        { type: 'placeholder', content: '–ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã—Ç—å –≤–∞—à–∞ —Ä–µ–∫–ª–∞–º–∞ –∏–ª–∏ —Ä–∏—Å—É–Ω–æ–∫.' }
    ];

    init();

    function init() {
        blocks = JSON.parse(JSON.stringify(defaultBlocks));
        currentIndex = 0;
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ 0, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–Ω–∞—è –¥–ª–∏–Ω–∞
        blocks.forEach((_, idx) => {
            lineProgress[idx] = (idx === 0) ? 0 : blocks[idx].content.length;
        });
        renderBlockList();
        updatePreview();
        updatePlayer();
        updateCounter();
        document.getElementById('playerSlider').max = blocks.length - 1;
    }

    // ---------- –¢–µ–º–∞ ----------
    function setTheme(theme) {
        currentTheme = theme;
        document.body.className = theme === 'dark' ? 'theme-dark' : 'theme-light';
        document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
        if (theme === 'dark') document.querySelector('.theme-btn:nth-child(1)').classList.add('active');
        else document.querySelector('.theme-btn:nth-child(2)').classList.add('active');
    }

    // ---------- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –±–ª–æ–∫–æ–≤ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ ----------
    function renderBlockList() {
        const container = document.getElementById('blocksContainer');
        container.innerHTML = '';
        blocks.forEach((block, idx) => {
            const div = document.createElement('div');
            div.className = 'block-item';
            let typeIcon = '';
            if (block.type === 'text') typeIcon = 'üìÑ';
            else if (block.type === 'formula') typeIcon = 'üìê';
            else if (block.type === 'image') typeIcon = 'üñºÔ∏è';
            else if (block.type === 'placeholder') typeIcon = '‚¨ú';
            
            let preview = block.content;
            if (block.type === 'image') preview = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (base64)';
            else if (block.type === 'placeholder') preview = '–ó–∞–≥–ª—É—à–∫–∞: ' + block.content.substring(0, 30);
            else preview = block.content.substring(0, 40) + (block.content.length>40?'...':'');
            
            div.innerHTML = `
                <span class="block-type">${typeIcon} ${block.type}</span>
                <span class="block-preview">${preview}</span>
                <div style="display: flex; flex-wrap: wrap;">
                    <button onclick="insertAfter(${idx})">‚ûï –ø–æ—Å–ª–µ</button>
                    <button onclick="editBlock(${idx})">‚úèÔ∏è</button>
                    <button onclick="deleteBlock(${idx})">‚ùå</button>
                    <button onclick="moveBlock(${idx}, 'up')">‚¨ÜÔ∏è</button>
                    <button onclick="moveBlock(${idx}, 'down')">‚¨áÔ∏è</button>
                    <button onclick="moveBlock(${idx}, 'top')">‚è´</button>
                    <button onclick="moveBlock(${idx}, 'bottom')">‚è¨</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ---------- –í—Å—Ç–∞–≤–∫–∞ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ ----------
    function insertAfter(index) {
        const type = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –±–ª–æ–∫–∞ (text, formula, image, placeholder):', 'text');
        if (!type) return;
        if (type === 'image') {
            openImageModal((content) => {
                const newBlock = { type, content };
                blocks.splice(index + 1, 0, newBlock);
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ index —Å–¥–≤–∏–≥–∞—é—Ç—Å—è, –Ω–æ–≤—ã–µ –∏–º–µ—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å = –ø–æ–ª–Ω–∞—è –¥–ª–∏–Ω–∞ (–æ–Ω–∏ –Ω–µ —Ç–µ–∫—É—â–∏–µ)
                rebuildLineProgressAfterInsert(index + 1);
                renderBlockList();
                updatePreview();
                updatePlayer();
                document.getElementById('playerSlider').max = blocks.length - 1;
            });
        } else if (type === 'placeholder') {
            const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–≥–ª—É—à–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ—Å—Ç–æ –¥–ª—è —Ä–∏—Å—É–Ω–∫–∞"):');
            if (content === null) return;
            blocks.splice(index + 1, 0, { type, content });
            rebuildLineProgressAfterInsert(index + 1);
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        } else {
            const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞:');
            if (content === null) return;
            blocks.splice(index + 1, 0, { type, content });
            rebuildLineProgressAfterInsert(index + 1);
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        }
    }

    // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç lineProgress –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é pos
    function rebuildLineProgressAfterInsert(pos) {
        const newProgress = {};
        for (let i = 0; i < blocks.length; i++) {
            if (i < pos) {
                newProgress[i] = lineProgress[i] !== undefined ? lineProgress[i] : blocks[i].content.length;
            } else if (i === pos) {
                // –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∞—è (pos == currentIndex) —Å—Ç–∞–≤–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å 0, –∏–Ω–∞—á–µ –ø–æ–ª–Ω–∞—è –¥–ª–∏–Ω–∞
                newProgress[i] = (i === currentIndex) ? 0 : blocks[i].content.length;
            } else {
                // –°—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–≤–∏–Ω—É–ª–∏—Å—å
                newProgress[i] = lineProgress[i-1] !== undefined ? lineProgress[i-1] : blocks[i].content.length;
            }
        }
        lineProgress = newProgress;
    }

    // ---------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ (–≤ –∫–æ–Ω–µ—Ü) ----------
    function addTextBlock() {
        const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞:');
        if (content !== null) {
            blocks.push({ type: 'text', content });
            lineProgress[blocks.length-1] = blocks.length-1 === currentIndex ? 0 : content.length;
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        }
    }

    function addFormulaBlock() {
        const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É LaTeX (–±–µ–∑ \\[\\]):');
        if (content !== null) {
            blocks.push({ type: 'formula', content });
            lineProgress[blocks.length-1] = blocks.length-1 === currentIndex ? 0 : content.length;
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        }
    }

    function addImageBlock() {
        openImageModal((content) => {
            blocks.push({ type: 'image', content });
            lineProgress[blocks.length-1] = blocks.length-1 === currentIndex ? 0 : 1; // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–∏–∫–æ–º (–ø—Ä–æ–≥—Ä–µ—Å—Å 1 –∫–∞–∫ —Ñ–ª–∞–≥)
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        });
    }

    function addPlaceholderBlock() {
        const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–≥–ª—É—à–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ—Å—Ç–æ –¥–ª—è —Ä–∏—Å—É–Ω–∫–∞"):');
        if (content !== null) {
            blocks.push({ type: 'placeholder', content });
            lineProgress[blocks.length-1] = blocks.length-1 === currentIndex ? 0 : content.length;
            renderBlockList();
            updatePreview();
            updatePlayer();
            document.getElementById('playerSlider').max = blocks.length - 1;
        }
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Ctrl+V
    let imageCallback = null;
    function openImageModal(callback) {
        imageCallback = callback;
        const modal = document.getElementById('imageModal');
        const textarea = document.getElementById('imagePasteArea');
        textarea.value = '';
        modal.style.display = 'flex';
        textarea.focus();
        textarea.addEventListener('paste', handlePaste);
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
        imageCallback = null;
    }

    function handlePaste(e) {
        const items = (e.clipboardData || window.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') === 0) {
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('imagePasteArea').value = event.target.result;
                };
                reader.readAsDataURL(blob);
                e.preventDefault();
                break;
            }
        }
    }

    function processPastedImage() {
        const content = document.getElementById('imagePasteArea').value;
        if (content && imageCallback) {
            imageCallback(content);
            closeImageModal();
        } else {
            alert('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–Ω–∞—á–∞–ª–∞.');
        }
    }

    // ---------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / —É–¥–∞–ª–µ–Ω–∏–µ / –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ ----------
    function editBlock(index) {
        const block = blocks[index];
        if (block.type === 'image') {
            alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º. –£–¥–∞–ª–∏—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ.');
            return;
        }
        const newContent = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:', block.content);
        if (newContent !== null) {
            block.content = newContent;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–µ–∫—É—â–∞—è
            if (index === currentIndex) {
                lineProgress[index] = 0;
            } else {
                lineProgress[index] = newContent.length;
            }
            renderBlockList();
            updatePreview();
            updatePlayer();
        }
    }

    function deleteBlock(index) {
        blocks.splice(index, 1);
        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º lineProgress
        const newProgress = {};
        for (let i = 0; i < blocks.length; i++) {
            newProgress[i] = lineProgress[i+1] !== undefined ? lineProgress[i+1] : blocks[i].content.length;
        }
        lineProgress = newProgress;
        if (currentIndex >= blocks.length) currentIndex = Math.max(0, blocks.length - 1);
        renderBlockList();
        updatePreview();
        updatePlayer();
        document.getElementById('playerSlider').max = blocks.length - 1;
        updateCounter();
    }

    function moveBlock(index, direction) {
        // –ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º lineProgress (–æ–ø—É—Å—Ç–∏–º –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)
        alert('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏ –ø–µ—á–∞—Ç–∏.');
    }

    function clearAll() {
        blocks = [];
        currentIndex = 0;
        lineProgress = {};
        renderBlockList();
        updatePreview();
        updatePlayer();
        document.getElementById('playerSlider').max = 0;
        updateCounter();
    }

    // ---------- –ü–ª–µ–µ—Ä: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–µ—á–∞—Ç–∏ ----------
    function updatePlayer() {
        const container = document.getElementById('playerContent');
        if (blocks.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8;">–ù–µ—Ç —Å—Ç—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.</p>';
            return;
        }
        let html = '';
        for (let i = 0; i < blocks.length; i++) {
            const block = blocks[i];
            let lineClass = 'player-line';
            if (i === currentIndex) lineClass += ' current-line';
            else if (i < currentIndex) lineClass += ' past-line';
            else lineClass += ' future-line';
            
            if (block.type === 'text' || block.type === 'formula' || block.type === 'placeholder') {
                let text = block.content;
                let progress = lineProgress[i] !== undefined ? lineProgress[i] : text.length;
                let displayedText = text.substring(0, progress);
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—É—â–∞—è –∏ –µ—â—ë –Ω–µ –¥–æ–ø–µ—á–∞—Ç–∞–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
                if (i === currentIndex && progress < text.length) {
                    html += `<div class="${lineClass}">${displayedText}<span class="cursor"></span></div>`;
                } else {
                    html += `<div class="${lineClass}">${displayedText}</div>`;
                }
            } else if (block.type === 'image') {
                // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–∏–∫–æ–º, –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å > 0
                if (lineProgress[i] > 0) {
                    html += `<div class="${lineClass}"><img src="${block.content}" alt="–≥—Ä–∞—Ñ–∏–∫" style="max-width:100%; max-height:300px;"></div>`;
                } else {
                    html += `<div class="${lineClass}">[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...]</div>`;
                }
            }
        }
        container.innerHTML = html;
        // –î–ª—è —Ñ–æ—Ä–º—É–ª –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º MathJax, —Ç.–∫. –æ–Ω–∏ –ø–æ–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–µ
        const lines = container.querySelectorAll('.player-line');
        if (lines.length > 0 && currentIndex < lines.length) {
            const currentLine = lines[currentIndex];
            const containerRect = container.getBoundingClientRect();
            const lineRect = currentLine.getBoundingClientRect();
            const scrollTop = currentLine.offsetTop - (containerRect.height / 2) + (lineRect.height / 2);
            container.scrollTo({ top: scrollTop, behavior: 'smooth' });
        }
    }

    function updatePreview() {
        const preview = document.getElementById('previewContent');
        if (blocks.length === 0) {
            preview.innerHTML = '<p style="color: #94a3b8;">–ù–µ—Ç –±–ª–æ–∫–æ–≤</p>';
            return;
        }
        let html = '';
        for (let i = 0; i <= Math.min(currentIndex, blocks.length-1); i++) {
            const block = blocks[i];
            if (block.type === 'text' || block.type === 'formula' || block.type === 'placeholder') {
                html += `<div class="stage">${block.content.length > 50 ? block.content.substring(0,50)+'‚Ä¶' : block.content}</div>`;
            } else if (block.type === 'image') {
                html += `<div class="stage"><img src="${block.content}" style="max-width:100%; max-height:100px;"></div>`;
            }
        }
        preview.innerHTML = html;
        MathJax.typesetPromise([preview]).catch(err => console.log(err));
    }

    function updateCounter() {
        document.getElementById('lineCounter').innerText = blocks.length ? `${currentIndex+1} / ${blocks.length}` : '0 / 0';
    }

    // ---------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–æ–º ----------
    function play() {
        if (playInterval) clearInterval(playInterval);
        playInterval = setInterval(() => {
            // –ü–µ—á–∞—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
            if (currentIndex < blocks.length) {
                const block = blocks[currentIndex];
                const maxLen = block.content.length;
                let progress = lineProgress[currentIndex] || 0;
                if (progress < maxLen) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª
                    lineProgress[currentIndex] = progress + 1;
                    updatePlayer();
                } else {
                    // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ø–µ—á–∞—Ç–∞–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (currentIndex < blocks.length - 1) {
                        currentIndex++;
                        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0
                        if (lineProgress[currentIndex] === undefined) {
                            lineProgress[currentIndex] = 0;
                        }
                        document.getElementById('playerSlider').value = currentIndex;
                        updatePlayer();
                        updateCounter();
                    } else {
                        // –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü
                        pause();
                    }
                }
            }
        }, 1000 / charSpeed);
    }

    function pause() {
        if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
        }
    }

    function nextStep() {
        pause();
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –¥–æ–ø–µ—á–∞—Ç–∞–Ω–∞, –¥–æ–ø–µ—á–∞—Ç—ã–≤–∞–µ–º –µ—ë –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if (currentIndex < blocks.length) {
            const block = blocks[currentIndex];
            lineProgress[currentIndex] = block.content.length;
            // –ó–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (currentIndex < blocks.length - 1) {
                currentIndex++;
                lineProgress[currentIndex] = 0; // –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—á–∞—Ç–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –Ω—É–ª—è
            }
            document.getElementById('playerSlider').value = currentIndex;
            updatePlayer();
            updateCounter();
        }
    }

    function prevStep() {
        pause();
        if (currentIndex > 0) {
            currentIndex--;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–æ–≤–æ–π —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –Ω–∞ 0
            lineProgress[currentIndex] = 0;
            document.getElementById('playerSlider').value = currentIndex;
            updatePlayer();
            updateCounter();
        }
    }

    function changeSpeed() {
        const speed = parseFloat(document.getElementById('speedSelect').value);
        charSpeed = speed;
        if (playInterval) {
            pause();
            play();
        }
    }

    function sliderChange() {
        pause();
        const newIndex = parseInt(document.getElementById('playerSlider').value);
        if (newIndex >= 0 && newIndex < blocks.length) {
            currentIndex = newIndex;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –Ω–æ–≤–æ–π —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –Ω–∞ 0
            lineProgress[currentIndex] = 0;
            updatePlayer();
            updateCounter();
        }
    }

    // ---------- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ ----------
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('editorMode').style.display = mode === 'edit' ? 'flex' : 'none';
        document.getElementById('demoMode').style.display = mode === 'demo' ? 'block' : 'none';
        document.getElementById('modeEditBtn').classList.toggle('active', mode === 'edit');
        document.getElementById('modeDemoBtn').classList.toggle('active', mode === 'demo');
        if (mode === 'demo') {
            updatePlayer();
            updateCounter();
            document.getElementById('playerSlider').max = blocks.length - 1;
            document.getElementById('playerSlider').value = currentIndex;
        } else {
            updatePreview();
        }
    }

    // ---------- –ò–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç JSON ----------
    function exportJSON() {
        document.getElementById('jsonArea').value = JSON.stringify(blocks, null, 2);
    }

    function importJSON() {
        try {
            const json = document.getElementById('jsonArea').value;
            const newBlocks = JSON.parse(json);
            if (Array.isArray(newBlocks)) {
                blocks = newBlocks;
                currentIndex = 0;
                // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                lineProgress = {};
                blocks.forEach((_, idx) => {
                    lineProgress[idx] = (idx === 0) ? 0 : blocks[idx].content.length;
                });
                renderBlockList();
                updatePreview();
                if (currentMode === 'demo') {
                    updatePlayer();
                    document.getElementById('playerSlider').max = blocks.length - 1;
                    document.getElementById('playerSlider').value = currentIndex;
                }
                updateCounter();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤.');
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' + e);
        }
    }

    function exportToFile() {
        const json = JSON.stringify(blocks, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'solution.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function importFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const newBlocks = JSON.parse(ev.target.result);
                    if (Array.isArray(newBlocks)) {
                        blocks = newBlocks;
                        currentIndex = 0;
                        lineProgress = {};
                        blocks.forEach((_, idx) => {
                            lineProgress[idx] = (idx === 0) ? 0 : blocks[idx].content.length;
                        });
                        renderBlockList();
                        updatePreview();
                        if (currentMode === 'demo') {
                            updatePlayer();
                            document.getElementById('playerSlider').max = blocks.length - 1;
                            document.getElementById('playerSlider').value = currentIndex;
                        }
                        updateCounter();
                    } else {
                        alert('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤.');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // ---------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–∞ (–≤ –ø–ª–µ–µ—Ä–µ: –ø–∞—É–∑–∞/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ) ----------
    document.addEventListener('keydown', function(e) {
        if (e.code === 'Space' && !e.repeat && currentMode === 'demo') {
            e.preventDefault();
            if (playInterval) pause();
            else play();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    setMode('edit');
    setTheme('dark');
</script>
</body>
</html>