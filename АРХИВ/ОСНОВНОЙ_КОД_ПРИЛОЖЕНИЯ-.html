<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ó–∞–¥–∞—á–∏ JSON ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä—ã, –ø–µ—á–∞—Ç—å + –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <style>
    :root { 
      --gap: 8px; 
      --b:#e1e5e9; 
      --bg:#f8fafc; 
      --txt:#1e293b; 
      --accent:#3b82f6; 
      --success:#10b981;
      --danger:#ef4444;
      --basic:#6ee7b7; --medium:#facc15; --hard:#ef4444;
    }
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; 
      margin: 0; 
      color: var(--txt); 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      line-height: 1.5;
      padding-top: 200px;
    }
    .fixed-controls { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(20px);
    }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: end; }
    .card { 
      border:1px solid var(--b); 
      border-radius: 12px; 
      padding: 12px; 
      background: white; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls { background: var(--bg); }
    .count-badge { 
      background: var(--accent); color: white; 
      padding: 4px 10px; border-radius: 20px; 
      font-weight: 600; font-size: 13px;
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }
    label { font-size: 12px; color:#64748b; display:block; margin-bottom: 4px; font-weight: 500; }
    input[type="text"], input[type="file"], select, textarea { 
      padding: 8px 10px; 
      border:1px solid var(--b); 
      border-radius: 6px; 
      font-size: 13px;
      transition: border-color 0.2s;
      min-width: 140px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    select.dropdown { 
      background: white url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") no-repeat right 10px center;
      background-size: 14px;
      appearance: none;
      cursor: pointer;
    }
    button { 
      padding: 8px 12px; 
      border:1px solid var(--b); 
      border-radius: 6px; 
      background: white; 
      cursor: pointer; 
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s;
    }
    button:hover { background: #f8fafc; transform: translateY(-1px); }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    button.primary:hover { background: #2563eb; }
    button.danger { background:var(--danger); color:white; border-color:var(--danger); }
    button.success { background: var(--success); color: white; border-color: var(--success); }
    .difficulty-btn { 
      width: 60px; height: 40px; 
      border-radius: 8px; 
      border: 2px solid var(--b);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; font-weight: bold; color: white;
      margin: 2px;
      cursor: pointer; transition: all 0.2s;
    }
    .difficulty-btn.all { background: var(--accent); border-color: var(--accent); width: 64px; }
    .difficulty-btn.basic { background: var(--basic); border-color: #059669; }
    .difficulty-btn.medium { background: var(--medium); border-color: #d97706; }
    .difficulty-btn.hard { background: var(--hard); border-color: #dc2626; }
    .difficulty-btn.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .difficulty-row { display: flex; flex-wrap: wrap; gap: 4px; }
    .sort-btn { padding: 6px 10px; font-size: 11px; min-width: 0; }
    .toggle-answers { background: var(--success); color: white; }
    .toggle-answers.active { background: var(--danger); }
    .muted { color:#94a3b8; font-size: 12px; }
    .grid { display:grid; gap: var(--gap); padding: 20px var(--gap); padding-bottom: 100px; }
    .task { 
      border:1px solid var(--b); 
      border-radius: 16px; 
      overflow:hidden; 
      background: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
      margin-bottom: var(--gap);
    }
    .task:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .task-head { 
      padding: 16px 20px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
      display:flex; 
      justify-content: space-between; 
      gap:12px; 
      align-items: center; 
    }
    .title { font-weight: 700; font-size: 18px; color: var(--txt); }
    .badges { display:flex; gap: 8px; flex-wrap: wrap; font-size: 12px; }
    .badge { 
      border:1px solid #cbd5e1; 
      border-radius: 20px; 
      padding: 4px 10px; 
      background:white; 
      font-size: 11px;
      font-weight: 500;
    }
    .badge.section { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
    .badge.difficulty { display: flex; align-items: center; gap: 4px; }
    .task-body { padding: 20px; display:grid; gap: 16px; }
    .zone { 
      border:2px dashed #e2e8f0; 
      border-radius: 12px; 
      padding: 16px; 
      background: #fafbfc; 
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 100px;
    }
    .zone.task-zone {
      align-items: flex-start;
      text-align: left;
    }
    .zone.task-zone h4 {
      text-align: left;
      width: 100%;
    }
    .zone.task-zone .text-content {
      text-align: left;
      width: 100%;
    }
    .zone.task-zone img {
      display: block;
      margin: 0;
    }
    .zone.answer-zone {
      align-items: center;
      text-align: center;
    }
    .zone.answer-zone h4 {
      text-align: center;
      width: 100%;
    }
    .zone.answer-zone .text-content {
      text-align: center;
      width: 100%;
    }
    .zone.answer-zone img { 
      max-width: 100%; 
      max-height: 300px;
      width: auto; 
      height: auto; 
      object-fit: contain;
      transform: none;
      display: block;
      margin: 0 auto;
    }
    .zone:hover { border-color: var(--accent); background: #f0f9ff; }
    .zone:focus { outline: 2px solid var(--accent); }
    .zone h4 { margin: 0 0 12px 0; font-size: 14px; color:#64748b; font-weight: 600; }
    .zone .hint { font-size: 12px; color:#94a3b8; margin-top: 8px; }
    .zone img { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    .zone .text-content {
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 100%;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      font-size: 15px;
      line-height: 1.5;
      width: 100%;
    }
    .zone textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    .zone.empty::after { 
      content: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"; 
      color:#94a3b8; 
      font-size: 13px; 
      text-align: center;
    }
    
    .zone-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      width: 100%;
    }
    
    .zone-action-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: white;
      border: 1px solid var(--b);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .zone-action-btn:hover {
      background: #f0f9ff;
      border-color: var(--accent);
    }
    
    .actions { display:flex; gap: 8px; flex-wrap: wrap; }
    .split { 
      display:grid; 
      grid-template-columns: 2fr 1fr;
      gap: var(--gap); 
    }
    .meta-row { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 12px; 
      margin-top: 12px; 
      align-items: center;
    }
    .meta-row > div {
      flex: 1 1 200px;
      min-width: 150px;
    }
    .link { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(59,130,246,0.1);
      transition: all 0.2s;
    }
    .link:hover { background: rgba(59,130,246,0.2); }
    
    .image-buttons { 
      display: flex; 
      gap: 8px; 
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .image-btn { 
      padding: 6px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .image-btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
    }
    .image-btn.has-image { 
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    .image-btn.has-image:hover { 
      background: #bfdbfe;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */
    .calc-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    .calc-input {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 13px;
    }
    .calc-btn {
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .calc-btn:hover {
      background: #2563eb;
    }
    .calc-result {
      min-width: 60px;
      padding: 6px;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .modal-img {
      max-width: 100%;
      max-height: 80vh;
      width: auto;
      height: auto;
      display: block;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background: rgba(0,0,0,0.9);
    }
    
    .inline-edit {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }
    
    @media (max-width: 900px) { 
      .split { grid-template-columns: 2fr 1fr; } 
      body { padding-top: 220px; }
    }
    
    @media print {
      body { margin: 0; background: white !important; padding-top: 0 !important; }
      .no-print, .fixed-controls, .meta-row, .actions, .controls, .zone-actions, .image-buttons, .calc-row { display:none !important; }
      #printRoot { display:block !important; }
      .task { break-inside: avoid; box-shadow: none; margin-bottom: 40px; page-break-inside: avoid; }
      .title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: black !important; }
      
      .zone.task-zone { 
        border: none; 
        padding: 0; 
        background: transparent !important; 
        margin-bottom: 25px;
        align-items: flex-start !important;
        text-align: left !important;
      }
      .zone.task-zone .text-content {
        text-align: left !important;
        border: none;
        padding: 0;
        font-size: 14pt;
      }
      .zone.task-zone img { 
        box-shadow: none; 
        max-width: 100%; 
        max-height: 600px; 
        width: auto; 
        height: auto; 
        display: block;
        margin: 0 !important;
      }
      
      .zone.answer-zone { 
        border: none; 
        padding: 0; 
        background: transparent !important; 
        margin-bottom: 25px;
        align-items: center !important;
        text-align: center !important;
      }
      .zone.answer-zone .text-content {
        text-align: center !important;
        border: none;
        padding: 0;
        font-size: 14pt;
      }
      .zone.answer-zone img { 
        border: 2px solid #f59e0b; 
        margin-top: 20px;
        max-width: 50% !important;
        max-height: 200px !important;
        transform: scale(0.5) !important;
        transform-origin: center !important;
        display: block;
        margin: 0 auto !important;
      }
    }
    #printRoot { display:none; }
  </style>
</head>
<body>

  <div class="fixed-controls no-print">
    <div class="card controls">
      <div class="row">
        <div>
          <label>üìÅ –ò–º–ø–æ—Ä—Ç</label>
          <input id="fileInput" type="file" accept="application/json,.json">
        </div>
        <div>
          <label>üíæ –≠–∫—Å–ø–æ—Ä—Ç</label>
          <button id="btnExport" class="primary">tasks.json</button>
        </div>
        <div>
          <label>‚ûï –†–∞–∑–¥–µ–ª</label>
          <button id="btnAddSection" class="success">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
        </div>
        <div>
          <label>‚ûï –ù–æ–≤–∞—è</label>
          <button id="btnAdd" class="success">–ó–∞–¥–∞—á–∞</button>
        </div>

        <div class="print-options">
          <button id="btnToggleAnswers" class="toggle-answers active">–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button id="btnToggleDrawingsSolutions" class="primary">üìê –ü–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä—Ç–µ–∂–∏/—Ä–µ—à–µ–Ω–∏—è</button>
          <button id="btnPrintNoAnswer" class="primary" title="–ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤">üñ®Ô∏è –ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤</button>
          <button id="btnPrintWithAnswer" class="primary" title="–° –æ—Ç–≤–µ—Ç–∞–º–∏">üñ®Ô∏è –° –æ—Ç–≤–µ—Ç–∞–º–∏</button>
        </div>

        <div style="flex:1">
          <label>üîç –ü–æ–∏—Å–∫</label>
          <input id="q" type="text" placeholder="–Ω–æ–º–µ—Ä-—Ç–µ–º–∞">
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--b); margin: 12px 0;">

      <div class="row" id="filterRow">
        <div>
          <label>üìÇ –†–∞–∑–¥–µ–ª</label>
          <select id="fSection" class="dropdown"></select>
        </div>
        
        <div>
          <label>üìä –°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
          <div class="difficulty-row">
            <button class="difficulty-btn all active" data-difficulty="">–í–°–ï</button>
            <button class="difficulty-btn basic" data-difficulty="basic">üü¢ –õ—ë–≥–∫–∞—è</button>
            <button class="difficulty-btn medium" data-difficulty="medium">üü° –°—Ä–µ–¥–Ω—è—è</button>
            <button class="difficulty-btn hard" data-difficulty="hard">üî¥ –°–ª–æ–∂–Ω–∞—è</button>
          </div>
        </div>
        
        <div>
          <label>‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ </label>
          <select id="fSolved" class="dropdown">
            <option value="">–í—Å–µ</option>
            <option value="true">–†–µ—à—ë–Ω–Ω—ã–µ</option>
            <option value="false">–ù–µ —Ä–µ—à—ë–Ω–Ω—ã–µ</option>
          </select>
        </div>
        
        <div>
          <label>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</label>
          <select id="fFav" class="dropdown">
            <option value="">–í—Å–µ</option>
            <option value="true">–¢–æ–ª—å–∫–æ –∏–∑–±.</option>
            <option value="false">–ù–µ –∏–∑–±.</option>
          </select>
        </div>
        
        <div>
          <label>üî§ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <button id="sortTitle" class="sort-btn primary">‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
        </div>
        
        <div id="countContainer"></div>
      </div>
    </div>
  </div>

  <div id="app" class="grid no-print"></div>
  <div id="printRoot"></div>

<script>
(() => {
  let availableSections = new Set([""]);

  let tasks = [];
  let editingTaskId = null;
  let sortByTitle = false;
  let allAnswersVisible = false;
  let allDrawingsSolutionsVisible = false;

  const app = document.getElementById('app');
  const printRoot = document.getElementById('printRoot');
  const countContainer = document.getElementById('countContainer');
  const sortTitleBtn = document.getElementById('sortTitle');
  const btnToggleAnswers = document.getElementById('btnToggleAnswers');
  const btnToggleDrawingsSolutions = document.getElementById('btnToggleDrawingsSolutions');
  const btnAddSection = document.getElementById('btnAddSection');
  
  const fileInput = document.getElementById('fileInput');
  const btnExport = document.getElementById('btnExport');
  const btnAdd = document.getElementById('btnAdd');
  const btnPrintNoAnswer = document.getElementById('btnPrintNoAnswer');
  const btnPrintWithAnswer = document.getElementById('btnPrintWithAnswer');
  const q = document.getElementById('q');
  const fSection = document.getElementById('fSection');
  const fSolved = document.getElementById('fSolved');
  const fFav = document.getElementById('fFav');
  const difficultyBtns = document.querySelectorAll('.difficulty-btn');

  const uid = () => Date.now() + Math.floor(Math.random() * 1000);

  function normalizeTask(t) {
    const task = {
      id: t.id || uid(),
      title: t.title || "",
      solutionLink: t.solutionLink || "",
      videoLink: t.videoLink || "",
      taskImage: t.taskImage || "",
      taskText: t.taskText || "",
      answerImage: t.answerImage || "",
      answerText: t.answerText || "",
      drawingImage: t.drawingImage || "",
      solutionImage: t.solutionImage || "",
      isAnswerVisible: t.isAnswerVisible || false,
      isSolved: t.isSolved || false,
      isFavorite: t.isFavorite || false,
      difficulty: t.difficulty || "basic",
      section: t.section || "",
      sectionName: t.sectionName || "",
      isSectionHeader: t.isSectionHeader || false
    };
    
    if (task.taskImage && task.taskImage.startsWith('data:text/plain')) {
      try {
        const text = atob(task.taskImage.split(',')[1]);
        task.taskText = text;
        task.taskImage = '';
      } catch (e) {}
    }
    
    if (task.answerImage && task.answerImage.startsWith('data:text/plain')) {
      try {
        const text = atob(task.answerImage.split(',')[1]);
        task.answerText = text;
        task.answerImage = '';
      } catch (e) {}
    }
    
    return task;
  }

  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    const div = document.createElement('div');
    div.textContent = String(s);
    return div.innerHTML;
  }

  function toDataUrlFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function getAllSections() {
    const sections = new Set([...availableSections]);
    tasks.forEach(task => {
      if (task.sectionName && task.sectionName.trim() && !task.isSectionHeader) {
        sections.add(task.sectionName.trim());
      }
    });
    return Array.from(sections).sort();
  }

  function updateSectionDropdown() {
    const sections = getAllSections();
    const currentValue = fSection.value;
    fSection.innerHTML = `<option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>` + 
      sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    if (sections.includes(currentValue)) {
      fSection.value = currentValue;
    }
  }

  function matchesFilters(task) {
    if (task.isSectionHeader) return true;
    
    const search = q.value.trim().toLowerCase();
    if (search && !(task.title + ' ' + task.sectionName).toLowerCase().includes(search)) return false;
    
    if (fSection.value && task.sectionName !== fSection.value) return false;
    const activeDifficulty = document.querySelector('.difficulty-btn.active')?.dataset.difficulty;
    if (activeDifficulty && activeDifficulty !== '' && task.difficulty !== activeDifficulty) return false;
    if (fSolved.value !== '' && String(!!task.isSolved) !== fSolved.value) return false;
    if (fFav.value !== '' && String(!!task.isFavorite) !== fFav.value) return false;
    
    return true;
  }

  function getFilteredAndSortedTasks() {
    let filtered = tasks.filter(matchesFilters);
    
    if (fSection.value || sortByTitle) {
      filtered.sort((a, b) => {
        if (a.isSectionHeader !== b.isSectionHeader) {
          return a.isSectionHeader ? -1 : 1;
        }
        const titleA = (a.title || '').toString().toLowerCase();
        const titleB = (b.title || '').toString().toLowerCase();
        return titleA.localeCompare(titleB);
      });
    }
    
    return filtered;
  }

  function showModal(imageSrc, title) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <button class="modal-close">√ó</button>
        <img src="${imageSrc}" alt="${title}" class="modal-img">
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.classList.contains('modal-close')) {
        document.body.removeChild(modal);
      }
    });
    
    document.addEventListener('keydown', function closeModal(e) {
      if (e.key === 'Escape') {
        document.body.removeChild(modal);
        document.removeEventListener('keydown', closeModal);
      }
    });
  }

  function safeEvaluate(expr) {
    try {
      expr = expr.replace(/‚àö/g, 'Math.sqrt').replace(/\^/g, '**');
      if (/[^0-9+\-*/().\sMath.sqrt]/.test(expr)) return '–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ';
      const result = new Function(`return (${expr})`)();
      return Math.abs(result - Math.round(result)) < 1e-10 ? Math.round(result) : result;
    } catch (e) {
      return '–æ—à–∏–±–∫–∞';
    }
  }

  window.calcHandler = function(taskId) {
    const taskEl = document.querySelector(`.task[data-id="${taskId}"]`);
    if (!taskEl) return;
    const input = taskEl.querySelector('.calc-input');
    const resultSpan = taskEl.querySelector('.calc-result');
    if (input && resultSpan) {
      resultSpan.textContent = safeEvaluate(input.value);
    }
  };

  function renderZoneContent(task, zoneType, showAnswer) {
    if (zoneType === 'task') {
      if (task.taskImage) {
        return `<img src="${task.taskImage}" alt="–£—Å–ª–æ–≤–∏–µ" style="max-width:100%;">`;
      } else if (task.taskText) {
        return `<div class="text-content">${escapeHtml(task.taskText).replace(/\n/g, '<br>')}</div>`;
      }
    } else if (zoneType === 'answer') {
      if (task.answerImage && showAnswer) {
        return `<img src="${task.answerImage}" alt="–û—Ç–≤–µ—Ç" style="max-width:100%;">`;
      } else if (task.answerText && showAnswer) {
        return `<div class="text-content">${escapeHtml(task.answerText).replace(/\n/g, '<br>')}</div>`;
      } else if (!showAnswer && (task.answerImage || task.answerText)) {
        return `<div class="hint">–∫–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>`;
      }
    }
    return '';
  }

  function renderTask(task) {
    const isEditing = editingTaskId === task.id;
    const showAnswer = task.isAnswerVisible || allAnswersVisible;
    const showDrawingsSolutions = allDrawingsSolutionsVisible;
    const sections = getAllSections();
    
    if (task.isSectionHeader) {
      return `
        <div class="task" data-id="${task.id}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
          <div class="task-head" style="background: transparent; color: white;">
            <div class="title" style="font-size: 22px;">üìÅ ${escapeHtml(task.title)}</div>
          </div>
        </div>
      `;
    }
    
    const solutionLinkHtml = task.solutionLink ? 
      `<a href="${escapeHtml(task.solutionLink)}" target="_blank" class="badge link">üîó –†–µ—à–µ–Ω–∏–µ</a>` : '';
    
    const videoLinkHtml = task.videoLink ? 
      `<a href="${escapeHtml(task.videoLink)}" target="_blank" class="badge link">üìπ –í–∏–¥–µ–æ</a>` : '';
    
    const hasDrawing = !!task.drawingImage;
    const hasSolution = !!task.solutionImage;
    
    const taskZoneContent = renderZoneContent(task, 'task', showAnswer);
    const answerZoneContent = renderZoneContent(task, 'answer', showAnswer);
    
    const taskZoneClass = !task.taskImage && !task.taskText ? 'empty' : '';
    const answerZoneClass = !task.answerImage && !task.answerText ? 'empty' : '';
    
    return `
      <div class="task" data-id="${task.id}">
        <div class="task-head">
          <div>
            <div class="title">${escapeHtml(task.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)')}</div>
            <div class="badges">
              <span class="badge section">üìÇ ${escapeHtml(task.sectionName || '-')}</span>
              <span class="badge difficulty">üìä 
                <span style="color: ${task.difficulty === 'basic' ? '#059669' : task.difficulty === 'medium' ? '#d97706' : '#dc2626'}; font-weight: bold;">
                  ${task.difficulty === 'basic' ? '–õ—ë–≥–∫–∞—è' : task.difficulty === 'medium' ? '–°—Ä–µ–¥–Ω—è—è' : '–°–ª–æ–∂–Ω–∞—è'}
                </span>
              </span>
              <span class="badge">${task.isSolved ? '‚úÖ —Ä–µ—à–µ–Ω–æ' : '‚ùå –Ω–µ —Ä–µ—à–µ–Ω–æ'}</span>
              <span class="badge">${task.isFavorite ? '‚≠ê –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '‚òÜ'}</span>
              ${solutionLinkHtml}
              ${videoLinkHtml}
            </div>
          </div>
          <div class="actions">
            <button data-act="toggleSolved">${task.isSolved ? '–°–Ω—è—Ç—å ‚úÖ' : '–í —Ä–µ—à—ë–Ω–Ω—ã–µ ‚úÖ'}</button>
            <button data-act="toggleFav">${task.isFavorite ? '–£–±—Ä–∞—Ç—å ‚≠ê' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê'}</button>
            <button data-act="edit" class="${isEditing ? '' : 'primary'}">${isEditing ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</button>
            <button data-act="clearImages">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button data-act="delete" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        
        <div class="task-body">
          <div class="split">
            <div class="zone task-zone ${taskZoneClass}" data-zone="task" tabindex="0">
              <h4>üìã –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏</h4>
              ${taskZoneContent}
              ${isEditing ? `
                <div class="zone-actions">
                  <button class="zone-action-btn" data-act="editText" data-zone="task">üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
                  <button class="zone-action-btn" data-act="pasteImage" data-zone="task">üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
              ` : ''}
              <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
            
            <div class="zone answer-zone ${answerZoneClass}" data-zone="answer" tabindex="0">
              <h4>üí° –û—Ç–≤–µ—Ç</h4>
              ${answerZoneContent}
              ${isEditing ? `
                <div class="zone-actions">
                  <button class="zone-action-btn" data-act="editText" data-zone="answer">üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
                  <button class="zone-action-btn" data-act="pasteImage" data-zone="answer">üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
              ` : ''}
              <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
          </div>
          
          ${(hasDrawing || hasSolution) && showDrawingsSolutions ? `
            <div class="drawings-solutions-section" style="margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px; color:#64748b; font-weight: 600;">üìê –ß–µ—Ä—Ç–µ–∂–∏ –∏ —Ä–µ—à–µ–Ω–∏—è:</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                ${hasDrawing ? `
                  <div style="flex: 1; min-width: 200px;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">–ß–µ—Ä—Ç–µ–∂:</div>
                    <img src="${task.drawingImage}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  </div>
                ` : ''}
                ${hasSolution ? `
                  <div style="flex: 1; min-width: 200px;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">–†–µ—à–µ–Ω–∏–µ:</div>
                    <img src="${task.solutionImage}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}
          
          <div class="image-buttons">
            <button class="image-btn ${hasDrawing ? 'has-image' : ''}" 
                    data-act="showDrawing" 
                    ${!hasDrawing ? 'disabled style="opacity:0.5;"' : ''}>
              üìê –ß–µ—Ä—Ç–µ–∂ ${hasDrawing ? '‚úì' : ''}
            </button>
            <button class="image-btn ${hasSolution ? 'has-image' : ''}" 
                    data-act="showSolution" 
                    ${!hasSolution ? 'disabled style="opacity:0.5;"' : ''}>
              üìù –†–µ—à–µ–Ω–∏–µ ${hasSolution ? '‚úì' : ''}
            </button>
            ${isEditing ? `
              <button class="image-btn" data-act="pasteDrawing">üìã –í—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä—Ç–µ–∂</button>
              <button class="image-btn" data-act="pasteSolution">üìã –í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
              <button class="image-btn" data-act="clearDrawingSolution" style="background: #fef2f2; color: #dc2626;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ–±–∞</button>
            ` : ''}
          </div>

          ${!isEditing ? `
            <div class="calc-row" data-calc-id="${task.id}">
              <input type="text" class="calc-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 26/‚àö2" value="">
              <button class="calc-btn" onclick="window.calcHandler('${task.id}')">=</button>
              <span class="calc-result" id="calcResult_${task.id}">0</span>
            </div>
          ` : ''}
          
          ${isEditing ? `
            <div class="card">
              <div class="meta-row">
                <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input data-field="title" value="${escapeHtml(task.title)}" style="width:100%;"></div>
                <div><label>–†–∞–∑–¥–µ–ª</label>
                  <select data-field="sectionName" class="dropdown" style="width:100%;">
                    <option value="">‚ûï –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</option>
                    ${sections.map(s => `<option value="${escapeHtml(s)}" ${task.sectionName === s ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
                  </select>
                </div>
                <div><label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                  <select data-field="difficulty" class="dropdown" style="width:100%;">
                    <option value="basic" ${task.difficulty === 'basic' ? 'selected' : ''}>üü¢ –õ—ë–≥–∫–∞—è</option>
                    <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>üü° –°—Ä–µ–¥–Ω—è—è</option>
                    <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>üî¥ –°–ª–æ–∂–Ω–∞—è</option>
                  </select>
                </div>
                <div><label>–°—Å—ã–ª–∫–∞ —Ä–µ—à–µ–Ω–∏–µ</label><input data-field="solutionLink" value="${escapeHtml(task.solutionLink)}" placeholder="https://..." style="width:100%;"></div>
                <div><label>–°—Å—ã–ª–∫–∞ –≤–∏–¥–µ–æ</label><input data-field="videoLink" value="${escapeHtml(task.videoLink)}" placeholder="https://..." style="width:100%;"></div>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  function render() {
    updateSectionDropdown();
    const filtered = getFilteredAndSortedTasks();
    
    app.innerHTML = filtered.length ? 
      filtered.map(task => renderTask(task)).join('') : 
      '<div class="card" style="text-align:center;padding:40px"><div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</div></div>';
    
    countContainer.innerHTML = `<div class="count-badge">üìä ${filtered.length}</div>`;
  }

  btnToggleDrawingsSolutions.addEventListener('click', () => {
    allDrawingsSolutionsVisible = !allDrawingsSolutionsVisible;
    btnToggleDrawingsSolutions.textContent = allDrawingsSolutionsVisible 
      ? 'üìê –°–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏' 
      : 'üìê –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏';
    render();
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      tasks = Array.isArray(data) ? data.map(normalizeTask) : [normalizeTask(data)];
      render();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ JSON: ' + err.message);
    }
    e.target.value = '';
  });

  btnExport.addEventListener('click', () => {
    const jsonString = JSON.stringify(tasks.map(t => {
      const taskCopy = {...t};
      taskCopy.isAnswerVisible = false;
      return taskCopy;
    }), null, 2);
    
    let fileName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .json):', 'tasks');
    if (fileName === null) return;
    
    fileName = fileName.trim().replace(/\.json$/i, '') || 'tasks';
    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  });

  btnAddSection.addEventListener('click', () => {
    const newSection = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:');
    if (newSection && newSection.trim()) {
      availableSections.add(newSection.trim());
      updateSectionDropdown();
    }
  });

  btnToggleAnswers.addEventListener('click', () => {
    allAnswersVisible = !allAnswersVisible;
    btnToggleAnswers.textContent = allAnswersVisible ? '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã' : '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã';
    btnToggleAnswers.classList.toggle('active');
    render();
  });

  btnAdd.addEventListener('click', () => {
    resetFilters();
    const newTask = normalizeTask({ title: '', sectionName: '', difficulty: 'basic' });
    tasks.unshift(newTask);
    editingTaskId = newTask.id;
    render();
    setTimeout(() => {
      const titleInput = app.querySelector('input[data-field="title"]');
      titleInput?.focus();
    }, 200);
  });

  function resetFilters() {
    q.value = '';
    fSection.value = '';
    fSolved.value = '';
    fFav.value = '';
    difficultyBtns.forEach(b => b.classList.remove('active'));
    document.querySelector('.difficulty-btn.all').classList.add('active');
    sortByTitle = false;
    sortTitleBtn.textContent = '‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ';
  }

  difficultyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      difficultyBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    });
  });

  [q, fSection, fSolved, fFav].forEach(el => {
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  sortTitleBtn.addEventListener('click', () => {
    sortByTitle = !sortByTitle;
    sortTitleBtn.textContent = sortByTitle ? '‚Üì –Ω–∞–∑–≤–∞–Ω–∏–µ' : '‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ';
    render();
  });

  app.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    const act = btn.dataset.act;
    const taskEl = btn.closest('.task');
    if (!taskEl) return;
    
    const taskId = Number(taskEl.dataset.id);
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    
    if (act === 'toggleSolved') {
      task.isSolved = !task.isSolved;
      render();
    } else if (act === 'toggleFav') {
      task.isFavorite = !task.isFavorite;
      render();
    } else if (act === 'edit') {
      editingTaskId = editingTaskId === task.id ? null : task.id;
      render();
    } else if (act === 'clearImages') { 
      task.taskImage = ''; 
      task.taskText = '';
      task.answerImage = ''; 
      task.answerText = '';
      task.drawingImage = '';
      task.solutionImage = '';
      render();
    } else if (act === 'delete') {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
        tasks = tasks.filter(t => t.id !== taskId);
        if (editingTaskId === taskId) editingTaskId = null;
        render();
      }
    } else if (act === 'showDrawing' && task.drawingImage) {
      showModal(task.drawingImage, `–ß–µ—Ä—Ç–µ–∂: ${task.title}`);
    } else if (act === 'showSolution' && task.solutionImage) {
      showModal(task.solutionImage, `–†–µ—à–µ–Ω–∏–µ: ${task.title}`);
    } else if (act === 'pasteDrawing' && editingTaskId === taskId) {
      try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
          for (const type of item.types) {
            if (type.startsWith('image/')) {
              const blob = await item.getType(type);
              task.drawingImage = await toDataUrlFromFile(blob);
              render();
              return;
            }
          }
        }
        alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞');
      }
    } else if (act === 'pasteSolution' && editingTaskId === taskId) {
      try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
          for (const type of item.types) {
            if (type.startsWith('image/')) {
              const blob = await item.getType(type);
              task.solutionImage = await toDataUrlFromFile(blob);
              render();
              return;
            }
          }
        }
        alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞');
      }
    } else if (act === 'clearDrawingSolution' && editingTaskId === taskId) {
      task.drawingImage = '';
      task.solutionImage = '';
      render();
    } else if (act === 'editText') {
      const zone = btn.closest('.zone');
      const zoneType = btn.dataset.zone;
      
      const textarea = document.createElement('textarea');
      textarea.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...';
      textarea.value = zoneType === 'task' ? (task.taskText || '') : (task.answerText || '');
      
      zone.innerHTML = `
        <h4>${zoneType === 'task' ? 'üìã –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏' : 'üí° –û—Ç–≤–µ—Ç'}</h4>
        <div class="hint">Ctrl+Enter - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, Esc - –æ—Ç–º–µ–Ω–∞</div>
      `;
      zone.appendChild(textarea);
      textarea.focus();
      
      const saveText = () => {
        const text = textarea.value.trim();
        if (zoneType === 'task') {
          task.taskText = text || '';
          task.taskImage = '';
        } else {
          task.answerText = text || '';
          task.answerImage = '';
        }
        render();
      };
      
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveText();
        } else if (e.key === 'Escape') {
          render();
        }
      });
      
      textarea.addEventListener('blur', saveText);
      
    } else if (act === 'pasteImage') {
      const zone = btn.closest('.zone');
      zone.focus();
      alert('–ù–∞–∂–º–∏—Ç–µ Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    }
  });

  app.addEventListener('input', (e) => {
    const input = e.target.closest('[data-field]');
    if (!input || !editingTaskId) return;
    
    const taskEl = app.querySelector(`.task[data-id="${editingTaskId}"]`);
    const taskId = Number(taskEl.dataset.id);
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      task[input.dataset.field] = input.value;
    }
  });

  app.addEventListener('change', (e) => {
    const select = e.target.closest('select[data-field]');
    if (!select || !editingTaskId) return;
    
    const taskEl = app.querySelector(`.task[data-id="${editingTaskId}"]`);
    const taskId = Number(taskEl.dataset.id);
    const task = tasks.find(t => t.id === taskId);
    
    if (select.dataset.field === 'sectionName' && select.value === '') {
      const newSection = prompt('–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª:');
      if (newSection) {
        task.sectionName = newSection.trim();
        availableSections.add(newSection.trim());
        select.value = newSection.trim();
      }
    } else {
      task[select.dataset.field] = select.value;
    }
    render();
  });

  document.addEventListener('paste', async (e) => {
    if (!editingTaskId) return;
    
    const zone = e.target.closest('.zone[data-zone]');
    if (!zone) return;
    
    const items = Array.from(e.clipboardData?.items || []);
    const imageItem = items.find(item => item.type?.startsWith('image/'));
    
    if (imageItem) {
      e.preventDefault();
      const file = imageItem.getAsFile();
      if (file) {
        const dataUrl = await toDataUrlFromFile(file);
        const taskEl = zone.closest('.task');
        const taskId = Number(taskEl.dataset.id);
        const task = tasks.find(t => t.id === taskId);
        
        if (zone.dataset.zone === 'answer') {
          task.answerImage = dataUrl;
          task.answerText = '';
          task.isAnswerVisible = true;
        } else if (zone.dataset.zone === 'task') {
          task.taskImage = dataUrl;
          task.taskText = '';
        }
        render();
      }
    } else {
      const text = e.clipboardData.getData('text');
      if (text && text.trim()) {
        e.preventDefault();
        const taskEl = zone.closest('.task');
        const taskId = Number(taskEl.dataset.id);
        const task = tasks.find(t => t.id === taskId);
        
        if (zone.dataset.zone === 'answer') {
          task.answerText = text.trim();
          task.answerImage = '';
        } else if (zone.dataset.zone === 'task') {
          task.taskText = text.trim();
          task.taskImage = '';
        }
        render();
      }
    }
  });

  app.addEventListener('click', (e) => {
    const zone = e.target.closest('.zone[data-zone="answer"]');
    if (zone && !editingTaskId) {
      const taskEl = zone.closest('.task');
      const taskId = Number(taskEl.dataset.id);
      const task = tasks.find(t => t.id === taskId);
      task.isAnswerVisible = !task.isAnswerVisible;
      render();
    }
  });

  function printTasks(showAnswers) {
    const ANSWER_COLUMNS = 10;
    const ANSWER_SCALE = 0.4;
    const ANSWER_MAX_WIDTH = 140 * ANSWER_SCALE;
    const ANSWER_MAX_HEIGHT = 100 * ANSWER_SCALE;
    
    const originalVisibility = tasks.map(t => t.isAnswerVisible);
    
    if (showAnswers) {
      tasks.forEach(t => t.isAnswerVisible = true);
    }
    
    const filtered = getFilteredAndSortedTasks();
    let printContent = '';
    let answerKey = '';
    let answerItems = '';
    let answerCount = 0;
    
    filtered.forEach((task, index) => {
      if (task.isSectionHeader) return;
      
      function getPrintContent(type) {
        if (type === 'task') {
          if (task.taskImage) {
            return `<img src="${task.taskImage}" style="max-width: 100%; max-height: 400px; display: block; margin: 0;">`;
          } else if (task.taskText) {
            return `<div style="padding: 20px; background: #f9f9f9; border: 1px solid #ddd; white-space: pre-wrap; font-size: 14pt; text-align: left;">${escapeHtml(task.taskText).replace(/\n/g, '<br>')}</div>`;
          }
        } else if (type === 'answer') {
          if (task.answerImage) {
            return `<img src="${task.answerImage}" style="max-width: 100%; max-height: 400px; display: block; margin: 0 auto;">`;
          } else if (task.answerText) {
            return `<div style="padding: 20px; background: #f9f9f9; border: 1px solid #ddd; white-space: pre-wrap; font-size: 14pt; text-align: center;">${escapeHtml(task.answerText).replace(/\n/g, '<br>')}</div>`;
          }
        }
        return '<div style="padding: 40px; background: #f5f5f5; text-align: center; font-style: italic;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      }
      
      printContent += `
        <div class="print-task" style="margin-bottom: 30px; page-break-inside: avoid;">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <span style="font-weight: bold; font-size: 14pt; white-space: nowrap;">${index + 1}.</span>
            <div style="flex: 1;">${getPrintContent('task')}</div>
          </div>
        </div>
      `;
      
      if (!showAnswers && (task.answerImage || task.answerText)) {
        answerItems += `
          <div class="answer-cell" style="padding: 5px; box-sizing: border-box;">
            <div style="font-weight: bold; font-size: 10pt; margin-bottom: 3px; text-align: center;">${index + 1}</div>
            ${task.answerImage ? 
              `<img src="${task.answerImage}" style="max-width: ${ANSWER_MAX_WIDTH}px; max-height: ${ANSWER_MAX_HEIGHT}px; display: block; margin: 0 auto; border: 1px solid #ccc;">` :
              `<div style="max-width: ${ANSWER_MAX_WIDTH}px; max-height: ${ANSWER_MAX_HEIGHT}px; overflow: auto; font-size: 8pt; padding: 4px; border: 1px solid #ccc; white-space: pre-wrap; text-align: center;">${escapeHtml(task.answerText)}</div>`
            }
          </div>
        `;
        answerCount++;
      }
    });
    
    if (!showAnswers && answerItems) {
      answerKey = `
        <div class="answer-key" style="page-break-before: always; margin-top: 40px;">
          <div style="text-align: center; font-size: 16pt; font-weight: bold; margin-bottom: 20px;">
            –ö–ª—é—á –æ—Ç–≤–µ—Ç–æ–≤ (${answerCount} –∑–∞–¥–∞—á)
          </div>
          <div style="display: grid; grid-template-columns: repeat(${ANSWER_COLUMNS}, 1fr); gap: 10px;">
            ${answerItems}
          </div>
        </div>
      `;
    }
    
    const printHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>${showAnswers ? '–ó–∞–¥–∞–Ω–∏—è —Å –æ—Ç–≤–µ—Ç–∞–º–∏' : '–ó–∞–¥–∞–Ω–∏—è –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤'}</title>
        <style>
          body { font-family: "Times New Roman", serif; margin: 15mm; }
          .print-task { page-break-inside: avoid; margin-bottom: 25px; }
          img { max-width: 100% !important; }
          @media print { 
            .answer-key img { 
              max-width: ${ANSWER_MAX_WIDTH}px !important; 
              max-height: ${ANSWER_MAX_HEIGHT}px !important; 
            } 
          }
        </style>
      </head>
      <body>
        ${printContent}
        ${!showAnswers ? answerKey : ''}
      </body>
      </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHTML);
    printWindow.document.close();
    
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
        tasks.forEach((t, i) => t.isAnswerVisible = originalVisibility[i]);
        setTimeout(render, 100);
      }, 1000);
    };
  }

  btnPrintNoAnswer.addEventListener('click', () => printTasks(true));
  btnPrintWithAnswer.addEventListener('click', () => printTasks(false));

  tasks = [
    // –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏ –∑–¥–µ—Å—å
  ];

  render();
})();
</script>
</body>
</html>