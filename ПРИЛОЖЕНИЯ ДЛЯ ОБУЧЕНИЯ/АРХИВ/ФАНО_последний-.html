<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≥ –î–µ—Ä–µ–≤–æ –§–∞–Ω–æ ‚Äî –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ + –≤—Å–µ –∫–Ω–æ–ø–∫–∏</title>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        body {
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app {
            width: 100vw;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: #1a202c;
        }

        .left-panel {
            background: rgba(26, 32, 44, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 2px solid #4a5568;
            transition: width 0.2s;
        }
        .left-panel.narrow {
            width: 320px;
            min-width: 300px;
        }
        .left-panel.wide {
            width: 500px;
            min-width: 450px;
        }

        .panel-header {
            padding: 15px;
            background: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4a5568;
        }
        .panel-header h3 {
            font-size: 1.2em;
            color: #e2e8f0;
            margin: 0;
        }
        .panel-header button {
            background: #4a5568;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .panel-header button:hover {
            background: #718096;
        }

        .search-bar {
            padding: 10px;
            background: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            background: #1e293b;
            border: 2px solid #4a5568;
            border-radius: 30px;
            color: white;
            font-size: 0.95em;
            outline: none;
        }
        .search-bar input:focus {
            border-color: #4299e1;
        }

        .filter-bar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #2d3748;
            border-bottom: 1px solid #4a5568;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: #4a5568;
            border: none;
            color: #cbd5e0;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .filter-btn.active {
            background: #4299e1;
            color: white;
        }
        .filter-btn:hover {
            background: #718096;
            color: white;
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .task-item {
            padding: 12px 10px;
            margin-bottom: 5px;
            background: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item:hover {
            background: #5f6b7a;
            transform: translateX(2px);
        }
        .task-item.active {
            background: #434190;
            border-left-color: #fbbf24;
        }
        .task-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .task-icons span {
            font-size: 1.1em;
            margin-right: 2px;
        }
        .task-item button {
            background: #2d3748;
            border: none;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
        }

        .edit-panel {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }
        .edit-panel label {
            color: #cbd5e0;
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
        }
        .edit-panel input, .edit-panel textarea {
            width: 100%;
            padding: 8px;
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 6px;
            color: white;
        }
        .checkbox-group {
            display: flex;
            gap: 20px;
            background: #2d3748;
            padding: 10px;
            border-radius: 6px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.9em;
            flex: 1;
            min-width: 70px;
        }
        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-outline { background: transparent; border: 2px solid #4a5568; color: #e2e8f0; }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #1a202c;
        }

        .task-info {
            background: #2d3748;
            padding: 12px 20px;
            color: white;
            border-bottom: 2px solid #4a5568;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .task-info .task-id {
            background: #4299e1;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        .task-info .task-condition {
            flex: 2.5;
            overflow-wrap: break-word;
            min-width: 300px;
        }
        .task-info .answer-box {
            background: #4a5568;
            padding: 4px 8px;
            border-radius: 6px;
            color: #fbbf24;
            font-weight: bold;
            cursor: pointer;
        }
        .hidden-answer {
            background: #2d3748;
            padding: 4px 8px;
            border-radius: 6px;
            color: #fbbf24;
            display: none;
            border: 1px solid #fbbf24;
        }
        .fano-toggle {
            display: flex;
            gap: 5px;
            background: #4a5568;
            padding: 3px;
            border-radius: 30px;
        }
        .fano-toggle button {
            background: transparent;
            border: none;
            color: #cbd5e0;
            padding: 4px 12px;
            border-radius: 30px;
            cursor: pointer;
        }
        .fano-toggle button.active {
            background: #4299e1;
            color: white;
        }
        .video-link {
            background: #e53e3e;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            text-decoration: none;
        }
        .solution-button {
            background: #48bb78;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .canvas-container {
            flex: 1;
            overflow: auto;
            background: #1a202c;
        }
        #treeCanvas {
            display: block;
            width: 2000px;
            height: 1000px;
            background: #1a202c;
        }

        .zoom-panel {
            background: #2d3748;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            border-top: 2px solid #4a5568;
            flex-wrap: wrap;
        }
        #zoomLevel {
            color: white;
            background: #4a5568;
            padding: 4px 12px;
            border-radius: 30px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #2d3748;
            padding: 30px;
            border-radius: 12px;
            width: 90vw;
            height: 90vh;
            color: white;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 28px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="left-panel narrow" id="leftPanel">
            <div class="panel-header">
                <h3 id="leftPanelTitle">üìã –ó–∞–¥–∞—á–∏</h3>
                <button id="backToListBtn" style="display: none;" onclick="showTaskList()">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —É—Å–ª–æ–≤–∏—é..." oninput="applyTextSearch()">
            </div>
            <div class="filter-bar" id="filterBar">
                <button class="filter-btn active" onclick="setFilter('all')">–í—Å–µ</button>
                <button class="filter-btn" onclick="setFilter('solved')">‚úÖ –†–µ—à—ë–Ω–Ω—ã–µ</button>
                <button class="filter-btn" onclick="setFilter('favorite')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="filter-btn" onclick="setFilter('homework')">üìö –î–ó</button>
            </div>
            <div id="taskListContainer" class="task-list"></div>
            <div id="editPanelContainer" class="edit-panel" style="display: none;">
                <label>–ù–æ–º–µ—Ä –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="editId" readonly placeholder="–∞–≤—Ç–æ">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="editName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                <label>–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏</label>
                <textarea id="editCondition" placeholder="–¢–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏—è..." rows="2"></textarea>
                <label>–ö–æ–¥—ã (—Ñ–æ—Ä–º–∞—Ç: –ê=0, –ë=10, ...)</label>
                <textarea id="editCodes" placeholder="–ê=0
–ë=10
–í=110" rows="3"></textarea>
                <label>–û—Ç–≤–µ—Ç</label>
                <input type="text" id="editAnswer" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 101">
                <label>–†–µ—à–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç –∏–ª–∏ Ctrl+V –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</label>
                <textarea id="editSolution" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (Ctrl+V)..." rows="3"></textarea>
                <div class="solution-preview" id="solutionPreview"></div>
                <label>–í–∏–¥–µ–æ—Ä–∞–∑–±–æ—Ä (—Å—Å—ã–ª–∫–∞ –Ω–∞ Rutube)</label>
                <input type="url" id="editVideo" placeholder="https://rutube.ru/video/...">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="editSolved"> ‚úÖ –†–µ—à–µ–Ω–æ</label>
                    <label><input type="checkbox" id="editFavorite"> ‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</label>
                    <label><input type="checkbox" id="editHomework"> üìö –î–ó</label>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveEditedTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="deleteEditedTask()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="right-panel">
            <div class="task-info">
                <span class="task-id" id="currentTaskId">#?</span>
                <h2 id="currentTaskName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <span class="task-condition" id="currentTaskCondition"></span>
                <span class="answer-box" id="currentAnswer" onclick="toggleAnswer()">?</span>
                <span class="hidden-answer" id="hiddenAnswer"></span>
                <div class="fano-toggle" id="fanoToggle">
                    <button class="active" onclick="setFanoType('direct')">–ü—Ä—è–º–æ–µ</button>
                    <button onclick="setFanoType('reverse')">–û–±—Ä–∞—Ç–Ω–æ–µ</button>
                </div>
                <a href="#" id="videoLink" class="video-link" target="_blank" style="display: none;">üé¨ –í–∏–¥–µ–æ</a>
                <button class="solution-button" id="solutionButton" onclick="showSolution()">üìÑ –†–µ—à–µ–Ω–∏–µ</button>
            </div>
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="treeCanvas" width="2000" height="1000"></canvas>
                </div>
            </div>
            <div class="zoom-panel">
                <button class="btn btn-primary" onclick="zoomIn()">‚ûï</button>
                <button class="btn btn-primary" onclick="zoomOut()">‚ûñ</button>
                <button class="btn btn-primary" onclick="resetZoom()">üîÑ</button>
                <button class="btn btn-primary" onclick="fitToScreen()">‚§¢</button>
                <span id="zoomLevel">100%</span>
                <button class="btn btn-outline" onclick="exportTasks()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-outline" onclick="importTasks()">üì• –ò–º–ø–æ—Ä—Ç</button>
                <button class="btn btn-outline" onclick="newTask()">‚ûï –ù–æ–≤–∞—è</button>
                <button class="btn btn-outline" onclick="saveTaskFromTree()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-outline" onclick="deleteCurrentTask()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-success" onclick="printFilteredTasks()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å GitHub -->
                <button class="btn btn-outline" onclick="loadTasksFromGitHub()">üåê GitHub</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è -->
    <div id="solutionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3>–†–µ—à–µ–Ω–∏–µ</h3>
            <div id="modalSolutionContent"></div>
        </div>
    </div>

    <script>
        // ==================== –ü–û–õ–ù–´–ô –ö–û–î –°–û –í–°–ï–ú–ò –ö–ù–û–ü–ö–ê–ú–ò ====================
        class Node {
            constructor(name = null, originalCode = null) {
                this.name = name;
                this.originalCode = originalCode;
                this.left = null;
                this.right = null;
                this.code = "";
                this.x = 0;
                this.y = 0;
                this.isUserAdded = false;
                this.id = nextNodeId++;
                nodesById[this.id] = this;
            }
        }

        let tasks = [];
        let currentTaskId = null;
        let root = null;
        let fanoType = 'direct';
        let currentFilter = 'all';
        let searchText = '';

        let nextNodeId = 1;
        let nodesById = {};

        const canvas = document.getElementById('treeCanvas');
        const ctx = canvas.getContext('2d');
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX, dragStartY;

        const TOP_MARGIN = 40;
        const VERTICAL_SPACING = 100;

        const leftPanel = document.getElementById('leftPanel');
        const taskListContainer = document.getElementById('taskListContainer');
        const editPanelContainer = document.getElementById('editPanelContainer');
        const leftPanelTitle = document.getElementById('leftPanelTitle');
        const backToListBtn = document.getElementById('backToListBtn');
        const fanoButtons = document.querySelectorAll('#fanoToggle button');
        const videoLink = document.getElementById('videoLink');
        const solutionModal = document.getElementById('solutionModal');
        const modalContent = document.getElementById('modalSolutionContent');
        const searchInput = document.getElementById('searchInput');
        const currentAnswerSpan = document.getElementById('currentAnswer');
        const hiddenAnswerSpan = document.getElementById('hiddenAnswer');

        let clickTimer = null;

        // ========== –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞ ==========
        function toggleAnswer() {
            if (hiddenAnswerSpan.style.display === 'none' || hiddenAnswerSpan.style.display === '') {
                const task = tasks.find(t => t.id === currentTaskId);
                hiddenAnswerSpan.innerText = task ? task.answer : '?';
                hiddenAnswerSpan.style.display = 'inline-block';
                currentAnswerSpan.style.display = 'none';
            } else {
                hiddenAnswerSpan.style.display = 'none';
                currentAnswerSpan.style.display = 'inline-block';
            }
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        document.getElementById('editSolution').addEventListener('paste', function(e) {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf('image') === 0) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('editSolution').value = event.target.result;
                        showSolutionPreview(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        });

        function showSolutionPreview(data) {
            const preview = document.getElementById('solutionPreview');
            if (data.startsWith('data:image')) {
                preview.innerHTML = `<img src="${data}" alt="—Ä–µ—à–µ–Ω–∏–µ">`;
            } else {
                preview.innerHTML = '<div style="color:#a0aec0">–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</div>';
            }
        }

        function calculateLevels(node, level = 0, levels = []) {
            if (!node) return levels;
            if (!levels[level]) levels[level] = [];
            levels[level].push(node);
            calculateLevels(node.left, level + 1, levels);
            calculateLevels(node.right, level + 1, levels);
            return levels;
        }

        function positionNodesEvenly() {
            if (!root) return;
            const levels = calculateLevels(root);
            const maxLevel = levels.length - 1;
            for (let level = 0; level <= maxLevel; level++) {
                const nodesAtLevel = levels[level];
                const count = nodesAtLevel.length;
                const baseSpacing = 300 - level * 30;
                const totalWidth = count * baseSpacing;
                const startX = (canvas.width - totalWidth) / 2 + baseSpacing / 2;
                nodesAtLevel.forEach((node, index) => {
                    node.x = startX + index * baseSpacing;
                    node.y = TOP_MARGIN + level * VERTICAL_SPACING;
                });
            }
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!root) return;
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);
            drawEdges(root);
            drawNodes(root);
            ctx.restore();
            document.getElementById('zoomLevel').innerText = Math.round(scale * 100) + '%';
        }

        function drawEdges(node) {
            if (!node) return;
            ctx.beginPath();
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 2 / scale;
            if (node.left) {
                ctx.moveTo(node.x, node.y);
                ctx.lineTo(node.left.x, node.left.y);
                ctx.stroke();
                ctx.fillStyle = '#4299e1';
                ctx.font = `${16 / scale}px monospace`;
                ctx.fillText('0', (node.x + node.left.x) / 2 - 5, (node.y + node.left.y) / 2 - 10);
                drawEdges(node.left);
            }
            if (node.right) {
                ctx.moveTo(node.x, node.y);
                ctx.lineTo(node.right.x, node.right.y);
                ctx.stroke();
                ctx.fillStyle = '#4299e1';
                ctx.font = `${16 / scale}px monospace`;
                ctx.fillText('1', (node.x + node.right.x) / 2 + 5, (node.y + node.right.y) / 2 - 10);
                drawEdges(node.right);
            }
        }

        function drawNodes(node) {
            if (!node) return;
            const radius = node.name ? 26 : 18;
            let fillColor = node.name ? '#f56565' : (node.isUserAdded ? '#fbbf24' : '#48bb78');
            ctx.beginPath();
            ctx.fillStyle = fillColor;
            ctx.arc(node.x, node.y, radius / scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = node.name ? '#c53030' : (node.isUserAdded ? '#d97706' : '#2f855a');
            ctx.lineWidth = 2 / scale;
            ctx.stroke();

            const isLeaf = !node.left && !node.right;
            if (isLeaf) {
                if (node.name) {
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${22 / scale}px Arial`;
                    ctx.fillText(node.name, node.x - 11/scale, node.y + 8/scale);
                    ctx.fillStyle = '#e2e8f0';
                    ctx.font = `${16 / scale}px monospace`;
                    const label = `${node.originalCode}`;
                    ctx.fillText(label, node.x - ctx.measureText(label).width/2, node.y + 50/scale);
                } else if (node.isUserAdded) {
                    ctx.fillStyle = '#e2e8f0';
                    ctx.font = `${16 / scale}px monospace`;
                    const label = `${node.code}`;
                    ctx.fillText(label, node.x - ctx.measureText(label).width/2, node.y + 35/scale);
                }
            }
            if (node.left) drawNodes(node.left);
            if (node.right) drawNodes(node.right);
        }

        function findNodeByXY(node, x, y) {
            if (!node) return null;
            const dx = node.x - x;
            const dy = node.y - y;
            if (Math.sqrt(dx*dx + dy*dy) < 25) return node;
            return findNodeByXY(node.left, x, y) || findNodeByXY(node.right, x, y);
        }

        canvas.addEventListener('click', function(e) {
            if (!root) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            const clickedNode = findNodeByXY(root, x, y);
            if (!clickedNode || clickedNode.name) return;
            
            if (clickedNode.isUserAdded) {
                if (clickTimer) clearTimeout(clickTimer);
                clickTimer = setTimeout(() => {
                    if (!clickedNode.left) {
                        clickedNode.left = new Node();
                        clickedNode.left.code = clickedNode.code + '0';
                        clickedNode.left.isUserAdded = true;
                    }
                    if (!clickedNode.right) {
                        clickedNode.right = new Node();
                        clickedNode.right.code = clickedNode.code + '1';
                        clickedNode.right.isUserAdded = true;
                    }
                    positionNodesEvenly();
                    drawCanvas();
                    clickTimer = null;
                }, 200);
                return;
            }
            
            if (!clickedNode.left) {
                clickedNode.left = new Node();
                clickedNode.left.code = clickedNode.code + '0';
                clickedNode.left.isUserAdded = true;
            } else if (!clickedNode.right) {
                clickedNode.right = new Node();
                clickedNode.right.code = clickedNode.code + '1';
                clickedNode.right.isUserAdded = true;
            }
            positionNodesEvenly();
            drawCanvas();
        });

        canvas.addEventListener('dblclick', function(e) {
            if (!root) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            const clickedNode = findNodeByXY(root, x, y);
            if (!clickedNode || clickedNode.name || !clickedNode.isUserAdded) return;
            if (clickTimer) clearTimeout(clickTimer);
            
            function removeSubtree(node) {
                if (!node) return;
                removeSubtree(node.left);
                removeSubtree(node.right);
                delete nodesById[node.id];
            }
            
            function findAndRemove(parent, target) {
                if (!parent) return false;
                if (parent.left === target) { parent.left = null; return true; }
                if (parent.right === target) { parent.right = null; return true; }
                return findAndRemove(parent.left, target) || findAndRemove(parent.right, target);
            }
            
            removeSubtree(clickedNode);
            if (findAndRemove(root, clickedNode)) {
                positionNodesEvenly();
                drawCanvas();
            }
        });

        // ========== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ==========
        function filterTasks() {
            let filtered = tasks;
            if (currentFilter === 'solved') filtered = filtered.filter(t => t.solved);
            else if (currentFilter === 'favorite') filtered = filtered.filter(t => t.favorite);
            else if (currentFilter === 'homework') filtered = filtered.filter(t => t.homework);
            if (searchText.trim()) {
                const text = searchText.trim().toLowerCase();
                filtered = filtered.filter(t => (t.condition || '').toLowerCase().includes(text));
            }
            return filtered;
        }

        function renderTaskList() {
            const filtered = filterTasks();
            taskListContainer.innerHTML = '';
            filtered.forEach(task => {
                const div = document.createElement('div');
                div.className = `task-item ${task.id === currentTaskId ? 'active' : ''}`;
                let icons = '';
                if (task.solved) icons += '‚úÖ';
                if (task.favorite) icons += '‚≠ê';
                if (task.homework) icons += 'üìö';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span class="task-name" onclick="loadTask(${task.id})">${task.id}. ${task.name}</span>
                        <span class="task-icons">${icons}</span>
                    </div>
                    <button onclick="event.stopPropagation(); openEditForTask(${task.id})">‚úèÔ∏è</button>
                `;
                taskListContainer.appendChild(div);
            });
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTaskList();
        }

        function applyTextSearch() {
            searchText = searchInput.value;
            renderTaskList();
        }

        function setFanoType(type) {
            fanoType = type;
            fanoButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (currentTaskId) loadTask(currentTaskId);
        }

        function loadTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            currentTaskId = id;
            document.getElementById('currentTaskId').innerText = '#' + id;
            document.getElementById('currentTaskName').innerText = task.name;
            document.getElementById('currentTaskCondition').innerText = task.condition || '';
            currentAnswerSpan.innerText = '?';
            hiddenAnswerSpan.innerText = task.answer || '?';
            hiddenAnswerSpan.style.display = 'none';
            currentAnswerSpan.style.display = 'inline-block';
            
            videoLink.href = task.video || '#';
            videoLink.style.display = task.video ? 'inline-flex' : 'none';
            
            buildTreeFromCodes(task.codes);
            renderTaskList();
        }

        function buildTreeFromCodes(originalCodes) {
            nextNodeId = 1;
            nodesById = {};
            let codesForBuild = originalCodes;
            if (fanoType === 'reverse') {
                codesForBuild = {};
                for (let [letter, code] of Object.entries(originalCodes)) {
                    codesForBuild[letter] = code.split('').reverse().join('');
                }
            }
            root = new Node();
            root.code = "";
            for (let [letter, code] of Object.entries(codesForBuild)) {
                let current = root;
                for (let bit of code) {
                    if (bit === '0') {
                        if (!current.left) {
                            current.left = new Node();
                            current.left.code = current.code + '0';
                        }
                        current = current.left;
                    } else {
                        if (!current.right) {
                            current.right = new Node();
                            current.right.code = current.code + '1';
                        }
                        current = current.right;
                    }
                }
                current.name = letter;
                current.originalCode = originalCodes[letter];
                current.isUserAdded = false;
            }
            positionNodesEvenly();
            setTimeout(() => fitToScreen(), 50);
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ê–°–®–¢–ê–ë–û–ú ==========
        function zoomIn() { scale = Math.min(scale + 0.2, 3); drawCanvas(); }
        function zoomOut() { scale = Math.max(scale - 0.2, 0.3); drawCanvas(); }
        function resetZoom() { scale = 1; offsetX = 0; offsetY = 0; drawCanvas(); }

        function fitToScreen() {
            if (!root) return;
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            function findBounds(node) {
                if (!node) return;
                minX = Math.min(minX, node.x);
                maxX = Math.max(maxX, node.x);
                minY = Math.min(minY, node.y);
                maxY = Math.max(maxY, node.y);
                if (node.left) findBounds(node.left);
                if (node.right) findBounds(node.right);
            }
            findBounds(root);
            const padding = 200;
            const treeW = maxX - minX + padding * 2;
            const treeH = maxY - minY + padding * 2;
            const scaleX = canvas.width / treeW;
            const scaleY = canvas.height / treeH;
            scale = Math.min(scaleX, scaleY) * 0.9;
            offsetX = (canvas.width / 2) - (minX + maxX) / 2 * scale;
            offsetY = TOP_MARGIN * scale - minY * scale;
            drawCanvas();
        }

        function startDrag(e) { isDragging = true; dragStartX = e.clientX - offsetX; dragStartY = e.clientY - offsetY; }
        function drag(e) { if (isDragging) { offsetX = e.clientX - dragStartX; offsetY = e.clientY - dragStartY; drawCanvas(); } }
        function endDrag() { isDragging = false; }

        // ========== –†–ï–®–ï–ù–ò–ï ==========
        function showSolution() {
            const task = tasks.find(t => t.id === currentTaskId);
            if (!task || !task.solution) { alert('–†–µ—à–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); return; }
            if (task.solution.startsWith('data:image')) {
                modalContent.innerHTML = `<img src="${task.solution}" alt="—Ä–µ—à–µ–Ω–∏–µ">`;
            } else {
                modalContent.innerHTML = `<pre style="white-space: pre-wrap;">${task.solution}</pre>`;
            }
            solutionModal.style.display = 'flex';
        }

        function closeModal() { solutionModal.style.display = 'none'; }
        window.onclick = (e) => { if (e.target === solutionModal) solutionModal.style.display = 'none'; };

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ==========
        function openEditForTask(id) {
            loadTask(id);
            leftPanel.classList.remove('narrow');
            leftPanel.classList.add('wide');
            taskListContainer.style.display = 'none';
            editPanelContainer.style.display = 'flex';
            leftPanelTitle.innerText = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            backToListBtn.style.display = 'inline-block';

            const task = tasks.find(t => t.id === id);
            if (task) {
                document.getElementById('editId').value = task.id;
                document.getElementById('editName').value = task.name;
                document.getElementById('editCondition').value = task.condition || '';
                document.getElementById('editCodes').value = formatCodesForInput(task.codes);
                document.getElementById('editAnswer').value = task.answer || '';
                document.getElementById('editSolution').value = task.solution || '';
                document.getElementById('editVideo').value = task.video || '';
                document.getElementById('editSolved').checked = task.solved || false;
                document.getElementById('editFavorite').checked = task.favorite || false;
                document.getElementById('editHomework').checked = task.homework || false;
            }
        }

        function showTaskList() {
            leftPanel.classList.remove('wide');
            leftPanel.classList.add('narrow');
            taskListContainer.style.display = 'block';
            editPanelContainer.style.display = 'none';
            leftPanelTitle.innerText = 'üìã –ó–∞–¥–∞—á–∏';
            backToListBtn.style.display = 'none';
        }

        function saveEditedTask() {
            const id = parseInt(document.getElementById('editId').value) || 0;
            const name = document.getElementById('editName').value.trim();
            const condition = document.getElementById('editCondition').value.trim();
            const codesStr = document.getElementById('editCodes').value;
            const answer = document.getElementById('editAnswer').value.trim();
            const solution = document.getElementById('editSolution').value;
            const video = document.getElementById('editVideo').value.trim();
            const solved = document.getElementById('editSolved').checked;
            const favorite = document.getElementById('editFavorite').checked;
            const homework = document.getElementById('editHomework').checked;

            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
            const codes = parseCodes(codesStr);
            if (Object.keys(codes).length === 0) { alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–¥'); return; }

            if (id && tasks.some(t => t.id === id)) {
                const task = tasks.find(t => t.id === id);
                Object.assign(task, { name, condition, codes, answer, solution, video, solved, favorite, homework });
            } else {
                const newId = Math.max(...tasks.map(t => t.id), 0) + 1;
                tasks.push({ id: newId, name, condition, codes, answer, solution, video, solved, favorite, homework });
            }
            renderTaskList();
            showTaskList();
        }

        function deleteEditedTask() {
            const id = parseInt(document.getElementById('editId').value);
            if (!id) return;
            tasks = tasks.filter(t => t.id !== id);
            if (currentTaskId === id) currentTaskId = tasks[0]?.id;
            renderTaskList();
            showTaskList();
        }

        function newTask() {
            document.getElementById('editId').value = '';
            document.getElementById('editName').value = '';
            document.getElementById('editCondition').value = '';
            document.getElementById('editCodes').value = '–ê=0\n–ë=10\n–í=110';
            document.getElementById('editAnswer').value = '';
            document.getElementById('editSolution').value = '';
            document.getElementById('editVideo').value = '';
            document.getElementById('editSolved').checked = false;
            document.getElementById('editFavorite').checked = false;
            document.getElementById('editHomework').checked = false;
            openEditForTask(null);
        }

        function saveTaskFromTree() { alert('–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); }
        function deleteCurrentTask() {
            if (!currentTaskId) return;
            tasks = tasks.filter(t => t.id !== currentTaskId);
            currentTaskId = tasks[0]?.id;
            if (currentTaskId) loadTask(currentTaskId);
            renderTaskList();
        }

        function parseCodes(input) {
            const codes = {};
            input.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split('=').map(s => s.trim());
                if (parts.length === 2) codes[parts[0]] = parts[1];
            });
            return codes;
        }

        function formatCodesForInput(codes) {
            return Object.entries(codes).map(([k, v]) => `${k}=${v}`).join('\n');
        }

        function exportTasks() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'fano_tasks.json';
            a.click();
        }

        function importTasks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        tasks = JSON.parse(ev.target.result);
                        currentTaskId = tasks[0]?.id;
                        if (currentTaskId) loadTask(currentTaskId);
                        renderTaskList();
                    } catch { alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function printFilteredTasks() {
            alert('–§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å');
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –° GITHUB ==========
        async function loadTasksFromGitHub() {
            try {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–°–´–õ–ö–ê - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —Å–ª—ç—à –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å
                const url = ' https://raw.githubusercontent.com/GannaMath2026/trenager_programs/main/json_files/–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞_4_—Ñ–∞–Ω–æ.json';
               
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (!Array.isArray(data)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                
                tasks = data;
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${tasks.length} –∑–∞–¥–∞—á —Å GitHub`);
                
                if (tasks.length > 0) {
                    currentTaskId = tasks[0].id;
                    loadTask(currentTaskId);
                }
                
                renderTaskList();
                alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${tasks.length} –∑–∞–¥–∞—á`);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏ —Å GitHub. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–∑–∞–¥–∞—á–∏.');
                
                // –î–µ–º–æ-–∑–∞–¥–∞—á–∏ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                tasks = [
                    { id: 1, name: "–î–ï–ú–û 2024", condition: "–î–ª—è –±—É–∫–≤ –ê, –ë, –í, –ì, –î, –ï –∏–∑–≤–µ—Å—Ç–Ω—ã –∫–æ–¥—ã: –ê=000, –ë=001, –í=0101, –ì=0100, –î=011, –ï=101.", codes: { "–ê": "000", "–ë": "001", "–í": "0101", "–ì": "0100", "–î": "011", "–ï": "101" }, answer: "011", solution: "–î–µ—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ.", video: "", solved: false, favorite: false, homework: false },
                    { id: 2, name: "–í–∞—Ä–∏–∞–Ω—Ç 303", condition: "–î–ª—è –±—É–∫–≤ –ê, –ë, –í, –ì –∑–∞–¥–∞–Ω—ã –∫–æ–¥—ã: –ê=00, –ë=01, –í=100, –ì=101.", codes: { "–ê": "00", "–ë": "01", "–í": "100", "–ì": "101" }, answer: "110", solution: "–û–±—Ä–∞—Ç–Ω–æ–µ –¥–µ—Ä–µ–≤–æ", video: "", solved: true, favorite: true, homework: true }
                ];
                currentTaskId = 1;
                loadTask(1);
                renderTaskList();
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ —Å GitHub –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            loadTasksFromGitHub();
            
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', endDrag);
            canvas.addEventListener('mouseleave', endDrag);
        }

        window.onload = init;
    </script>
</body>
</html>